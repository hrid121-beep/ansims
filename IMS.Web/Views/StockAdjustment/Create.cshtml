@model IMS.Application.DTOs.StockAdjustmentDto
@{
    ViewData["Title"] = "Create Stock Adjustment";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-plus-circle text-primary"></i> New Stock Adjustment
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Adjustments</a></li>
                    <li class="breadcrumb-item active">New Adjustment</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <i class="icon fas fa-check"></i> @TempData["Success"]
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <i class="icon fas fa-ban"></i> @TempData["Error"]
            </div>
        }

        <form asp-action="Create" method="post">
            <div class="row">
                <div class="col-md-8">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-info-circle"></i> Adjustment Information</h3>
                        </div>
                        <div class="card-body">
                            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                            <!-- Guidance Alert -->
                            <div class="alert alert-success alert-dismissible" style="background-color: #28a745; color: white; border-color: #28a745;">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true" style="color: white;">&times;</button>
                                <h5><i class="fas fa-info-circle"></i> Smart Stock Adjustment (Single Item)</h5>
                                <p class="mb-0">
                                    This module handles <strong>single-item adjustments</strong> intelligently:
                                    <br><br>
                                    ‚úÖ <strong>Count Corrections</strong> ‚Üí Simple adjustment (no write-off)
                                    <br>
                                    ‚ö†Ô∏è <strong>Damage/Loss/Expiry</strong> ‚Üí Auto-creates write-off with approval workflow
                                    <br><br>
                                    <strong>Need to write-off multiple items?</strong> Use
                                    <a href="@Url.Action("Create", "WriteOff")" style="color: #ffeb3b; text-decoration: underline;"><strong>Bulk Write-off</strong></a> instead.
                                </p>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AdjustmentNo">Adjustment Number <span class="text-danger">*</span></label>
                                        <input asp-for="AdjustmentNo" class="form-control" readonly value="@ViewBag.AdjustmentNo">
                                        <small class="form-text text-muted">Auto-generated adjustment number</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AdjustmentDate">Adjustment Date <span class="text-danger">*</span></label>
                                        <input asp-for="AdjustmentDate" type="date" class="form-control" required />
                                        <span asp-validation-for="AdjustmentDate" class="text-danger"></span>
                                        <small class="form-text text-muted">Date of adjustment</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="StoreId">Store <span class="text-danger">*</span></label>
                                        <select asp-for="StoreId" asp-items="ViewBag.Stores" class="form-control select2" required>
                                            <option value="">-- Select Store --</option>
                                        </select>
                                        <span asp-validation-for="StoreId" class="text-danger"></span>
                                        <small class="form-text text-muted">Select store location</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="ItemId">Item <span class="text-danger">*</span></label>
                                        <select asp-for="ItemId" asp-items="ViewBag.Items" class="form-control select2" required>
                                            <option value="">-- Select Item --</option>
                                        </select>
                                        <span asp-validation-for="ItemId" class="text-danger"></span>
                                        <small class="form-text text-muted">Select item to adjust</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Stock Info -->
                            <div id="stockInfo" class="callout callout-info" style="display:none;">
                                <h5><i class="fas fa-box"></i> Current Stock Information</h5>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Item Code:</strong> <span id="itemCode" class="text-dark">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Current Quantity:</strong> <span id="currentQty" class="text-dark">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Unit:</strong> <span id="unit" class="text-dark">-</span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <strong>Minimum Stock:</strong> <span id="minStock" class="text-dark">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Last Updated:</strong> <span id="lastUpdated" class="text-dark">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Status:</strong> <span id="status" class="text-dark">-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Current Quantity</label>
                                        <input type="number" id="OldQuantity" asp-for="OldQuantity" class="form-control" readonly>
                                        <small class="form-text text-muted">System quantity</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="NewQuantity">New Quantity <span class="text-danger">*</span></label>
                                        <input asp-for="NewQuantity" type="number" step="0.01" min="0" class="form-control" required>
                                        <span asp-validation-for="NewQuantity" class="text-danger"></span>
                                        <small class="form-text text-muted">Actual quantity</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Adjustment Preview -->
                            <div id="adjustmentPreview" class="callout callout-warning" style="display:none;">
                                <h5><i class="fas fa-calculator"></i> Adjustment Preview</h5>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Adjustment Type:</strong> <span id="adjType" class="font-weight-bold">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Adjustment Quantity:</strong> <span id="adjQty" class="font-weight-bold">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Percentage Change:</strong> <span id="adjPercent" class="font-weight-bold">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Smart WriteOff Alert -->
                            <div id="writeOffAlert" class="alert alert-warning" style="display:none;">
                                <h5><i class="fas fa-exclamation-triangle"></i> WriteOff Will Be Auto-Created</h5>
                                <p class="mb-0">
                                    This adjustment reason (<strong id="writeOffReason"></strong>) will automatically create a WriteOff request.
                                    <span id="approvalRequired" style="display:none;">
                                        <br><strong>Approval required</strong> - Value exceeds ‚Çπ10,000 threshold.
                                    </span>
                                </p>
                            </div>

                            <div class="form-group">
                                <label>Reason Category <span class="text-danger">*</span></label>
                                <select id="reasonCategorySelect" class="form-control">
                                    <option value="">-- Select Category --</option>
                                    <optgroup label="üìã Count Corrections (No WriteOff)">
                                        <option value="Physical Count Mismatch">Physical Count Mismatch</option>
                                        <option value="Data Entry Error">Data Entry Error</option>
                                        <option value="System Reconciliation">System Reconciliation</option>
                                        <option value="Found Items">Found Items</option>
                                    </optgroup>
                                    <optgroup label="‚ö†Ô∏è Damage & Loss (Auto WriteOff)">
                                        <option value="Damaged" class="text-danger">Damaged</option>
                                        <option value="Expired" class="text-danger">Expired</option>
                                        <option value="Lost" class="text-danger">Lost</option>
                                        <option value="Stolen" class="text-danger">Stolen / Theft</option>
                                        <option value="Obsolete" class="text-danger">Obsolete</option>
                                        <option value="Quality Issues" class="text-danger">Quality Issues</option>
                                        <option value="Fire Damage" class="text-danger">Fire Damage</option>
                                        <option value="Water Damage" class="text-danger">Water Damage</option>
                                        <option value="Natural Disaster" class="text-danger">Natural Disaster</option>
                                    </optgroup>
                                    <optgroup label="Other">
                                        <option value="Other">Other (Specify Below)</option>
                                    </optgroup>
                                </select>
                                <input asp-for="Reason" type="text" class="form-control mt-2"
                                       placeholder="Details or custom reason..." required>
                                <span asp-validation-for="Reason" class="text-danger"></span>
                                <small class="form-text text-muted">
                                    <i class="fas fa-lightbulb"></i>
                                    Select category, then provide details. Categories marked in <span class="text-danger">red</span> will auto-create WriteOff.
                                </small>
                            </div>

                            <div class="form-group">
                                <label>Reference Document</label>
                                <input asp-for="ReferenceDocument" class="form-control"
                                       placeholder="e.g., Physical count sheet #123, Memo #456">
                                <small class="form-text text-muted">Optional supporting document reference</small>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save"></i> Create Adjustment
                            </button>
                            <a asp-action="Index" class="btn btn-default">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Guidelines -->
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-info-circle"></i> Guidelines</h3>
                        </div>
                        <div class="card-body">
                            <h6><i class="fas fa-info-circle"></i> Single Item Adjustment:</h6>
                            <ul class="small">
                                <li><strong>Count Corrections</strong> - Physical vs system mismatches</li>
                                <li><strong>Damage & Loss</strong> - Auto-creates WriteOff with approval</li>
                                <li><strong>Other</strong> - Custom reasons</li>
                            </ul>

                            <hr>

                            <h6><i class="fas fa-bell"></i> Auto WriteOff Triggers:</h6>
                            <ul class="small text-danger">
                                <li>Damaged items</li>
                                <li>Expired stock</li>
                                <li>Lost or Stolen</li>
                                <li>Quality issues</li>
                                <li>Natural disasters</li>
                            </ul>

                            <hr>

                            <div class="alert alert-warning mb-2">
                                <i class="fas fa-lightbulb"></i>
                                <strong>Smart Detection:</strong><br>
                                Damage/loss reasons auto-create WriteOff.
                                Values ‚â•‚Çπ10,000 require approval.
                            </div>

                            <div class="alert alert-info mb-0">
                                <i class="fas fa-layer-group"></i>
                                <strong>Multiple Items?</strong><br>
                                Use <a href="@Url.Action("Create", "WriteOff")" class="alert-link">Bulk Write-off</a> to write-off multiple items at once.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize select2
            $('.select2').select2({
                theme: 'bootstrap4',
                width: '100%'
            });

            // Set default date to today
            var today = new Date().toISOString().split('T')[0];
            $('input[name="AdjustmentDate"]').val(today);

            // Disable item dropdown initially until store is selected
            $('#ItemId').prop('disabled', true);
            $('#ItemId').empty().append('<option value="">-- Select Store First --</option>');

            // üéØ Smart WriteOff Detection - Reason Category Change
            var WRITEOFF_REASONS = ['Damaged', 'Expired', 'Lost', 'Stolen', 'Obsolete',
                                   'Quality Issues', 'Fire Damage', 'Water Damage', 'Natural Disaster'];

            $('#reasonCategorySelect').change(function() {
                var selectedReason = $(this).val();

                if (selectedReason && selectedReason !== 'Other') {
                    $('#Reason').val(selectedReason);
                    checkWriteOffTrigger(selectedReason);
                } else {
                    $('#Reason').val('');
                    $('#writeOffAlert').hide();
                }
            });

            // Check if reason will trigger WriteOff
            function checkWriteOffTrigger(reason) {
                var isWriteOffReason = WRITEOFF_REASONS.some(function(r) {
                    return reason.indexOf(r) !== -1;
                });

                if (isWriteOffReason && $('#adjType').text() === 'Decrease') {
                    $('#writeOffAlert').show();
                    $('#writeOffReason').text(reason);

                    // Check if value exceeds threshold
                    var oldQty = parseFloat($('#OldQuantity').val()) || 0;
                    var newQty = parseFloat($('#NewQuantity').val()) || 0;
                    var adjQty = Math.abs(newQty - oldQty);
                    var unitPrice = parseFloat($('#ItemId').find('option:selected').data('price')) || 0;
                    var totalValue = adjQty * unitPrice;

                    if (totalValue >= 10000) {
                        $('#approvalRequired').show();
                    } else {
                        $('#approvalRequired').hide();
                    }
                } else {
                    $('#writeOffAlert').hide();
                }
            }

            // Legacy reason select (keep for backwards compatibility)
            $('#reasonSelect').change(function() {
                var selectedReason = $(this).val();
                if (selectedReason && selectedReason !== 'Other') {
                    $('#Reason').val(selectedReason);
                }
            });

            // Load items when store is selected
            $('#StoreId').change(function() {
                var storeId = $(this).val();
                var itemSelect = $('#ItemId');

                if (storeId) {
                    // Show loading state
                    itemSelect.prop('disabled', true);
                    itemSelect.empty().append('<option value="">Loading items...</option>');

                    $.ajax({
                        url: '@Url.Action("GetItemsByStore")',
                        data: { storeId: storeId },
                        success: function(data) {
                            itemSelect.empty();
                            itemSelect.append('<option value="">-- Select Item --</option>');

                            if (data && data.length > 0) {
                                $.each(data, function(index, item) {
                                    itemSelect.append($('<option></option>')
                                        .attr('value', item.id || item.Id)
                                        .text((item.itemCode || item.ItemCode) + ' - ' + (item.name || item.Name)));
                                });
                                itemSelect.prop('disabled', false);
                            } else {
                                itemSelect.append('<option value="">No items available in this store</option>');
                                itemSelect.prop('disabled', true);
                            }

                            // Reinitialize select2
                            itemSelect.select2({
                                theme: 'bootstrap4',
                                width: '100%'
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error loading items:', error);
                            itemSelect.empty().append('<option value="">Error loading items</option>');
                            itemSelect.prop('disabled', true);
                            alert('Failed to load items for this store. Please try again.');
                        }
                    });
                } else {
                    // Reset item dropdown if no store selected
                    itemSelect.empty().append('<option value="">-- Select Store First --</option>');
                    itemSelect.prop('disabled', true);
                    $('#stockInfo').slideUp();
                    $('#adjustmentPreview').slideUp();
                }
            });

            // Load stock info when both store and item are selected
            function loadStockInfo() {
                var itemId = $('#ItemId').val();
                var storeId = $('#StoreId').val();

                if (itemId && storeId) {
                    $.ajax({
                        url: '@Url.Action("GetCurrentStock")',
                        data: { itemId: itemId, storeId: storeId },
                        success: function(data) {
                            $('#itemCode').text(data.itemCode || '-');
                            $('#currentQty').text(data.currentQuantity.toFixed(2));
                            $('#unit').text(data.unit || '-');
                            $('#minStock').text(data.minimumStock.toFixed(2));
                            $('#lastUpdated').text(new Date(data.lastUpdated).toLocaleDateString());
                            $('#status').text(data.status);

                            $('#OldQuantity').val(data.currentQuantity);
                            $('#stockInfo').slideDown();

                            // Update adjustment preview
                            updateAdjustmentPreview();
                        },
                        error: function(xhr, status, error) {
                            console.error('Error loading stock info:', error);
                            alert('Failed to load stock information. Please try again.');
                        }
                    });
                } else {
                    $('#stockInfo').slideUp();
                    $('#adjustmentPreview').slideUp();
                }
            }

            $('#ItemId, #StoreId').change(loadStockInfo);

            // Update adjustment preview
            function updateAdjustmentPreview() {
                var oldQty = parseFloat($('#OldQuantity').val()) || 0;
                var newQty = parseFloat($('#NewQuantity').val()) || 0;

                if (oldQty > 0 && newQty >= 0) {
                    var diff = newQty - oldQty;
                    var percentage = ((diff / oldQty) * 100).toFixed(2);
                    var type = diff >= 0 ? 'Increase' : 'Decrease';

                    $('#adjType').text(type).removeClass().addClass(diff >= 0 ? 'text-success' : 'text-danger');
                    $('#adjQty').text((diff >= 0 ? '+' : '') + diff.toFixed(2));
                    $('#adjPercent').text((diff >= 0 ? '+' : '') + percentage + '%');

                    $('#adjustmentPreview').slideDown();

                    // Show warning for large adjustments
                    if (Math.abs(percentage) > 20) {
                        $('#adjustmentPreview').removeClass('callout-warning').addClass('callout-danger');
                    } else {
                        $('#adjustmentPreview').removeClass('callout-danger').addClass('callout-warning');
                    }

                    // üéØ Re-check WriteOff trigger when quantity changes
                    var currentReason = $('#reasonCategorySelect').val();
                    if (currentReason) {
                        checkWriteOffTrigger(currentReason);
                    }
                } else {
                    $('#adjustmentPreview').slideUp();
                }
            }

            $('#NewQuantity').on('input', updateAdjustmentPreview);

            // Form validation
            $('form').submit(function(e) {
                var oldQty = parseFloat($('#OldQuantity').val()) || 0;
                var newQty = parseFloat($('#NewQuantity').val()) || 0;

                if (oldQty === newQty) {
                    e.preventDefault();
                    alert('No Change: New quantity is the same as current quantity. No adjustment needed.');
                    return false;
                }

                var diff = Math.abs(((newQty - oldQty) / oldQty) * 100);
                if (diff > 50) {
                    if (!confirm('Large Adjustment: This is a ' + diff.toFixed(0) + '% change. Are you sure this is correct?')) {
                        e.preventDefault();
                        return false;
                    }
                }
            });
        });
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
