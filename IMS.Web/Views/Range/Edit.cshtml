@model IMS.Application.DTOs.RangeDto

@{
    ViewData["Title"] = "Edit Range";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Edit Range</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Ranges</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Success/Error Messages -->
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Update Failed!</strong> @TempData["Error"]
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        }

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i>
                <strong>Success!</strong> @TempData["Success"]
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        }

        <div class="row">
            <div class="col-md-12">
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-edit"></i> Edit Range Information
                        </h3>
                        <div class="card-tools">
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-info btn-sm">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                        </div>
                    </div>
                    <form asp-action="Edit" method="post" id="editRangeForm">
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="Code" />
                        <input type="hidden" asp-for="CreatedAt" />
                        <input type="hidden" asp-for="CreatedBy" />

                        <div class="card-body">
                            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                            <!-- Show what's being edited -->
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>Editing:</strong> @Model.Name (@Model.Code)
                                <span class="float-right text-muted">
                                    <small>Last updated: @(Model.UpdatedAt?.ToString("dd-MMM-yyyy hh:mm tt") ?? "Never")</small>
                                </span>
                            </div>

                            <!-- Basic Information -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="Name" class="control-label">
                                            <i class="fas fa-map-marker-alt text-primary"></i> Range Name *
                                        </label>
                                        <input asp-for="Name" class="form-control" placeholder="Enter range name" />
                                        <span asp-validation-for="Name" class="text-danger"></span>
                                        @if (!string.IsNullOrEmpty(Model.Name))
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-history"></i> Original: @Model.Name
                                            </small>
                                        }
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">
                                            <i class="fas fa-barcode text-info"></i> Range Code
                                        </label>
                                        <div class="input-group">
                                            <input type="text" class="form-control bg-light" value="@Model.Code" readonly disabled />
                                            <div class="input-group-append">
                                                <span class="input-group-text bg-secondary text-white">
                                                    <i class="fas fa-lock"></i>
                                                </span>
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            Code is locked and cannot be changed
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Location Information -->
                            <h5 class="mt-4 mb-3 text-primary">
                                <i class="fas fa-building"></i> Location Details
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="HeadquarterLocation" class="control-label">Headquarter Location</label>
                                        <input asp-for="HeadquarterLocation" class="form-control" placeholder="Enter headquarter location" />
                                        <span asp-validation-for="HeadquarterLocation" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="CoverageArea" class="control-label">Coverage Area</label>
                                        <input asp-for="CoverageArea" class="form-control" placeholder="Enter coverage area" />
                                        <span asp-validation-for="CoverageArea" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Commander Information -->
                            <h5 class="mt-4 mb-3 text-primary">
                                <i class="fas fa-user-tie"></i> Commander Information
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="CommanderName" class="control-label">Commander Name</label>
                                        <input asp-for="CommanderName" class="form-control" placeholder="Enter commander name" />
                                        <span asp-validation-for="CommanderName" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="CommanderRank" class="control-label">Commander Rank</label>
                                        <select asp-for="CommanderRank" class="form-control">
                                            <option value="">Select Rank</option>
                                            <optgroup label="General Officers">
                                                <option value="Brigadier">Brigadier</option>
                                                <option value="Colonel">Colonel</option>
                                            </optgroup>
                                            <optgroup label="Field Officers">
                                                <option value="Lieutenant Colonel">Lieutenant Colonel</option>
                                                <option value="Major">Major</option>
                                            </optgroup>
                                            <optgroup label="Company Officers">
                                                <option value="Captain">Captain</option>
                                                <option value="Lieutenant">Lieutenant</option>
                                                <option value="Second Lieutenant">Second Lieutenant</option>
                                            </optgroup>
                                            <optgroup label="VDP Ranks">
                                                <option value="Commandant">Commandant</option>
                                                <option value="Assistant Commandant">Assistant Commandant</option>
                                                <option value="Instructor">Instructor</option>
                                                <option value="Assistant Instructor">Assistant Instructor</option>
                                            </optgroup>
                                        </select>
                                        <span asp-validation-for="CommanderRank" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="ContactNumber" class="control-label">Contact Number</label>
                                        <input asp-for="ContactNumber" class="form-control" placeholder="Enter contact number" />
                                        <span asp-validation-for="ContactNumber" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact & Status -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="Email" class="control-label">Email Address</label>
                                        <input asp-for="Email" class="form-control" placeholder="Enter email address" />
                                        <span asp-validation-for="Email" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Status</label>
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" asp-for="IsActive" class="custom-control-input" />
                                            <label class="custom-control-label" asp-for="IsActive">
                                                <span class="badge" id="statusBadge">
                                                    @(Model.IsActive ? "Active" : "Inactive")
                                                </span>
                                            </label>
                                        </div>
                                        @if (!Model.IsActive)
                                        {
                                            <small class="text-warning">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                This range is currently inactive
                                            </small>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Remarks -->
                            <div class="form-group">
                                <label asp-for="Remarks" class="control-label">Remarks</label>
                                <textarea asp-for="Remarks" class="form-control" rows="3" placeholder="Enter any remarks"></textarea>
                                <span asp-validation-for="Remarks" class="text-danger"></span>
                            </div>

                            <!-- Audit Information -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <p class="text-muted">
                                        <i class="fas fa-plus-circle"></i>
                                        <strong>Created:</strong> @Model.CreatedAt.ToString("dd-MMM-yyyy hh:mm tt") by @(Model.CreatedByName ?? Model.CreatedBy ?? "System")
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    @if (Model.UpdatedAt.HasValue)
                                    {
                                        <p class="text-muted">
                                            <i class="fas fa-edit"></i>
                                            <strong>Last Updated:</strong> @Model.UpdatedAt.Value.ToString("dd-MMM-yyyy hh:mm tt") by @(Model.UpdatedByName ?? Model.UpdatedBy ?? "System")
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="card-footer">
                            <button type="submit" class="btn btn-warning" id="updateBtn">
                                <i class="fas fa-save"></i> Update Range
                            </button>
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-info">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="button" class="btn btn-success" id="previewChangesBtn">
                                <i class="fas fa-search"></i> Preview Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            // Store original values for change detection
            var originalValues = {
                name: $('#Name').val(),
                code: $('#Code').val(),
                commander: $('#CommanderName').val(),
                rank: $('#CommanderRank').val(),
                location: $('#HeadquarterLocation').val(),
                coverage: $('#CoverageArea').val(),
                email: $('#Email').val(),
                contact: $('#ContactNumber').val(),
                isActive: $('#IsActive').is(':checked'),
                remarks: $('#Remarks').val()
            };

            // Status switch handler
            $('#IsActive').change(function() {
                updateStatusBadge();
            });

            function updateStatusBadge() {
                if ($('#IsActive').is(':checked')) {
                    $('#statusBadge').removeClass('badge-danger').addClass('badge-success').text('Active');
                } else {
                    $('#statusBadge').removeClass('badge-success').addClass('badge-danger').text('Inactive');
                }
            }

            // Initialize status badge
            updateStatusBadge();

            // Preview changes button
            $('#previewChangesBtn').click(function() {
                var changes = detectChanges();
                showPreviewModal(changes);
            });

            // Form submission handler
            $('#editRangeForm').on('submit', function(e) {
                e.preventDefault();

                // Check client-side validation first
                if (!$(this).valid()) {
                    return false;
                }

                // Check for changes
                var changes = detectChanges();
                if (changes.length === 0) {
                    Swal.fire({
                        title: 'No Changes Detected',
                        text: 'You haven\'t made any changes to update.',
                        icon: 'info',
                        confirmButtonText: 'OK'
                    });
                    return false;
                }

                // Show loading state
                $('#updateBtn').html('<i class="fas fa-spinner fa-spin"></i> Updating...').prop('disabled', true);

                // Submit form
                this.submit();
            });

            // Function to detect changes
            function detectChanges() {
                var changes = [];

                if ($('#Name').val() !== originalValues.name) changes.push('Range Name');
                // Code field is readonly, no need to check for changes
                if ($('#CommanderName').val() !== originalValues.commander) changes.push('Commander Name');
                if ($('#CommanderRank').val() !== originalValues.rank) changes.push('Commander Rank');
                if ($('#HeadquarterLocation').val() !== originalValues.location) changes.push('Headquarter Location');
                if ($('#CoverageArea').val() !== originalValues.coverage) changes.push('Coverage Area');
                if ($('#Email').val() !== originalValues.email) changes.push('Email');
                if ($('#ContactNumber').val() !== originalValues.contact) changes.push('Contact Number');
                if ($('#IsActive').is(':checked') !== originalValues.isActive) changes.push('Status');
                if ($('#Remarks').val() !== originalValues.remarks) changes.push('Remarks');

                return changes;
            }

            // Function to show preview modal
            function showPreviewModal(changes) {
                if (changes.length === 0) {
                    Swal.fire({
                        title: 'No Changes',
                        text: 'You haven\'t made any changes to preview.',
                        icon: 'info'
                    });
                    return;
                }

                var changesList = changes.map(change => `<li>${change}</li>`).join('');
                var html = `
                    <div class="text-left">
                        <h6>The following fields will be updated:</h6>
                        <ul>${changesList}</ul>
                        <hr>
                        <p class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Review your changes above, then click "Save Changes" to update the range.
                        </p>
                    </div>
                `;

                Swal.fire({
                    title: 'Preview Changes',
                    html: html,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Save Changes',
                    cancelButtonText: 'Continue Editing',
                    confirmButtonColor: '#28a745'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#editRangeForm').submit();
                    }
                });
            }

            // Helper functions
            function showFieldError(fieldName, message) {
                var field = $('#' + fieldName);
                var errorSpan = field.next('.text-danger');
                if (errorSpan.length === 0) {
                    field.after('<span class="text-danger">' + message + '</span>');
                } else {
                    errorSpan.text(message);
                }
            }

            function hideFieldError(fieldName) {
                $('#' + fieldName).next('.text-danger').text('');
            }

            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                $('.alert').fadeOut('slow');
            }, 5000);

            // Highlight changed fields
            $('input, select, textarea').on('input change', function() {
                var fieldName = $(this).attr('id');
                if (fieldName && originalValues.hasOwnProperty(fieldName.toLowerCase())) {
                    var originalValue = originalValues[fieldName.toLowerCase()];
                    var currentValue = $(this).is(':checkbox') ? $(this).is(':checked') : $(this).val();

                    if (currentValue !== originalValue) {
                        $(this).addClass('border-warning');
                    } else {
                        $(this).removeClass('border-warning');
                    }
                }
            });
        });
    </script>
}