@using IMS.Application.DTOs
@model VarianceAnalysisDto
@{
    ViewData["Title"] = "Variance Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var inventory = ViewBag.Inventory as PhysicalInventoryDto;

    // Calculate counts from the list
    var itemsWithVarianceCount = Model.ItemsWithVariance?.Count ?? 0;
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    পার্থক্য প্রতিবেদন / Variance Report
                    <small class="text-muted">@inventory?.ReferenceNumber</small>
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Physical Inventory</a></li>
                    <li class="breadcrumb-item active">Variance Report</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <!-- Report Header -->
        <div class="invoice p-3 mb-3">
            <div class="row">
                <div class="col-12">
                    <h4>
                        <img src="~/images/logo.png" alt="Logo" style="height: 40px;">
                        Bangladesh Ansar & VDP
                        <small class="float-right">Date: @DateTime.Now.ToString("dd/MM/yyyy")</small>
                    </h4>
                </div>
            </div>

            <div class="row invoice-info">
                <div class="col-sm-4 invoice-col">
                    <address>
                        <strong>Store Information:</strong><br>
                        @inventory?.StoreName<br>
                        @inventory?.ZilaName, @inventory?.UpazilaName<br>
                        Count Date: @inventory?.CountDate.ToString("dd MMM yyyy")
                    </address>
                </div>
                <div class="col-sm-4 invoice-col">
                    <address>
                        <strong>Reference Details:</strong><br>
                        Reference #: @inventory?.ReferenceNumber<br>
                        Fiscal Year: @inventory?.FiscalYear<br>
                        Count Type: @inventory?.CountType
                    </address>
                </div>
                <div class="col-sm-4 invoice-col">
                    <b>Report #:</b> VAR-@Model.ReferenceNumber<br>
                    <b>Generated:</b> @DateTime.Now.ToString("dd MMM yyyy HH:mm")<br>
                    <b>Status:</b> @inventory?.StatusText
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="callout callout-info">
                        <h5>@Model.TotalItems</h5>
                        <p>Total Items Counted</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="callout callout-warning">
                        <h5>@itemsWithVarianceCount</h5>  @* Fixed: Use count variable *@
                        <p>Items with Variance</p>
                        <small>
                            @if (Model.TotalItems > 0)
                            {
                                @((itemsWithVarianceCount * 100.0 / Model.TotalItems).ToString("F1"))
                            
                                <text>% of total</text>
                            }
                        </small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="callout callout-success">
                        <h5>+@Model.TotalPositiveVariance</h5>
                        <p>Total Excess</p>
                        <small>@Model.ItemsWithPositiveVariance items</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="callout callout-danger">
                        <h5>-@Model.TotalNegativeVariance</h5>
                        <p>Total Shortage</p>
                        <small>@Model.ItemsWithNegativeVariance items</small>
                    </div>
                </div>
            </div>

            <!-- Financial Impact -->
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-warning">
                        <h5><i class="icon fas fa-money-bill"></i> Financial Impact</h5>
                        Total Variance Value:
                        <strong class="@(Model.TotalVarianceValue >= 0 ? "text-success" : "text-danger")">
                            ৳ @Model.TotalVarianceValue.ToString("N2")
                        </strong>
                    </div>
                </div>
            </div>

            <!-- Variance by Category -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Variance by Category</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Variance Distribution</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="varianceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Variance Table -->
            <div class="row">
                <div class="col-12">
                    <h5 class="mb-3">Detailed Variance List</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Item Code</th>
                                    <th>Item Name</th>
                                    <th>System Qty</th>
                                    <th>Physical Qty</th>
                                    <th>Variance</th>
                                    <th>Variance %</th>
                                    <th>Value (৳)</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.VarianceDetails != null && Model.VarianceDetails.Any())
                                {
                                    var index = 1;
                                    foreach (var item in Model.VarianceDetails.OrderByDescending(v => Math.Abs(v.VarianceValue)))
                                    {
                                        <tr class="@(Math.Abs(item.VariancePercentage) > 10 ? "table-danger" : Math.Abs(item.VariancePercentage) > 5 ? "table-warning" : "")">
                                            <td>@index</td>
                                            <td><code>@item.ItemCode</code></td>
                                            <td>@item.ItemName</td>
                                            <td>@item.SystemQuantity</td>
                                            <td>@item.PhysicalQuantity</td>
                                            <td>
                                                <span class="@(item.Variance > 0 ? "text-success" : "text-danger")">
                                                    @item.Variance.ToString("+#;-#;0")
                                                </span>
                                            </td>
                                            <td>
                                                @if (Math.Abs(item.VariancePercentage) > 10)
                                                {
                                                    <span class="badge badge-danger">@item.VariancePercentage.ToString("F1")%</span>
                                                }
                                                else if (Math.Abs(item.VariancePercentage) > 5)
                                                {
                                                    <span class="badge badge-warning">@item.VariancePercentage.ToString("F1")%</span>
                                                }
                                                else
                                                {
                                                    <span>@item.VariancePercentage.ToString("F1")%</span>
                                                }
                                            </td>
                                            <td>৳ @item.VarianceValue.ToString("N2")</td>
                                            <td>@item.Remarks</td>
                                        </tr>
                                        index++;
                                    }
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="5">Total</th>
                                    <th>
                                        Net: @((Model.TotalPositiveVariance - Model.TotalNegativeVariance).ToString("+#;-#;0"))
                                    </th>
                                    <th></th>
                                    <th>৳ @Model.TotalVarianceValue.ToString("N2")</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card card-outline card-danger">
                        <div class="card-header">
                            <h3 class="card-title">সুপারিশ / Recommendations</h3>
                        </div>
                        <div class="card-body">
                            <ul>
                                @if (itemsWithVarianceCount > Model.TotalItems * 0.2)  @* Fixed: Use count variable *@
                                {
                                    <li>High variance rate detected (@((itemsWithVarianceCount * 100.0 / Model.TotalItems).ToString("F1"))% of items). Consider reviewing counting procedures.</li>
                                }
                                @if (Math.Abs(Model.TotalVarianceValue) > 100000)
                                {
                                    <li>Significant financial variance detected (৳ @Math.Abs(Model.TotalVarianceValue).ToString("N2")). Immediate investigation recommended.</li>
                                }
                                @if (Model.VarianceDetails != null)
                                {
                                    foreach (var item in Model.VarianceDetails.Where(v => Math.Abs(v.VariancePercentage) > 10))
                                    {
                                        <li>Item @item.ItemCode (@item.ItemName) has @item.VariancePercentage.ToString("F1")% variance - requires investigation.</li>
                                    }
                                }
                            </ul>
                            @if (!itemsWithVarianceCount.Equals(0) && itemsWithVarianceCount == 0)
                            {
                                <p class="text-success"><i class="fas fa-check-circle"></i> No significant variances detected. Count appears accurate.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signatures -->
            <div class="row mt-5 d-print-block">
                <div class="col-md-4 text-center">
                    <hr style="border-top: 1px solid #000; width: 200px;">
                    <p>Counted By<br>তারিখ/Date: ___________</p>
                </div>
                <div class="col-md-4 text-center">
                    <hr style="border-top: 1px solid #000; width: 200px;">
                    <p>Verified By<br>তারিখ/Date: ___________</p>
                </div>
                <div class="col-md-4 text-center">
                    <hr style="border-top: 1px solid #000; width: 200px;">
                    <p>Approved By<br>তারিখ/Date: ___________</p>
                </div>
            </div>
        </div>

        <!-- Print Button -->
        <div class="no-print mt-3">
            <button class="btn btn-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Print Report
            </button>
            <a asp-action="Details" asp-route-id="@inventory?.Id" class="btn btn-default">
                Back to Details
            </a>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/adminlte/plugins/chart.js/Chart.min.js"></script>
    <script>
        @if (Model.VarianceDetails != null && Model.VarianceDetails.Any())
        {
                <text>
                // Category Chart
                var categoryData = @Html.Raw(Json.Serialize(Model.VarianceDetails.GroupBy(v => v.CategoryName ?? "Uncategorized")
                                                .Select(g => new { category = g.Key, value = g.Sum(x => Math.Abs(x.Variance)) })));

        var ctx1 = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: categoryData.map(d => d.category),
                datasets: [{
                    label: 'Variance by Category',
                    data: categoryData.map(d => d.value),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

                // Variance Distribution Chart
                var itemsWithoutVariance = @(Model.TotalItems - itemsWithVarianceCount);
                var ctx2 = document.getElementById('varianceChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: ['No Variance', 'Positive Variance', 'Negative Variance'],
                        datasets: [{
                            data: [
                                itemsWithoutVariance,
                                @Model.ItemsWithPositiveVariance,
                                @Model.ItemsWithNegativeVariance
                            ],
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(255, 99, 132, 0.5)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                </text>
        }
    </script>
}

@section Styles {
    <style>
        @@media print {
            .no-print {
                display: none !important;
            }

            .main-header, .main-sidebar {
                display: none !important;
            }

            .content-wrapper {
                margin-left: 0 !important;
            }

            .invoice {
                border: none !important;
            }
        }

        .invoice {
            background: white;
        }

        canvas {
            max-height: 300px;
        }
    </style>
}