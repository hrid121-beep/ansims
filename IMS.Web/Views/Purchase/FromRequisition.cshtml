@model IEnumerable<IMS.Application.DTOs.RequisitionDto>
@{
    ViewData["Title"] = "Create Purchase from Requisition";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Create Purchase from Requisition</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index" asp-controller="Home">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Purchases</a></li>
                    <li class="breadcrumb-item active">From Requisition</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <!-- Info Card -->
        <div class="callout callout-info">
            <h5><i class="fas fa-info-circle"></i> Convert Requisitions to Purchase Orders</h5>
            <p>Select approved requisitions below to convert them into purchase orders. This will automatically populate items and quantities from the requisition.</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-clipboard-list"></i> Approved Requisitions
                </h3>
                <div class="card-tools">
                    <a asp-action="Create" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Create Manual Purchase Order
                    </a>
                </div>
            </div>
            <div class="card-body">
                @if (!Model.Any())
                {
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                        <h5>No Approved Requisitions Available</h5>
                        <p class="text-muted">There are no approved requisitions ready to be converted to purchase orders.</p>
                        <a asp-action="Create" class="btn btn-primary mt-3">
                            <i class="fas fa-plus"></i> Create Manual Purchase Order
                        </a>
                    </div>
                }
                else
                {
                    <table class="table table-bordered table-striped" id="requisitionTable">
                        <thead>
                            <tr>
                                <th>Requisition No</th>
                                <th>Request Date</th>
                                <th>Required By</th>
                                <th>Department</th>
                                <th>Priority</th>
                                <th>Items</th>
                                <th>Estimated Value</th>
                                <th>Status</th>
                                <th width="200">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var requisition in Model)
                            {
                                <tr>
                                    <td>
                                        <strong>@requisition.RequisitionNumber</strong>
                                    </td>
                                    <td>@requisition.RequestDate.ToString("dd/MM/yyyy")</td>
                                    <td>@requisition.RequiredByDate.ToString("dd/MM/yyyy")</td>
                                    <td>@(string.IsNullOrEmpty(requisition.Department) ? "-" : requisition.Department)</td>
                                    <td>
                                        @{
                                            var priority = string.IsNullOrEmpty(requisition.Priority) ? "Normal" : requisition.Priority;
                                        }
                                        @switch (priority)
                                        {
                                            case "High":
                                            case "Urgent":
                                                <span class="badge badge-danger">@priority</span>
                                                break;
                                            case "Medium":
                                            case "Normal":
                                                <span class="badge badge-warning">@priority</span>
                                                break;
                                            case "Low":
                                                <span class="badge badge-info">@priority</span>
                                                break;
                                            default:
                                                <span class="badge badge-secondary">@priority</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <span class="badge badge-primary">@(requisition.Items?.Count ?? 0) items</span>
                                    </td>
                                    <td class="text-right">
                                        <strong>৳@requisition.EstimatedValue.ToString("N2")</strong>
                                    </td>
                                    <td>
                                        <span class="badge badge-success">@requisition.Status</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-info"
                                                onclick="viewRequisitionDetails(@requisition.Id)"
                                                data-toggle="modal" data-target="#requisitionModal">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success"
                                                onclick="convertToPurchase(@requisition.Id, '@requisition.RequisitionNumber')">
                                            <i class="fas fa-exchange-alt"></i> Convert
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>

<!-- Requisition Details Modal -->
<div class="modal fade" id="requisitionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-list"></i> Requisition Details
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="requisitionDetails">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="convertFromModal" style="display:none;">
                    <i class="fas fa-exchange-alt"></i> Convert to Purchase Order
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentRequisitionId = null;

        $(document).ready(function() {
            $('#requisitionTable').DataTable({
                "responsive": true,
                "autoWidth": false,
                "order": [[1, "desc"]], // Sort by request date
                "pageLength": 10,
                "language": {
                    "search": "Search requisitions:",
                    "emptyTable": "No approved requisitions available"
                }
            });
        });

        function viewRequisitionDetails(id) {
            currentRequisitionId = id;
            $('#requisitionDetails').html(`
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading details...</p>
                </div>
            `);

            // Load requisition details via AJAX
            $.get('/Requisition/GetDetails/' + id, function(data) {
                let html = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Requisition No:</strong> ${data.requisitionNumber}<br>
                            <strong>Department:</strong> ${data.department}<br>
                            <strong>Request Date:</strong> ${new Date(data.requestDate).toLocaleDateString()}<br>
                            <strong>Required By:</strong> ${new Date(data.requiredByDate).toLocaleDateString()}
                        </div>
                        <div class="col-md-6">
                            <strong>Priority:</strong> <span class="badge badge-${getPriorityClass(data.priority)}">${data.priority}</span><br>
                            <strong>Status:</strong> <span class="badge badge-success">${data.status}</span><br>
                            <strong>Requested By:</strong> ${data.requestedBy}<br>
                            <strong>Total Value:</strong> <strong>৳${data.estimatedValue.toFixed(2)}</strong>
                        </div>
                    </div>

                    <hr>

                    <h6><strong>Requisition Items:</strong></h6>
                    <table class="table table-sm table-bordered">
                        <thead class="bg-light">
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>`;

                data.items.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.itemName}</td>
                            <td class="text-center">${item.requestedQuantity}</td>
                            <td>${item.unit || 'Pcs'}</td>
                            <td class="text-right">৳${item.unitPrice.toFixed(2)}</td>
                            <td class="text-right">৳${item.totalPrice.toFixed(2)}</td>
                        </tr>`;
                });

                html += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="4" class="text-right">Total:</th>
                                <th class="text-right">৳${data.estimatedValue.toFixed(2)}</th>
                            </tr>
                        </tfoot>
                    </table>`;

                if (data.remarks) {
                    html += `
                        <hr>
                        <p><strong>Remarks:</strong> ${data.remarks}</p>`;
                }

                $('#requisitionDetails').html(html);
                $('#convertFromModal').show().off('click').on('click', function() {
                    $('#requisitionModal').modal('hide');
                    convertToPurchase(data.id, data.requisitionNumber);
                });
            }).fail(function() {
                $('#requisitionDetails').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load requisition details. Please try again.
                    </div>
                `);
            });
        }

        function convertToPurchase(id, requisitionNo) {
            Swal.fire({
                title: 'Convert to Purchase Order?',
                html: `
                    <p>Convert requisition <strong>${requisitionNo}</strong> to a purchase order?</p>
                    <p class="text-muted">This will create a new purchase order with all items from the requisition.</p>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Convert',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    Swal.fire({
                        title: 'Converting...',
                        text: 'Creating purchase order from requisition',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        willOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Convert requisition to purchase order
                    $.post('/Purchase/ConvertFromRequisition', { requisitionId: id }, function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success!',
                                text: 'Purchase order created successfully',
                                confirmButtonText: 'View Purchase Order'
                            }).then(() => {
                                window.location.href = '/Purchase/Edit/' + response.purchaseId;
                            });
                        } else {
                            Swal.fire('Error!', response.message || 'Failed to create purchase order', 'error');
                        }
                    }).fail(function() {
                        Swal.fire('Error!', 'An error occurred while creating the purchase order', 'error');
                    });
                }
            });
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'High': return 'danger';
                case 'Medium': return 'warning';
                case 'Low': return 'info';
                default: return 'secondary';
            }
        }
    </script>
}

@section Styles {
    <style>
        .callout {
            border-radius: .25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.24);
            background-color: #fff;
            border-left: 5px solid #17a2b8;
            margin-bottom: 1rem;
            padding: 1rem;
        }

        .callout-info {
            border-left-color: #17a2b8;
        }

        .callout h5 {
            margin-top: 0;
            margin-bottom: .5rem;
        }
    </style>
}