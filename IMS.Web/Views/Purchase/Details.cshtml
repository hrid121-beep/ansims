@model IMS.Application.DTOs.PurchaseDto
@{
    ViewData["Title"] = "Purchase Order Details";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Purchase Order Details</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index" asp-controller="Home">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Purchases</a></li>
                    <li class="breadcrumb-item active">Details</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <!-- Status Timeline -->
        @if (Model.ApprovalHistory != null && Model.ApprovalHistory.Any())
        {
            <div class="row">
                <div class="col-12">
                    <div class="timeline">
                        @foreach (var history in Model.ApprovalHistory.OrderByDescending(h => h.Date))
                        {
                            <div>
                                <i class="fas fa-@GetTimelineIcon(history.Action) @GetTimelineColor(history.Action)"></i>
                                <div class="timeline-item">
                                    <span class="time"><i class="fas fa-clock"></i> @history.Date.ToString("dd/MM/yyyy HH:mm")</span>
                                    <h3 class="timeline-header">@history.Action by @history.UserName</h3>
                                    @if (!string.IsNullOrEmpty(history.Comments))
                                    {
                                        <div class="timeline-body">
                                            @history.Comments
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <div class="invoice p-3 mb-3">
            <!-- Title Row -->
            <div class="row">
                <div class="col-12">
                    <h4>
                        <i class="fas fa-globe"></i> Ansar & VDP Inventory Management System
                        <small class="float-right">Date: @DateTime.Now.ToString("dd/MM/yyyy")</small>
                    </h4>
                </div>
            </div>

            <!-- Info Row -->
            <div class="row invoice-info">
                <div class="col-sm-4 invoice-col">
                    From
                    <address>
                        <strong>Ansar & VDP HQ</strong><br>
                        Procurement Department<br>
                        Dhaka, Bangladesh<br>
                        Phone: +880-2-XXXXXXX<br>
                        Email: procurement@ansarvdp.gov.bd
                    </address>
                </div>

                <div class="col-sm-4 invoice-col">
                    @if (!Model.IsMarketplacePurchase && !string.IsNullOrEmpty(Model.VendorName))
                    {
                        <text>To</text>
                        <address>
                            <strong>@Model.VendorName</strong><br>
                            @if (!string.IsNullOrEmpty(Model.VendorAddress))
                            {
                                @Model.VendorAddress
                        
                                <br>
                            }
                            @if (!string.IsNullOrEmpty(Model.VendorPhone))
                            {
                                <text>Phone: @Model.VendorPhone</text>
                        
                                <br>
                            }
                            @if (!string.IsNullOrEmpty(Model.VendorEmail))
                            {
                                <text>Email: @Model.VendorEmail</text>
                            }
                        </address>
                    }
                    else if (Model.IsMarketplacePurchase)
                    {
                        <text>Marketplace Purchase</text>
                        <address>
                            <strong>Online/Marketplace</strong><br>
                            @if (!string.IsNullOrEmpty(Model.MarketplaceUrl))
                            {
                                <a href="@Model.MarketplaceUrl" target="_blank">@Model.MarketplaceUrl</a>
                            }
                        </address>
                    }
                </div>

                <div class="col-sm-4 invoice-col">
                    <b>Purchase Order #@Model.PurchaseOrderNo</b><br>
                    <br>
                    <b>Order Date:</b> @Model.PurchaseDate.ToString("dd/MM/yyyy")<br>
                    <b>Expected Delivery:</b> @(Model.ExpectedDeliveryDate?.ToString("dd/MM/yyyy") ?? "N/A")<br>
                    <b>Status:</b>
                    @switch (Model.Status)
                    {
                        case "Draft":
                            <span class="badge badge-secondary">Draft</span>
                            break;
                        case "Pending":
                            <span class="badge badge-warning">Pending Approval</span>
                            break;
                        case "Approved":
                            <span class="badge badge-success">Approved</span>
                            break;
                        case "Rejected":
                            <span class="badge badge-danger">Rejected</span>
                            break;
                        case "Completed":
                            <span class="badge badge-info">Completed</span>
                            break;
                        default:
                            <span class="badge badge-light">@Model.Status</span>
                            break;
                    }
                </div>
            </div>

            <!-- Table Row -->
            <div class="row">
                <div class="col-12 table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>SL</th>
                                <th>Item Code</th>
                                <th>Item Description</th>
                                <th>Store</th>
                                <th>Qty</th>
                                <th>Unit Price</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int sl = 1;
                            }
                            @foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td>@sl</td>
                                    <td>@item.ItemCode</td>
                                    <td>@item.ItemName</td>
                                    <td>@item.StoreName</td>
                                    <td>@item.Quantity @item.Unit</td>
                                    <td>৳@item.UnitPrice.ToString("N2")</td>
                                    <td>৳@item.TotalPrice.ToString("N2")</td>
                                </tr>
                                sl++;
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row">
                <!-- Accepted Payments Column -->
                <div class="col-6">
                    @if (!string.IsNullOrEmpty(Model.Remarks))
                    {
                        <p class="lead">Remarks:</p>
                        <p class="text-muted well well-sm shadow-none" style="margin-top: 10px;">
                            @Model.Remarks
                        </p>
                    }

                    @if (Model.Attachments != null && Model.Attachments.Any())
                    {
                        <p class="lead">Attachments:</p>
                        <ul>
                            @foreach (var attachment in Model.Attachments)
                            {
                                <li>
                                    <a href="@attachment.FilePath" target="_blank">
                                        <i class="fas fa-paperclip"></i> @attachment.FileName
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                </div>

                <!-- Total Column -->
                <div class="col-6">
                    <div class="table-responsive">
                        <table class="table">
                            <tr>
                                <th style="width:50%">Subtotal:</th>
                                <td>৳@Model.TotalAmount.ToString("N2")</td>
                            </tr>
                            <tr>
                                <th>Tax (0%)</th>
                                <td>৳0.00</td>
                            </tr>
                            <tr>
                                <th>Total:</th>
                                <td><strong>৳@Model.TotalAmount.ToString("N2")</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Action Row -->
            <div class="row no-print">
                <div class="col-12">
                    <a href="javascript:window.print()" class="btn btn-default">
                        <i class="fas fa-print"></i> Print
                    </a>

                    @if (Model.Status == "Draft")
                    {
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <button type="button" class="btn btn-success" onclick="submitForApproval(@Model.Id)">
                            <i class="fas fa-paper-plane"></i> Submit for Approval
                        </button>
                        <button type="button" class="btn btn-danger" onclick="deletePurchase(@Model.Id)">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    }

                    @if (Model.Status == "Pending" && User.IsInRole("Manager"))
                    {
                        <button type="button" class="btn btn-success" onclick="approvePurchase(@Model.Id)">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button type="button" class="btn btn-danger" onclick="rejectPurchase(@Model.Id)">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    }

                    @if (Model.Status == "Approved")
                    {
                        <button type="button" class="btn btn-info" onclick="completePurchase(@Model.Id)">
                            <i class="fas fa-check-double"></i> Mark as Completed
                        </button>
                    }

                    <a asp-action="Index" class="btn btn-secondary float-right">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        function submitForApproval(id) {
            Swal.fire({
                title: 'Submit for Approval?',
                text: 'This will send the purchase order for approval.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, submit!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("SubmitForApproval")', { id: id }, function(response) {
                        if (response.success) {
                            Swal.fire('Submitted!', 'Purchase order sent for approval.', 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('Error!', response.message, 'error');
                        }
                    });
                }
            });
        }

        function approvePurchase(id) {
            Swal.fire({
                title: 'Approve Purchase Order?',
                input: 'textarea',
                inputLabel: 'Comments (optional)',
                showCancelButton: true,
                confirmButtonText: 'Approve',
                confirmButtonColor: '#28a745'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("Approve")', { id: id, comments: result.value }, function(response) {
                        if (response.success) {
                            Swal.fire('Approved!', 'Purchase order has been approved.', 'success')
                                .then(() => location.reload());
                        }
                    });
                }
            });
        }

        function rejectPurchase(id) {
            Swal.fire({
                title: 'Reject Purchase Order?',
                input: 'textarea',
                inputLabel: 'Reason for rejection',
                inputAttributes: {
                    'required': 'required'
                },
                showCancelButton: true,
                confirmButtonText: 'Reject',
                confirmButtonColor: '#dc3545',
                preConfirm: (reason) => {
                    if (!reason) {
                        Swal.showValidationMessage('Please enter a reason for rejection');
                    }
                    return reason;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("Reject")', { id: id, reason: result.value }, function(response) {
                        if (response.success) {
                            Swal.fire('Rejected!', 'Purchase order has been rejected.', 'error')
                                .then(() => location.reload());
                        }
                    });
                }
            });
        }

        function deletePurchase(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will permanently delete the purchase order!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("Delete")', { id: id }, function(response) {
                        if (response.success) {
                            Swal.fire('Deleted!', 'Purchase order has been deleted.', 'success')
                                .then(() => window.location.href = '@Url.Action("Index")');
                        }
                    });
                }
            });
        }

        function completePurchase(id) {
            Swal.fire({
                title: 'Mark as Completed?',
                text: 'This will mark the purchase order as completed.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, complete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("Complete")', { id: id }, function(response) {
                        if (response.success) {
                            Swal.fire('Completed!', 'Purchase order marked as completed.', 'success')
                                .then(() => location.reload());
                        }
                    });
                }
            });
        }
    </script>
}

@section Styles {
    <style>
        .timeline {
            position: relative;
            padding: 20px 0 20px;
            margin-bottom: 20px;
        }

            .timeline:before {
                content: '';
                position: absolute;
                top: 0;
                left: 25px;
                height: 100%;
                width: 3px;
                background: #e9ecef;
            }

            .timeline > div > .fas {
                width: 50px;
                height: 50px;
                line-height: 50px;
                font-size: 20px;
                text-align: center;
                position: absolute;
                left: 0;
                top: 0;
                color: #fff;
                border-radius: 50%;
            }

        .timeline-item {
            margin-left: 60px;
            margin-bottom: 20px;
            color: #0c0c0c;
        }

        .timeline-header {
            font-size: 16px;
            font-weight: bold;
        }

        .bg-blue {
            background-color: #007bff !important;
        }

        .bg-yellow {
            background-color: #ffc107 !important;
        }

        .bg-green {
            background-color: #28a745 !important;
        }

        .bg-red {
            background-color: #dc3545 !important;
        }
    </style>
}

@functions {
    string GetTimelineIcon(string action)
    {
        return action switch
        {
            "Created" => "file",
            "Submitted" => "paper-plane",
            "Approved" => "check",
            "Rejected" => "times",
            "Completed" => "check-double",
            _ => "clock"
        };
    }

    string GetTimelineColor(string action)
    {
        return action switch
        {
            "Created" => "bg-blue",
            "Submitted" => "bg-yellow",
            "Approved" => "bg-green",
            "Rejected" => "bg-red",
            "Completed" => "bg-info",
            _ => "bg-gray"
        };
    }
}