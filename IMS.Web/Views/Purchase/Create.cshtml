@model IMS.Application.DTOs.PurchaseDto
@{
    ViewData["Title"] = "Create Purchase Order";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Create New Purchase Order</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index" asp-controller="Home">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Purchases</a></li>
                    <li class="breadcrumb-item active">Create</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <form asp-action="Create" method="post" enctype="multipart/form-data" id="purchaseForm">

            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-shopping-cart"></i> Purchase Information
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="PurchaseOrderNo">PO Number</label>
                                <input asp-for="PurchaseOrderNo" class="form-control" readonly value="@ViewBag.PurchaseOrderNo" />
                                <small class="text-muted">Auto-generated</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="PurchaseDate">
                                    Purchase Date <span class="text-danger">*</span>
                                </label>
                                <input asp-for="PurchaseDate" type="date" class="form-control"
                                       value="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                                <span asp-validation-for="PurchaseDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>
                                    Purchase Type <span class="text-danger">*</span>
                                </label>
                                <select id="purchaseType" class="form-control" required>
                                    <option value="">-- Select Type --</option>
                                    <option value="Vendor">Vendor Purchase</option>
                                    <option value="Marketplace">Marketplace Purchase</option>
                                </select>
                                <input type="hidden" asp-for="IsMarketplacePurchase" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="ExpectedDeliveryDate">Expected Delivery</label>
                                <input asp-for="ExpectedDeliveryDate" type="date" class="form-control"
                                       min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                <small class="text-muted">When will you receive the items?</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6" id="vendorSection" style="display:none;">
                            <div class="form-group">
                                <label asp-for="VendorId">
                                    Vendor <span class="text-danger">*</span>
                                </label>
                                <select asp-for="VendorId" asp-items="ViewBag.Vendors" class="form-control select2">
                                    <option value="">-- Select Vendor --</option>
                                </select>
                                <span asp-validation-for="VendorId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6" id="marketplaceSection" style="display:none;">
                            <div class="form-group">
                                <label asp-for="MarketplaceUrl">Marketplace URL/Details</label>
                                <input asp-for="MarketplaceUrl" class="form-control"
                                       placeholder="e.g., daraz.com.bd/product-link" />
                                <small class="text-muted">Online shop link or details</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Attachments (Quotations, etc.)</label>
                                <div class="input-group">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="attachments"
                                               name="attachments" multiple
                                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                        <label class="custom-file-label" for="attachments">
                                            Select files (maximum 5)
                                        </label>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    PDF, JPG, PNG, DOC, DOCX (each maximum 5MB)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label asp-for="Remarks">Remarks/Notes</label>
                                <textarea asp-for="Remarks" class="form-control" rows="3"
                                          placeholder="Enter any special instructions or comments..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Procurement Information Section -->
            <div class="card card-info">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-file-invoice-dollar"></i> Procurement Information
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="ProcurementType">Procurement Type <span class="text-danger">*</span></label>
                                <select asp-for="ProcurementType" class="form-control" id="procurementType" required>
                                    <option value="">-- Select Procurement Type --</option>
                                    <option value="1">Government Revenue</option>
                                    <option value="2">Private Procurement</option>
                                </select>
                                <small class="text-muted">Source of funding for this purchase</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group" id="budgetCodeField">
                                <label asp-for="BudgetCode">Budget Code</label>
                                <input asp-for="BudgetCode" class="form-control" placeholder="e.g., BDG-2025-001" />
                                <small class="text-muted">For government procurement tracking</small>
                            </div>
                            <div class="form-group" id="donorField" style="display:none;">
                                <label asp-for="ProcurementSource">Source Name</label>
                                <input asp-for="ProcurementSource" class="form-control" placeholder="Private source or organization name" />
                                <small class="text-muted">Name of the private procurement source</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchase Items Section -->
            <div class="card card-success">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-list"></i> Purchase Items
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool btn-sm btn-light" id="addItem">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped" id="itemsTable" style="display:none;">
                        <thead>
                            <tr>
                                <th width="30%">Item</th>
                                <th width="20%">Store</th>
                                <th width="10%">Quantity</th>
                                <th width="15%">Unit Price</th>
                                <th width="15%">Total</th>
                                <th width="10%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsContainer">
                            <!-- Dynamic items will be added here -->
                        </tbody>
                        <tfoot>
                            <tr class="bg-light">
                                <th colspan="4" class="text-right">Grand Total:</th>
                                <th>৳<span id="totalAmount">0.00</span></th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                    <div id="noItemsMessage" class="text-center text-muted py-5">
                        <i class="fas fa-box-open fa-4x mb-3 text-secondary"></i>
                        <h5>No items added yet</h5>
                        <p>Click the "Add Item" button above to get started</p>
                    </div>
                </div>
            </div>

            <div class="card-footer">
                <button type="submit" name="action" value="save" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save as Draft
                </button>
                <button type="submit" name="action" value="submit" class="btn btn-success">
                    <i class="fas fa-paper-plane"></i> Save and Submit for Approval
                </button>
                <a asp-action="Index" class="btn btn-default">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        let itemIndex = 0;
        const items = @Html.Raw(Json.Serialize(ViewBag.Items ?? new List<SelectListItem>()));
        const stores = @Html.Raw(Json.Serialize(ViewBag.Stores ?? new List<SelectListItem>()));

        $(document).ready(function() {
            $('.select2').select2({
                placeholder: "Select",
                allowClear: true
            });

            // Show model errors as toastr
            @if (!ViewData.ModelState.IsValid)
            {
                        foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                                    <text>toastr.error('@Html.Raw(error.ErrorMessage.Replace("'", "\\'"))');</text>
                        }
            }

            // Purchase type change
            $('#purchaseType').change(function() {
                const type = $(this).val();
                $('#IsMarketplacePurchase').val(type === 'Marketplace');

                if (type === 'Vendor') {
                    $('#vendorSection').show();
                    $('#marketplaceSection').hide();
                    $('#VendorId').prop('required', true);
                    toastr.info('Please select a vendor');
                } else if (type === 'Marketplace') {
                    $('#vendorSection').hide();
                    $('#marketplaceSection').show();
                    $('#VendorId').prop('required', false);
                    toastr.info('Please provide marketplace details');
                } else {
                    $('#vendorSection').hide();
                    $('#marketplaceSection').hide();
                }
            });

            // Procurement type change
            $('#procurementType').change(function() {
                const type = $(this).val();
                if (type === '1') { // Government Revenue
                    $('#budgetCodeField').show();
                    $('#donorField').hide();
                    $('#BudgetCode').prop('required', true);
                    $('#ProcurementSource').prop('required', false);
                } else if (type === '2') { // Private Procurement
                    $('#budgetCodeField').hide();
                    $('#donorField').show();
                    $('#BudgetCode').prop('required', false);
                    $('#ProcurementSource').prop('required', true);
                } else {
                    $('#budgetCodeField').hide();
                    $('#donorField').hide();
                }
            });

            // Add item click
            $('#addItem').click(function() {
                addItemRow();
                toastr.success('New item row added', '', { timeOut: 2000 });
            });

            // Remove item with confirmation
            $(document).on('click', '.remove-item', function() {
                const $row = $(this).closest('tr');

                Swal.fire({
                    title: 'Delete Item?',
                    text: 'This item will be removed from the list',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $row.fadeOut(300, function() {
                            $(this).remove();
                            calculateGrandTotal();
                            toggleNoItemsMessage();
                            reindexItems();
                            toastr.success('Item deleted');
                        });
                    }
                });
            });

            // Calculate on change with validation
            $(document).on('input', '.quantity, .unit-price', function() {
                const value = parseFloat($(this).val());

                if ($(this).hasClass('quantity')) {
                    if (value <= 0) {
                        $(this).addClass('is-invalid');
                        toastr.warning('Quantity must be greater than zero', '', { timeOut: 2000 });
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                }

                if ($(this).hasClass('unit-price')) {
                    if (value < 0) {
                        $(this).addClass('is-invalid');
                        toastr.warning('Price cannot be negative', '', { timeOut: 2000 });
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                }

                calculateRowTotal($(this).closest('tr'));
            });

            // Custom file input
            $('.custom-file-input').on('change', function() {
                var files = Array.from(this.files);
                var fileNames = files.map(f => f.name).join(', ');
                $(this).siblings('.custom-file-label').html(fileNames || 'Select files');

                if (files.length > 5) {
                    toastr.error('Maximum 5 files can be uploaded');
                    this.value = '';
                    $(this).siblings('.custom-file-label').html('Select files');
                    return;
                }

                // Check file sizes
                let totalSize = 0;
                for (let file of files) {
                    totalSize += file.size;
                    if (file.size > 5 * 1024 * 1024) {
                        toastr.error(`File "${file.name}" exceeds 5MB size limit!`);
                        this.value = '';
                        $(this).siblings('.custom-file-label').html('Select files');
                        return;
                    }
                }

                toastr.success(`${files.length} file(s) selected`);
            });

            // Form validation
            $('#purchaseForm').submit(function(e) {
                if ($('#itemsContainer tr').length === 0) {
                    e.preventDefault();
                    toastr.error('Please add at least one item!');
                    return false;
                }

                if (!$('#purchaseType').val()) {
                    e.preventDefault();
                    toastr.error('Please select purchase type!');
                    $('#purchaseType').focus();
                    return false;
                }

                if ($('#purchaseType').val() === 'Vendor' && !$('#VendorId').val()) {
                    e.preventDefault();
                    toastr.error('Please select a vendor!');
                    $('#VendorId').focus();
                    return false;
                }

                if (!$('#procurementType').val()) {
                    e.preventDefault();
                    toastr.error('Please select procurement type!');
                    $('#procurementType').focus();
                    return false;
                }

                // Check if at least one item is added
                if ($('#itemsContainer tr').length === 0) {
                    e.preventDefault();
                    toastr.error('Please add at least one item to the purchase order!');
                    $('#addItem').focus();
                    return false;
                }

                // Validate all items have required fields
                let hasError = false;
                $('.item-select, .store-select, .quantity, .unit-price').each(function() {
                    if (!$(this).val() || $(this).val() <= 0) {
                        $(this).addClass('is-invalid');
                        hasError = true;
                    }
                });

                if (hasError) {
                    e.preventDefault();
                    toastr.error('Please fill all item information correctly!');
                    return false;
                }

                // Show loading
                Swal.fire({
                    title: 'Processing...',
                    text: 'Saving purchase order, please wait',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });
            });
        });

        function addItemRow() {
            const row = `
                <tr data-index="${itemIndex}" class="animated fadeIn">
                    <td>
                        <select name="Items[${itemIndex}].ItemId" class="form-control item-select" required>
                            <option value="">-- Select Item --</option>
                            ${items.map(item => `<option value="${item.value}">${item.text}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select name="Items[${itemIndex}].StoreId" class="form-control store-select" required>
                            <option value="">-- Select Store --</option>
                            ${stores.map(store => `<option value="${store.value}">${store.text}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].Quantity"
                               class="form-control quantity" min="0.01" step="0.01"
                               placeholder="0.00" required />
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].UnitPrice"
                               class="form-control unit-price" min="0" step="0.01"
                               placeholder="0.00" required />
                    </td>
                    <td>
                        <input type="text" name="Items[${itemIndex}].TotalPrice"
                               class="form-control total bg-light" readonly />
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger remove-item"
                                title="Delete Item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

            $('#itemsContainer').append(row);
            itemIndex++;
            toggleNoItemsMessage();

            // Initialize select2 for new row
            $(`tr[data-index="${itemIndex-1}"] select`).select2({
                placeholder: "Select",
                allowClear: true
            });
        }

        function calculateRowTotal($row) {
            const quantity = parseFloat($row.find('.quantity').val()) || 0;
            const unitPrice = parseFloat($row.find('.unit-price').val()) || 0;
            const total = quantity * unitPrice;
            $row.find('.total').val(total.toFixed(2));
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let grandTotal = 0;
            $('.total').each(function() {
                grandTotal += parseFloat($(this).val()) || 0;
            });
            $('#totalAmount').text(grandTotal.toFixed(2));

            // Show warning if total is too high
            if (grandTotal > 1000000) {
                toastr.warning('Total amount exceeds 10 lakh BDT!', '', { timeOut: 5000 });
            }
        }

        function toggleNoItemsMessage() {
            if ($('#itemsContainer tr').length === 0) {
                $('#noItemsMessage').show();
                $('#itemsTable').hide();
            } else {
                $('#noItemsMessage').hide();
                $('#itemsTable').show();
            }
        }

        function reindexItems() {
            $('#itemsContainer tr').each(function(index) {
                $(this).attr('data-index', index);
                $(this).find('[name*="Items["]').each(function() {
                    const name = $(this).attr('name');
                    const newName = name.replace(/Items\[\d+\]/, `Items[${index}]`);
                    $(this).attr('name', newName);
                });
            });
        }
    </script>
}

@section Styles {
    <style>
        .custom-file-label::after {
            content: "Browse";
        }

        #itemsTable th {
            background-color: #f4f6f9;
            font-weight: 600;
        }

        .total {
            font-weight: bold;
            background-color: #f8f9fa;
        }

        .is-invalid {
            border-color: #dc3545;
        }

        .animated {
            animation-duration: 0.3s;
        }

        @@keyframes fadeIn {
            from

        {
            opacity: 0;
        }

        to {
            opacity: 1;
        }

        }

        .fadeIn {
            animation-name: fadeIn;
        }
    </style>
}