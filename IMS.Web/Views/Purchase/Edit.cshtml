@model IMS.Application.DTOs.PurchaseDto
@{
    ViewData["Title"] = "Edit Purchase Order";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Edit Purchase Order</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index" asp-controller="Home">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Purchases</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        @if (Model.Status != "Draft")
        {
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> Only draft purchase orders can be edited.
            </div>
        }

        <form asp-action="Edit" method="post" enctype="multipart/form-data" id="editPurchaseForm">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="PurchaseOrderNo" />
            <input type="hidden" asp-for="Status" />
            
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Purchase Information</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>PO Number</label>
                                <input asp-for="PurchaseOrderNo" class="form-control" readonly />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="PurchaseDate">Purchase Date</label>
                                <input asp-for="PurchaseDate" type="date" class="form-control" required />
                                <span asp-validation-for="PurchaseDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Purchase Type</label>
                                <select id="purchaseType" class="form-control" required>
                                    <option value="Vendor" selected="@(!Model.IsMarketplacePurchase)">Vendor Purchase</option>
                                    <option value="Marketplace" selected="@Model.IsMarketplacePurchase">Marketplace Purchase</option>
                                </select>
                                <input type="hidden" asp-for="IsMarketplacePurchase" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="ExpectedDeliveryDate">Expected Delivery</label>
                                <input asp-for="ExpectedDeliveryDate" type="date" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6" id="vendorSection">
                            <div class="form-group">
                                <label asp-for="VendorId">Vendor</label>
                                <select asp-for="VendorId" asp-items="ViewBag.Vendors" class="form-control select2">
                                    <option value="">Select Vendor</option>
                                </select>
                                <span asp-validation-for="VendorId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6" id="marketplaceSection">
                            <div class="form-group">
                                <label asp-for="MarketplaceUrl">Marketplace URL/Details</label>
                                <input asp-for="MarketplaceUrl" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label asp-for="Remarks">Remarks</label>
                        <textarea asp-for="Remarks" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <div class="card card-info">
                <div class="card-header">
                    <h3 class="card-title">Purchase Items</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool btn-sm btn-primary" id="addItem">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped" id="itemsTable">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Store</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsContainer">
                            @if (Model.Items != null)
                            {
                                @for (int i = 0; i < Model.Items.Count; i++)
                                {
                                    <tr data-index="@i">
                                        <td>
                                            <select name="Items[@i].ItemId" class="form-control item-select" required>
                                                <option value="">Select Item</option>
                                                @foreach (var item in ViewBag.Items as List<SelectListItem>)
                                                {
                                                    <option value="@item.Value" selected="@(item.Value == Model.Items[i].ItemId.ToString())">@item.Text</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <select name="Items[@i].StoreId" class="form-control store-select" required>
                                                <option value="">Select Store</option>
                                                @foreach (var store in ViewBag.Stores as SelectList)
                                                {
                                                    <option value="@store.Value" selected="@(store.Value == Model.Items[i].StoreId?.ToString())">@store.Text</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="Items[@i].Quantity" value="@Model.Items[i].Quantity"
                                                   class="form-control quantity" min="1" step="0.01" required />
                                        </td>
                                        <td>
                                            <input type="number" name="Items[@i].UnitPrice" value="@Model.Items[i].UnitPrice"
                                                   class="form-control unit-price" min="0" step="0.01" required />
                                        </td>
                                        <td>
                                            <input type="text" name="Items[@i].TotalPrice" value="@Model.Items[i].TotalPrice" class="form-control total" readonly />
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-danger remove-item">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="4" class="text-right">Grand Total:</th>
                                <th>৳<span id="totalAmount">@Model.TotalAmount.ToString("N2")</span></th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="card-footer">
                <button type="submit" class="btn btn-primary" @(Model.Status != "Draft" ? "disabled" : "")>
                    <i class="fas fa-save"></i> Update Purchase Order
                </button>
                <a asp-action="Index" class="btn btn-default">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        let itemIndex = @(Model.Items?.Count ?? 0);
        const items = @Html.Raw(Json.Serialize(ViewBag.Items ?? new List<SelectListItem>()));
        const stores = @Html.Raw(Json.Serialize(ViewBag.Stores ?? new List<SelectListItem>()));

        $(document).ready(function() {
            $('.select2').select2();
            
            // Initialize purchase type
            $('#purchaseType').change(function() {
                const isMarketplace = $(this).val() === 'Marketplace';
                $('#IsMarketplacePurchase').val(isMarketplace);
                
                if (isMarketplace) {
                    $('#vendorSection').hide();
                    $('#marketplaceSection').show();
                } else {
                    $('#vendorSection').show();
                    $('#marketplaceSection').hide();
                }
            }).trigger('change');

            // Calculate initial totals
            $('.quantity, .unit-price').each(function() {
                calculateRowTotal($(this).closest('tr'));
            });

            $('#addItem').click(function() {
                addItemRow();
            });

            $(document).on('click', '.remove-item', function() {
                $(this).closest('tr').remove();
                calculateGrandTotal();
                reindexItems();
            });

            $(document).on('input', '.quantity, .unit-price', function() {
                calculateRowTotal($(this).closest('tr'));
            });
        });

        function addItemRow() {
            const row = `
                <tr data-index="${itemIndex}">
                    <td>
                        <select name="Items[${itemIndex}].ItemId" class="form-control item-select" required>
                            <option value="">Select Item</option>
                            ${items.map(item => `<option value="${item.value}">${item.text}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select name="Items[${itemIndex}].StoreId" class="form-control store-select" required>
                            <option value="">Select Store</option>
                            ${stores.map(store => `<option value="${store.value}">${store.text}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].Quantity" class="form-control quantity" min="1" step="0.01" required />
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].UnitPrice" class="form-control unit-price" min="0" step="0.01" required />
                    </td>
                    <td>
                        <input type="text" name="Items[${itemIndex}].TotalPrice" class="form-control total" readonly />
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger remove-item">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            $('#itemsContainer').append(row);
            itemIndex++;
        }

        function calculateRowTotal($row) {
            const quantity = parseFloat($row.find('.quantity').val()) || 0;
            const unitPrice = parseFloat($row.find('.unit-price').val()) || 0;
            const total = quantity * unitPrice;
            $row.find('.total').val(total.toFixed(2));
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let grandTotal = 0;
            $('.total').each(function() {
                grandTotal += parseFloat($(this).val()) || 0;
            });
            $('#totalAmount').text(grandTotal.toFixed(2));
        }

        function reindexItems() {
            $('#itemsContainer tr').each(function(index) {
                $(this).attr('data-index', index);
                $(this).find('[name*="Items["]').each(function() {
                    const name = $(this).attr('name');
                    const newName = name.replace(/Items\[\d+\]/, `Items[${index}]`);
                    $(this).attr('name', newName);
                });
            });
        }
    </script>
}