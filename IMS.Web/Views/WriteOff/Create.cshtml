@model IMS.Application.DTOs.WriteOffDto
@{
    ViewData["Title"] = "Create Write-off";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Create Write-off</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Home</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index")">Write-offs</a></li>
                    <li class="breadcrumb-item active">Create</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <form asp-action="Create" method="post" enctype="multipart/form-data" id="writeOffForm">
            <div class="row">
                <div class="col-md-8">
                    <!-- Basic Information -->
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-info-circle"></i> Write-off Information</h3>
                        </div>
                        <div class="card-body">
                            <!-- ✅ ADD VALIDATION SUMMARY -->
                            <div asp-validation-summary="All" class="alert alert-danger" style="display: none;"></div>

                            <!-- When to Use Bulk Write-off -->
                            <div class="alert alert-primary alert-dismissible" style="background-color: #007bff; color: white; border-color: #007bff;">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true" style="color: white;">&times;</button>
                                <h5><i class="fas fa-layer-group"></i> Bulk Write-off (Multi-Item)</h5>
                                <p class="mb-0">
                                    Use this for <strong>writing off MULTIPLE items at once</strong> with file attachments.
                                    <br><br>
                                    <strong>For single-item damage/loss:</strong> Use
                                    <a href="@Url.Action("Create", "StockAdjustment")" style="color: #ffeb3b; text-decoration: underline;"><strong>New Adjustment [Smart]</strong></a>
                                    - it will automatically create the write-off for you!
                                </p>
                            </div>

                            <!-- Reason Selection Info -->
                            <div class="alert alert-danger alert-dismissible" style="background-color: #dc3545; color: white; border-color: #dc3545;">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true" style="color: white;">&times;</button>
                                <h5><i class="fas fa-exclamation-triangle"></i> Important</h5>
                                <p class="mb-0">
                                    Select the appropriate <strong>Reason</strong> for this write-off. Items marked as <strong>"Damaged"</strong> will appear in Damage Reports under the Reports menu.
                                </p>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="WriteOffDate">Date <span class="text-danger">*</span></label>
                                        <input asp-for="WriteOffDate" class="form-control" type="date" required />
                                        <span asp-validation-for="WriteOffDate" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="Reason">Reason <span class="text-danger">*</span></label>
                                        <select asp-for="Reason" class="form-control" id="reasonSelect" asp-items="ViewBag.WriteOffReasons" required>
                                        </select>
                                        <span asp-validation-for="Reason" class="text-danger"></span>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle"></i> Choose the primary reason for writing off these items
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="customReasonRow" style="display: none;">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label>Custom Reason</label>
                                        <textarea id="customReason" class="form-control" rows="2"
                                                  placeholder="Enter detailed reason..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label>Attachments</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="attachments"
                                                   name="attachments" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                            <label class="custom-file-label" for="attachments">Choose files...</label>
                                        </div>
                                        <small class="form-text text-muted">
                                            You can attach supporting documents (PDF, JPG, PNG, DOC, DOCX). Max 10MB per file.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items -->
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">Items to Write Off</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool btn-sm" id="addItemBtn">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-striped" id="itemsTable">
                                <thead>
                                    <tr>
                                        <th style="width: 25%">Item</th>
                                        <th style="width: 20%">Store</th>
                                        <th style="width: 15%">Quantity</th>
                                        <th style="width: 15%">Unit Price</th>
                                        <th style="width: 15%">Total</th>
                                        <th style="width: 10%">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsContainer">
                                    <!-- Items will be added dynamically -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="4" class="text-right">Total Value:</th>
                                        <th id="totalValue">$0.00</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Summary Panel -->
                <div class="col-md-4">
                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title">Summary</h3>
                        </div>
                        <div class="card-body">
                            <div class="info-box bg-light">
                                <span class="info-box-icon"><i class="fas fa-calculator"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Total Items</span>
                                    <span class="info-box-number" id="totalItems">0</span>
                                </div>
                            </div>
                            <div class="info-box bg-light">
                                <span class="info-box-icon"><i class="fas fa-dollar-sign"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Total Value</span>
                                    <span class="info-box-number" id="summaryTotalValue">$0.00</span>
                                </div>
                            </div>
                            <div id="approvalRequirement" class="alert alert-info" style="display: none;">
                                <h6>Approval Required</h6>
                                <p id="approvalMessage"></p>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-save"></i> Create Write-off
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-secondary btn-block">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Item Row Template -->
<script id="itemRowTemplate" type="text/template">
    <tr class="item-row">
        <td>
            <input type="hidden" name="Items[{index}].ItemId" class="item-id" />
            <select class="form-control item-select" data-index="{index}" required>
                <option value="">-- Select Item --</option>
                @foreach (var item in ViewBag.Items as IEnumerable<SelectListItem>)
                {
                        <option value="@item.Value">@item.Text</option>
                }
            </select>
        </td>
        <td>
            <input type="hidden" name="Items[{index}].StoreId" class="store-id" />
            <select class="form-control store-select" data-index="{index}" required>
                <option value="">-- Select Store --</option>
                @foreach (var store in ViewBag.Stores as IEnumerable<SelectListItem>)
                {
                        <option value="@store.Value">@store.Text</option>
                }
            </select>
            <small class="text-muted stock-info"></small>
        </td>
        <td>
            <input type="number" name="Items[{index}].Quantity" class="form-control quantity-input"
                   min="1" step="1" value="" required />
        </td>
        <td>
            <input type="hidden" name="Items[{index}].UnitPrice" class="unit-price" />
            <span class="unit-price-display">$0.00</span>
        </td>
        <td>
            <span class="total-price">$0.00</span>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm remove-item">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {
            let itemIndex = 0;

            // ✅ Show validation summary if it has content
            if ($('.validation-summary-errors').length > 0) {
                $('.validation-summary-errors').show();
                $('html, body').animate({ scrollTop: 0 }, 'slow');
            }

            // Handle reason selection
            $('#reasonSelect').change(function () {
                if ($(this).val() === 'Other') {
                    $('#customReasonRow').show();
                } else {
                    $('#customReasonRow').hide();
                    $('#customReason').val('');
                }
            });

            // Handle file input
            $('#attachments').change(function () {
                var files = $(this)[0].files;
                var label = $(this).next('.custom-file-label');
                if (files.length > 0) {
                    label.text(files.length + ' file(s) selected');
                } else {
                    label.text('Choose files...');
                }
            });

            // Add item
            $('#addItemBtn').click(function () {
                addItemRow();
            });

            // Add first item row
            addItemRow();

            // Recalculate all rows on page load (in case there's existing data)
            setTimeout(function() {
                $('.item-row').each(function() {
                    calculateRowTotal($(this));
                });
            }, 500);

            function addItemRow() {
                var template = $('#itemRowTemplate').html();
                var html = template.replace(/{index}/g, itemIndex);
                $('#itemsContainer').append(html);
                itemIndex++;
                updateSummary();
            }

            // Remove item
            $(document).on('click', '.remove-item', function () {
                $(this).closest('tr').remove();
                updateSummary();
                updateIndexes();
            });

            // Item selection change
            $(document).on('change', '.item-select', function () {
                var $row = $(this).closest('tr');
                var itemId = $(this).val();
                var $select = $(this);

                console.log('=== ITEM SELECTED ===');
                console.log('Item ID:', itemId);
                console.log('Item Name:', $select.find('option:selected').text());

                if (!itemId || itemId === '') {
                    console.log('No item selected, clearing values');
                    $row.find('.item-id').val('');
                    $row.find('.unit-price').val(0);
                    $row.find('.unit-price-display').text('$0.00');
                    $row.find('.total-price').text('$0.00');
                    calculateRowTotal($row);
                    return;
                }

                $row.find('.item-id').val(itemId);
                $row.find('.unit-price-display').html('<i class="fas fa-spinner fa-spin"></i> Loading...');

                // Get storeId if selected
                var storeId = $row.find('.store-id').val();

                // Get item details with absolute URL (include storeId if available)
                var url = window.location.origin + '/WriteOff/GetItemDetails?itemId=' + itemId;
                if (storeId) {
                    url += '&storeId=' + storeId;
                }
                console.log('Fetching from URL:', url);

                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function (result) {
                        console.log('=== AJAX SUCCESS ===');
                        console.log('Full Response:', JSON.stringify(result, null, 2));

                        if (result && result.success && result.data) {
                            var unitPrice = parseFloat(result.data.unitPrice) || 0;
                            console.log('Parsed Unit Price:', unitPrice);

                            // Update hidden input and display
                            $row.find('.unit-price').val(unitPrice);
                            $row.find('.unit-price-display').text('$' + unitPrice.toFixed(2));
                            console.log('Updated .unit-price input to:', unitPrice);
                            console.log('Updated .unit-price-display to: $' + unitPrice.toFixed(2));

                            // Trigger calculation
                            setTimeout(function() {
                                calculateRowTotal($row);
                                checkStockLevel($row);
                            }, 100);
                        } else {
                            console.error('Invalid response structure:', result);
                            alert('Failed to get item price: ' + (result.message || 'Invalid response'));
                            $row.find('.unit-price').val(0);
                            $row.find('.unit-price-display').text('$0.00 (Failed)');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('=== AJAX ERROR ===');
                        console.error('Status:', status);
                        console.error('Error:', error);
                        console.error('Response Text:', xhr.responseText);
                        console.error('Status Code:', xhr.status);

                        alert('Error loading item price!\nStatus: ' + status + '\nError: ' + error + '\nCheck console for details.');
                        $row.find('.unit-price').val(0);
                        $row.find('.unit-price-display').text('$0.00 (Error)');
                    }
                });
            });

            // Store selection change
            $(document).on('change', '.store-select', function () {
                var $row = $(this).closest('tr');
                var storeId = $(this).val();
                var index = $(this).data('index');

                if (storeId) {
                    $row.find('.store-id').val(storeId);
                    checkStockLevel($row);

                    // If item is already selected, re-fetch the price with the new storeId
                    var itemId = $row.find('.item-id').val();
                    if (itemId) {
                        console.log('Store changed, re-fetching price for item:', itemId, 'store:', storeId);
                        $row.find('.unit-price-display').html('<i class="fas fa-spinner fa-spin"></i> Updating...');

                        var url = window.location.origin + '/WriteOff/GetItemDetails?itemId=' + itemId + '&storeId=' + storeId;

                        $.ajax({
                            url: url,
                            type: 'GET',
                            dataType: 'json',
                            success: function (result) {
                                if (result && result.success && result.data) {
                                    var unitPrice = parseFloat(result.data.unitPrice) || 0;
                                    $row.find('.unit-price').val(unitPrice);
                                    $row.find('.unit-price-display').text('$' + unitPrice.toFixed(2));
                                    calculateRowTotal($row);
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error('Error re-fetching price:', error);
                                $row.find('.unit-price-display').text('$0.00 (Error)');
                            }
                        });
                    }
                }
            });

            // Quantity change - handle all events
            $(document).on('input change keyup blur', '.quantity-input', function () {
                var $row = $(this).closest('tr');
                var quantity = $(this).val();
                console.log('=== QUANTITY CHANGED ===');
                console.log('New Quantity:', quantity);
                calculateRowTotal($row);
                checkStockLevel($row);
            });

            function checkStockLevel($row) {
                var itemId = $row.find('.item-id').val();
                var storeId = $row.find('.store-id').val();
                var quantity = parseFloat($row.find('.quantity-input').val()) || 0;

                if (itemId && storeId) {
                    $.ajax({
                        url: '@Url.Action("GetStockLevel", "WriteOff")',
                        type: 'GET',
                        data: { itemId: itemId, storeId: storeId },
                        success: function (result) {
                            console.log('Stock Level Result:', result);
                            if (result.success) {
                                var $stockInfo = $row.find('.stock-info');
                                var stockLevel = result.stockLevel || 0;
                                $stockInfo.text('Stock: ' + stockLevel.toFixed(2));

                                if (quantity > stockLevel) {
                                    $stockInfo.addClass('text-danger').removeClass('text-success');
                                    $row.find('.quantity-input').addClass('is-invalid');
                                } else {
                                    $stockInfo.addClass('text-success').removeClass('text-danger');
                                    $row.find('.quantity-input').removeClass('is-invalid');
                                }
                            } else {
                                console.error('Error fetching stock:', result.message);
                                $row.find('.stock-info').text('Stock: N/A').addClass('text-warning');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('AJAX Error:', error);
                            $row.find('.stock-info').text('Stock: Error').addClass('text-danger');
                        }
                    });
                } else {
                    $row.find('.stock-info').text('');
                }
            }

            function calculateRowTotal($row) {
                console.log('=== CALCULATING ROW TOTAL ===');

                var quantityInput = $row.find('.quantity-input');
                var unitPriceInput = $row.find('.unit-price');
                var totalDisplay = $row.find('.total-price');

                var quantity = parseFloat(quantityInput.val()) || 0;
                var unitPrice = parseFloat(unitPriceInput.val()) || 0;
                var total = quantity * unitPrice;

                console.log('Quantity Input Value:', quantityInput.val());
                console.log('Quantity (parsed):', quantity);
                console.log('Unit Price Input Value:', unitPriceInput.val());
                console.log('Unit Price (parsed):', unitPrice);
                console.log('Calculated Total:', total);

                var displayText = '$' + total.toFixed(2);
                totalDisplay.text(displayText);
                console.log('Updated Total Display to:', displayText);

                updateSummary();
            }

            function updateSummary() {
                console.log('=== UPDATING SUMMARY ===');
                var totalItems = 0;
                var totalValue = 0;

                $('.item-row').each(function () {
                    var quantity = parseFloat($(this).find('.quantity-input').val()) || 0;
                    var unitPrice = parseFloat($(this).find('.unit-price').val()) || 0;
                    var rowTotal = quantity * unitPrice;

                    console.log('Row - Qty:', quantity, 'Price:', unitPrice, 'Row Total:', rowTotal);

                    if (quantity > 0) {
                        totalItems++;
                        totalValue += rowTotal;
                    }
                });

                console.log('Total Items:', totalItems);
                console.log('Total Value:', totalValue);

                $('#totalItems').text(totalItems);
                $('#totalValue').text('$' + totalValue.toFixed(2));
                $('#summaryTotalValue').text('$' + totalValue.toFixed(2));

                // Check approval requirement
                checkApprovalRequirement(totalValue);
            }

            function checkApprovalRequirement(totalValue) {
                $.get('@Url.Action("GetApprovalRequirement")', { totalValue: totalValue }, function (result) {
                    if (result.success) {
                        if (result.requiresApproval) {
                            $('#approvalRequirement').show();
                            $('#approvalMessage').html(
                                '<strong>' + result.description + '</strong><br>' +
                                'Approver: ' + result.approverRole
                            );
                        } else {
                            $('#approvalRequirement').hide();
                        }
                    }
                });
            }

            function updateIndexes() {
                $('.item-row').each(function (index) {
                    $(this).find('input, select').each(function () {
                        var name = $(this).attr('name');
                        if (name) {
                            $(this).attr('name', name.replace(/\[\d+\]/, '[' + index + ']'));
                        }
                        if ($(this).data('index') !== undefined) {
                            $(this).data('index', index);
                        }
                    });
                });
            }

            // Form validation
            $('#writeOffForm').submit(function (e) {
                console.log('=== FORM SUBMIT VALIDATION ===');

                var itemCount = $('.item-row').length;
                console.log('Item Count:', itemCount);

                if (itemCount === 0) {
                    e.preventDefault();
                    toastr.error('Please add at least one item to write off.');
                    return false;
                }

                // Validate each item row
                var hasErrors = false;
                $('.item-row').each(function(index) {
                    var itemId = $(this).find('.item-id').val();
                    var storeId = $(this).find('.store-id').val();
                    var quantity = $(this).find('.quantity-input').val();

                    console.log('Row', index, '- ItemId:', itemId, 'StoreId:', storeId, 'Quantity:', quantity);

                    if (!itemId || itemId === '' || itemId === '0') {
                        toastr.error('Please select an item for row ' + (index + 1));
                        hasErrors = true;
                    }
                    if (!storeId || storeId === '' || storeId === '0') {
                        toastr.error('Please select a store for row ' + (index + 1));
                        hasErrors = true;
                    }
                    if (!quantity || parseFloat(quantity) <= 0) {
                        toastr.error('Please enter a valid quantity for row ' + (index + 1));
                        hasErrors = true;
                    }
                });

                if (hasErrors) {
                    e.preventDefault();
                    return false;
                }

                // Check for invalid quantities
                if ($('.quantity-input.is-invalid').length > 0) {
                    e.preventDefault();
                    toastr.error('Some items have insufficient stock. Please check the quantities.');
                    return false;
                }

                // Update reason if custom
                if ($('#reasonSelect').val() === 'Other') {
                    var customReason = $('#customReason').val();
                    if (!customReason) {
                        e.preventDefault();
                        toastr.error('Please enter a custom reason.');
                        return false;
                    }
                    $('#reasonSelect').val(customReason);
                }

                console.log('=== FORM VALIDATION PASSED - SUBMITTING ===');
            });
        });
    </script>
}