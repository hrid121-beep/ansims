@model IEnumerable<IMS.Application.DTOs.ActivityLogDto>
@{
    ViewData["Title"] = "Activity Logs";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-history"></i> Activity Logs
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item">System</li>
                    <li class="breadcrumb-item active">Activity Logs</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Summary Statistics -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>@ViewBag.TotalActivitiesToday</h3>
                        <p>Total Activities Today</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>@ViewBag.ActiveUsers</h3>
                        <p>Active Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>@ViewBag.FailedLogins</h3>
                        <p>Failed Login Attempts</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>@ViewBag.CriticalEvents</h3>
                        <p>Critical Events</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Card -->
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-filter"></i> Filter Logs
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form method="get" id="filterForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Activity Type</label>
                                <select class="form-control" name="activityType">
                                    <option value="">All Types</option>
                                    @{
                                        var activityTypes = new[] { "Login", "Logout", "Create", "Update", "Delete", "Approve", "Reject", "Export", "Import" };
                                        foreach (var type in activityTypes)
                                        {
                                            if (ViewBag.CurrentActivityType == type)
                                            {
                                                <option value="@type" selected>@type</option>
                                            }
                                            else
                                            {
                                                <option value="@type">@type</option>
                                            }
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Module</label>
                                <select class="form-control" name="module">
                                    <option value="">All Modules</option>
                                    @{
                                        var modules = new Dictionary<string, string>
                                        {
                                            { "Purchase", "Purchase" },
                                            { "Item", "Item" },
                                            { "Issue", "Issue" },
                                            { "Receive", "Receive" },
                                            { "Transfer", "Transfer" },
                                            { "Return", "Return" },
                                            { "StockAdjustment", "Stock Adjustment" },
                                            { "User", "User Management" },
                                            { "Store", "Store" }
                                        };
                                        foreach (var module in modules)
                                        {
                                            if (ViewBag.CurrentModule == module.Key)
                                            {
                                                <option value="@module.Key" selected>@module.Value</option>
                                            }
                                            else
                                            {
                                                <option value="@module.Key">@module.Value</option>
                                            }
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>User</label>
                                <input type="text" class="form-control" name="userName" value="@ViewBag.CurrentUserName" placeholder="Search by username" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Date Range</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" name="fromDate" value="@ViewBag.CurrentFromDate" />
                                    <input type="date" class="form-control" name="toDate" value="@ViewBag.CurrentToDate" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Apply Filters
                            </button>
                            <button type="button" class="btn btn-default" onclick="resetFilters()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                            <button type="button" class="btn btn-success float-right" onclick="exportLogs()">
                                <i class="fas fa-file-excel"></i> Export Logs
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Activity Logs Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Activity Log Entries</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-sm btn-tool" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th width="150">Timestamp</th>
                                <th width="100">User</th>
                                <th width="100">Activity</th>
                                <th width="100">Module</th>
                                <th>Description</th>
                                <th width="100">IP Address</th>
                                <th width="80">Status</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable">
                            @if (Model != null && Model.Any())
                            {
                                @foreach (var log in Model)
                                {
                                    var badgeClass = log.Action?.ToLower() switch
                                    {
                                        "create" => "badge-success",
                                        "update" => "badge-info",
                                        "delete" => "badge-danger",
                                        "approve" => "badge-success",
                                        "reject" => "badge-warning",
                                        "login" => "badge-primary",
                                        "logout" => "badge-secondary",
                                        _ => "badge-default"
                                    };

                                    <tr>
                                        <td><small>@log.Timestamp.ToString("MM/dd/yyyy HH:mm:ss")</small></td>
                                        <td><strong>@(log.UserName ?? "Unknown")</strong></td>
                                        <td><span class="badge @badgeClass">@log.Action</span></td>
                                        <td>@(log.Module ?? log.Entity ?? "-")</td>
                                        <td>@(log.Description ?? log.Details ?? "-")</td>
                                        <td><small>@(log.IPAddress ?? "-")</small></td>
                                        <td><span class="badge badge-success"><i class="fas fa-check"></i></span></td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="text-center py-5 text-muted">
                                        <i class="fas fa-history fa-3x mb-3"></i>
                                        <p>No activity logs available</p>
                                        <small>Activity logs will appear here when users perform actions in the system</small>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-12 col-md-5">
                        <div class="dataTables_info">
                            Showing @(((ViewBag.CurrentPage - 1) * ViewBag.PageSize) + 1) to
                            @(Math.Min(ViewBag.CurrentPage * ViewBag.PageSize, ViewBag.TotalLogs))
                            of @ViewBag.TotalLogs entries
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-7">
                        <ul class="pagination pagination-sm m-0 float-right">
                            @if (ViewBag.CurrentPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="?page=@(ViewBag.CurrentPage - 1)&activityType=@ViewBag.CurrentActivityType&module=@ViewBag.CurrentModule&userName=@ViewBag.CurrentUserName&fromDate=@ViewBag.CurrentFromDate&toDate=@ViewBag.CurrentToDate">«</a>
                                </li>
                            }
                            else
                            {
                                <li class="page-item disabled"><a class="page-link" href="#">«</a></li>
                            }

                            @for (int i = Math.Max(1, ViewBag.CurrentPage - 2); i <= Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2); i++)
                            {
                                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="?page=@i&activityType=@ViewBag.CurrentActivityType&module=@ViewBag.CurrentModule&userName=@ViewBag.CurrentUserName&fromDate=@ViewBag.CurrentFromDate&toDate=@ViewBag.CurrentToDate">@i</a>
                                </li>
                            }

                            @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="?page=@(ViewBag.CurrentPage + 1)&activityType=@ViewBag.CurrentActivityType&module=@ViewBag.CurrentModule&userName=@ViewBag.CurrentUserName&fromDate=@ViewBag.CurrentFromDate&toDate=@ViewBag.CurrentToDate">»</a>
                                </li>
                            }
                            else
                            {
                                <li class="page-item disabled"><a class="page-link" href="#">»</a></li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Cards -->
        <div class="row">
            <!-- Recent Failed Logins -->
            <div class="col-md-6">
                <div class="card card-warning card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-exclamation-triangle"></i> Recent Failed Login Attempts
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Username</th>
                                        <th>IP Address</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-3">
                                            <small>No failed login attempts</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Most Active Users -->
            <div class="col-md-6">
                <div class="card card-success card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-users"></i> Most Active Users Today
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Activities</th>
                                        <th>Last Active</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-3">
                                            <small>No activity data available</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log Maintenance -->
        <div class="card card-danger card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-broom"></i> Log Maintenance
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Total Log Entries:</strong> @ViewBag.TotalLogEntries</p>
                        <p><strong>Oldest Entry:</strong> @ViewBag.OldestEntry</p>
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Warning:</strong> Clearing logs is permanent and cannot be undone.
                        </div>
                    </div>
                    <div class="col-md-6">
                        <form asp-action="ClearOldLogs" method="post" id="clearLogsForm">
                            @Html.AntiForgeryToken()
                            <div class="form-group">
                                <label>Clear logs older than:</label>
                                <div class="input-group">
                                    <select class="form-control" id="clearLogsDays" name="days">
                                        <option value="30">30 days</option>
                                        <option value="60">60 days</option>
                                        <option value="90">90 days</option>
                                        <option value="180">6 months</option>
                                        <option value="365">1 year</option>
                                    </select>
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-danger" onclick="clearOldLogs()">
                                            <i class="fas fa-trash"></i> Clear Old Logs
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        function resetFilters() {
            $('#filterForm')[0].reset();
            location.href = '/Admin/Logs';
        }

        function exportLogs() {
            // Get current filter values
            var activityType = $('select[name="activityType"]').val() || '';
            var module = $('select[name="module"]').val() || '';
            var userName = $('input[name="userName"]').val() || '';
            var fromDate = $('input[name="fromDate"]').val() || '';
            var toDate = $('input[name="toDate"]').val() || '';

            // Build export URL
            var url = '@Url.Action("ExportLogs", "Admin")' +
                      '?activityType=' + encodeURIComponent(activityType) +
                      '&module=' + encodeURIComponent(module) +
                      '&userName=' + encodeURIComponent(userName) +
                      '&fromDate=' + encodeURIComponent(fromDate) +
                      '&toDate=' + encodeURIComponent(toDate);

            // Trigger download
            window.location.href = url;
        }

        function clearOldLogs() {
            var days = $('#clearLogsDays').val();

            Swal.fire({
                title: 'Clear Old Logs?',
                html: `<p>Are you sure you want to delete all logs older than <strong>${days} days</strong>?</p>
                       <p class="text-danger">This action cannot be undone!</p>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '<i class="fas fa-trash"></i> Yes, Delete Logs',
                cancelButtonText: '<i class="fas fa-times"></i> Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#clearLogsForm').submit();
                }
            });
        }
    </script>
}
