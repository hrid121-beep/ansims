@model IMS.Application.DTOs.ItemDto
@{
    ViewData["Title"] = "Item Details";

    var currentStock = Model.CurrentStock ?? 0;
    var minimumStock = Model.MinimumStock ?? 0;

    var stockPercentage = minimumStock > 0
        ? (currentStock / minimumStock) * 100
        : (currentStock > 0 ? 100 : 0);

    var stockStatus = currentStock < minimumStock ? "danger" :
                      currentStock <= minimumStock * 1.5m ? "warning" : "success";

    var stockStatusText = currentStock < minimumStock ? "Critical" :
                          currentStock <= minimumStock * 1.5m ? "Low" : "Normal";
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>
                    <i class="fas fa-box text-primary"></i> Item Details
                    <small class="text-muted ml-2">@Model.ItemCode</small>
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Home</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Item")">Items</a></li>
                    <li class="breadcrumb-item active">Details</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-@stockStatus">
                    <div class="inner">
                        <h3>@currentStock <small style="font-size: 18px;">@Model.Unit</small></h3>
                        <p>Current Stock</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>@minimumStock <small style="font-size: 18px;">@Model.Unit</small></h3>
                        <p>Minimum Stock</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-@(Model.IsActive ? "success" : "danger")">
                    <div class="inner">
                        <h3>@(Model.IsActive ? "Active" : "Inactive")</h3>
                        <p>Status</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-@(Model.IsActive ? "check-circle" : "times-circle")"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-secondary">
                    <div class="inner">
                        <h3>@(Model.UnitPrice?.ToString("C") ?? "N/A")</h3>
                        <p>Unit Price</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card card-primary card-tabs">
                    <div class="card-header p-0 pt-1">
                        <ul class="nav nav-tabs" id="custom-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="overview-tab" data-toggle="pill" href="#overview" role="tab">
                                    <i class="fas fa-info-circle"></i> Overview
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="specification-tab" data-toggle="pill" href="#specification" role="tab">
                                    <i class="fas fa-list"></i> Specifications
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="inventory-tab" data-toggle="pill" href="#inventory" role="tab">
                                    <i class="fas fa-warehouse"></i> Inventory
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="history-tab" data-toggle="pill" href="#history" role="tab">
                                    <i class="fas fa-history"></i> History
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="custom-tabs-content">
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-12">
                                        <h4 class="text-primary mb-3">
                                            <i class="fas fa-box mr-2"></i>@Model.Name
                                        </h4>

                                        @if (!string.IsNullOrEmpty(Model.Description))
                                        {
                                            <div class="callout callout-info">
                                                <h5><i class="fas fa-info"></i> Description</h5>
                                                <p>@Model.Description</p>
                                            </div>
                                        }

                                        <div class="row">
                                            <div class="col-md-6">
                                                <dl>
                                                    <dt><i class="fas fa-barcode text-primary"></i> Item Code</dt>
                                                    <dd class="ml-3">
                                                        <span class="badge badge-secondary">@Model.ItemCode</span>
                                                    </dd>

                                                    <dt><i class="fas fa-cube text-info"></i> Type</dt>
                                                    <dd class="ml-3">
                                                        @if (Model.Type == IMS.Domain.Enums.ItemType.Expendable)
                                                        {
                                                            <span class="badge badge-warning">
                                                                <i class="fas fa-recycle"></i> Expendable
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge badge-primary">
                                                                <i class="fas fa-tools"></i> Non-Expendable
                                                            </span>
                                                        }
                                                    </dd>

                                                    <dt><i class="fas fa-layer-group text-success"></i> Category</dt>
                                                    <dd class="ml-3">
                                                        <span class="badge badge-info">@Model.CategoryName</span>
                                                        @if (!string.IsNullOrEmpty(Model.SubCategoryName))
                                                        {
                                                            <i class="fas fa-chevron-right mx-1"></i>
                                                            <span class="badge badge-secondary">@Model.SubCategoryName</span>
                                                        }
                                                    </dd>
                                                </dl>
                                            </div>
                                            <div class="col-md-6">
                                                <dl>
                                                    <dt><i class="fas fa-award text-warning"></i> Brand</dt>
                                                    <dd class="ml-3">@(Model.BrandName ?? "N/A")</dd>

                                                    <dt><i class="fas fa-cogs text-secondary"></i> Model</dt>
                                                    <dd class="ml-3">@(Model.ModelName ?? "N/A")</dd>

                                                    <dt><i class="fas fa-balance-scale text-danger"></i> Unit</dt>
                                                    <dd class="ml-3">
                                                        <span class="badge badge-dark">@Model.Unit</span>
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="specification" role="tabpanel">
                                <table class="table table-sm table-striped">
                                    <tbody>
                                        <tr>
                                            <td width="40%"><strong>Item Code</strong></td>
                                            <td>@Model.ItemCode</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Name</strong></td>
                                            <td>@Model.Name</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Type</strong></td>
                                            <td>@Model.Type</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Category</strong></td>
                                            <td>@Model.CategoryName</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Sub Category</strong></td>
                                            <td>@(Model.SubCategoryName ?? "N/A")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Brand</strong></td>
                                            <td>@(Model.BrandName ?? "N/A")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Model</strong></td>
                                            <td>@(Model.ModelName ?? "N/A")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Unit of Measurement</strong></td>
                                            <td>@Model.Unit</td>
                                        </tr>
                                        @if (!string.IsNullOrEmpty(Model.Manufacturer))
                                        {
                                            <tr>
                                                <td><strong>Manufacturer</strong></td>
                                                <td>@Model.Manufacturer</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrEmpty(Model.Material))
                                        {
                                            <tr>
                                                <td><strong>Material</strong></td>
                                                <td>@Model.Material</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrEmpty(Model.Color))
                                        {
                                            <tr>
                                                <td><strong>Color</strong></td>
                                                <td>@Model.Color</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <div class="tab-pane fade" id="inventory" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="info-box bg-@stockStatus">
                                            <span class="info-box-icon"><i class="fas fa-chart-line"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Stock Level</span>
                                                <span class="info-box-number">@currentStock @Model.Unit</span>
                                                <div class="progress">
                                                    @{
                                                        var percentage = minimumStock > 0
                                                        ? (int)((currentStock / minimumStock) * 100)
                                                        : (currentStock > 0 ? 100 : 0);
                                                        percentage = Math.Min(percentage, 100);
                                                    }
                                                    <div class="progress-bar" style="width: @percentage%"></div>
                                                </div>
                                                <span class="progress-description">
                                                    @stockStatusText - @((int)stockPercentage)% of minimum
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-box bg-info">
                                            <span class="info-box-icon"><i class="fas fa-dollar-sign"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Total Value</span>
                                                <span class="info-box-number">
                                                    @if (Model.UnitPrice.HasValue)
                                                    {
                                                        @string.Format("{0:C}", currentStock * Model.UnitPrice.Value)
                                                    }
                                                    else
                                                    {
                                                        <text>N/A</text>
                                                    }
                                                </span>
                                                <span class="progress-description">
                                                    Unit Price: @(Model.UnitPrice?.ToString("C") ?? "Not Set")
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <table class="table table-bordered">
                                            <thead class="bg-light">
                                                <tr>
                                                    <th>Metric</th>
                                                    <th>Value</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><i class="fas fa-boxes text-primary"></i> Current Stock</td>
                                                    <td><strong>@currentStock @Model.Unit</strong></td>
                                                    <td>
                                                        <span class="badge badge-@stockStatus">@stockStatusText</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-exclamation-triangle text-warning"></i> Minimum Stock</td>
                                                    <td>@minimumStock @Model.Unit</td>
                                                    <td>
                                                        @if (currentStock >= minimumStock)
                                                        {
                                                            <span class="badge badge-success">Above Minimum</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge badge-danger">Below Minimum</span>
                                                        }
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-money-bill text-success"></i> Unit Price</td>
                                                    <td>@(Model.UnitPrice?.ToString("C") ?? "Not Set")</td>
                                                    <td>-</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="history" role="tabpanel">
                                <div class="timeline">
                                    <div class="time-label">
                                        <span class="bg-primary">@Model.CreatedAt.ToString("dd MMM yyyy")</span>
                                    </div>
                                    <div>
                                        <i class="fas fa-plus bg-success"></i>
                                        <div class="timeline-item">
                                            <span class="time"><i class="fas fa-clock"></i> @Model.CreatedAt.ToString("HH:mm")</span>
                                            <h3 class="timeline-header">Item Created</h3>
                                            <div class="timeline-body">
                                                Item was created by <strong>@(Model.CreatedBy ?? "System")</strong>
                                            </div>
                                        </div>
                                    </div>

                                    @if (Model.UpdatedAt.HasValue)
                                    {
                                        <div class="time-label">
                                            <span class="bg-warning">@Model.UpdatedAt.Value.ToString("dd MMM yyyy")</span>
                                        </div>
                                        <div>
                                            <i class="fas fa-edit bg-warning"></i>
                                            <div class="timeline-item">
                                                <span class="time"><i class="fas fa-clock"></i> @Model.UpdatedAt.Value.ToString("HH:mm")</span>
                                                <h3 class="timeline-header">Item Updated</h3>
                                                <div class="timeline-body">
                                                    Last modified by <strong>@(Model.UpdatedBy ?? "System")</strong>
                                                </div>
                                            </div>
                                        </div>
                                    }

                                    <div>
                                        <i class="fas fa-clock bg-gray"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-barcode"></i> Item Identification
                        </h3>
                    </div>
                    <div class="card-body text-center">
                        <div id="itemImage" class="mb-3">
                            @if (!string.IsNullOrEmpty(Model.ImagePath))
                            {
                                <img src="/@Model.ImagePath" alt="@Model.Name" class="img-fluid rounded shadow" style="max-width: 120px; max-height: 120px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="img-circle bg-gradient-primary d-inline-flex align-items-center justify-content-center" style="width: 120px; height: 120px;">
                                    <i class="fas fa-box fa-4x text-white"></i>
                                </div>
                            }
                        </div>

                        <h5 class="text-bold">@Model.Name</h5>
                        <p class="text-muted">@Model.ItemCode</p>

                        <div id="barcodeContainer" class="mt-3 mb-3">
                            <a href="@Url.Action("Generate", "Barcode", new { itemId = Model.Id })" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-barcode"></i> Generate Barcode
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card card-success card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bolt"></i> Quick Actions
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="showStockAdjustment()">
                                <i class="fas fa-plus-minus text-primary"></i> Adjust Stock
                            </a>
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="list-group-item list-group-item-action">
                                <i class="fas fa-edit text-warning"></i> Edit Item
                            </a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="duplicateItem(@Model.Id)">
                                <i class="fas fa-copy text-info"></i> Duplicate Item
                            </a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="printItemLabel(@Model.Id)">
                                <i class="fas fa-tag text-secondary"></i> Print Label
                            </a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action text-danger" onclick="confirmDelete(@Model.Id)">
                                <i class="fas fa-trash"></i> Delete Item
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card card-secondary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-info-circle"></i> Audit Information
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><i class="fas fa-calendar-plus text-success"></i> Created</td>
                                    <td class="text-right">@Model.CreatedAt.ToString("dd MMM yyyy")</td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-user-plus text-info"></i> Created By</td>
                                    <td class="text-right">@(Model.CreatedBy ?? "System")</td>
                                </tr>
                                @if (Model.UpdatedAt.HasValue)
                                {
                                    <tr>
                                        <td><i class="fas fa-calendar-check text-warning"></i> Updated</td>
                                        <td class="text-right">@Model.UpdatedAt.Value.ToString("dd MMM yyyy")</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-user-edit text-primary"></i> Updated By</td>
                                        <td class="text-right">@(Model.UpdatedBy ?? "System")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                            <i class="fas fa-edit"></i> Edit Item
                        </a>
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </a>
                        <button class="btn btn-info" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="stockAdjustmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary">
                <h5 class="modal-title">
                    <i class="fas fa-plus-minus"></i> Stock Adjustment
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="info-box bg-info">
                    <span class="info-box-icon"><i class="fas fa-box"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">@Model.Name</span>
                        <span class="info-box-number">Current: @currentStock @Model.Unit</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Adjustment Type</label>
                    <select class="form-control" id="adjustmentType">
                        <option value="Add">Add Stock (+)</option>
                        <option value="Remove">Remove Stock (-)</option>
                        <option value="Set">Set Stock (=)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quantity</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="adjustQuantity" min="0" step="0.01" required>
                        <div class="input-group-append">
                            <span class="input-group-text">@Model.Unit</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Reason</label>
                    <textarea class="form-control" id="adjustReason" rows="3" required placeholder="Enter reason for adjustment..."></textarea>
                </div>

                <div class="alert alert-warning" id="newStockAlert" style="display:none;">
                    <i class="fas fa-info-circle"></i> New Stock: <strong><span id="newStockValue"></span> @Model.Unit</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitStockAdjustment()">
                    <i class="fas fa-save"></i> Apply Adjustment
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var currentStock = @currentStock;

        $(document).ready(function() {
            $('#adjustmentType, #adjustQuantity').on('change keyup', function() {
                var type = $('#adjustmentType').val();
                var quantity = parseFloat($('#adjustQuantity').val()) || 0;
                var newStock = 0;

                switch(type) {
                    case 'Add':
                        newStock = currentStock + quantity;
                        break;
                    case 'Remove':
                        newStock = Math.max(0, currentStock - quantity);
                        break;
                    case 'Set':
                        newStock = quantity;
                        break;
                }

                if (quantity > 0) {
                    $('#newStockValue').text(newStock.toFixed(2));
                    $('#newStockAlert').slideDown();
                } else {
                    $('#newStockAlert').slideUp();
                }
            });
        });

        function showStockAdjustment() {
            $('#stockAdjustmentModal').modal('show');
        }

        function submitStockAdjustment() {
            var type = $('#adjustmentType').val();
            var quantity = parseFloat($('#adjustQuantity').val());
            var reason = $('#adjustReason').val().trim();

            if (!quantity || quantity <= 0) {
                toastr.error('Please enter a valid quantity');
                return;
            }

            if (!reason) {
                toastr.error('Please enter a reason for adjustment');
                return;
            }

            toastr.info('Stock adjustment feature requires backend implementation');
            $('#stockAdjustmentModal').modal('hide');
        }

        function duplicateItem(itemId) {
            Swal.fire({
                title: 'Duplicate Item?',
                text: "This will create a copy of this item",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, duplicate it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '@Url.Action("Create", "Item")?duplicateFrom=' + itemId;
                }
            });
        }

        function confirmDelete(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This action cannot be undone!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    var form = $('<form>', {
                        'method': 'POST',
                        'action': '@Url.Action("Delete", "Item")/' + id
                    });

                    var token = $('<input>', {
                        'type': 'hidden',
                        'name': '__RequestVerificationToken',
                        'value': $('input[name="__RequestVerificationToken"]').first().val()
                    });

                    form.append(token);
                    $('body').append(form);
                    form.submit();
                }
            });
        }

        function printItemLabel(itemId) {
            window.open('@Url.Action("Print", "Barcode")?itemId=' + itemId, '_blank');
        }
    </script>

    <style>
        .timeline {
            position: relative;
            padding: 21px 0 10px;
            margin-top: 4px;
            margin-bottom: 30px;
        }

            .timeline .timeline-item {
                position: relative;
                margin: 10px 0 10px 60px;
                clear: both;
            }

                .timeline .timeline-item .timeline-header {
                    margin-top: 0;
                    color: inherit;
                    font-weight: bold;
                }

        .time-label {
            display: block;
            margin-left: 60px;
            padding: 5px;
        }

        @@media print {
            .main-sidebar, .main-header, .modal, .btn, .card-tools {
                display: none !important;
            }
        }
    </style>
}