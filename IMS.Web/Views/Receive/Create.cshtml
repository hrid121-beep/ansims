@model IMS.Application.DTOs.ReceiveDto
@{
    ViewData["Title"] = "Create Receive";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Create Receive</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Receives</a></li>
                    <li class="breadcrumb-item active">Create</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <form asp-action="Create" method="post" id="receiveForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <div class="row">
                <div class="col-md-8">
                    <!-- Basic Information -->
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Receive Information</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" onclick="scanVoucherModal()">
                                    <i class="fas fa-qrcode"></i> Scan Issue Voucher
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="ReceiveNo">Receive No <span class="text-danger">*</span></label>
                                        <input asp-for="ReceiveNo" class="form-control" readonly value="@ViewBag.ReceiveNo" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="ReceiveDate">Receive Date <span class="text-danger">*</span></label>
                                        <input asp-for="ReceiveDate" type="date" class="form-control" required />
                                        <span asp-validation-for="ReceiveDate" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="StoreId">Receiving Store <span class="text-danger">*</span></label>
                                        <select asp-for="StoreId" asp-items="ViewBag.Stores" class="form-control" required>
                                            <option value="">Select Store</option>
                                        </select>
                                        <span asp-validation-for="StoreId" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="ReceiveType">Receive From Type <span class="text-danger">*</span></label>
                                        <select asp-for="ReceiveType" asp-items="ViewBag.ReceiveTypes"
                                                class="form-control" id="receiveType" required>
                                            <option value="">Select Type</option>
                                        </select>
                                        <span asp-validation-for="ReceiveType" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="OriginalIssueId">Linked Issue (Optional)</label>
                                        <div class="input-group">
                                            <input type="hidden" asp-for="OriginalIssueId" id="originalIssueId" />
                                            <input type="text" id="originalIssueNo" class="form-control"
                                                   placeholder="Issue number (if receiving against issue)" readonly />
                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-info" onclick="searchIssue()">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dynamic source selection based on type -->
                            <div id="battalionSection" class="source-section" style="display:none;">
                                <div class="form-group">
                                    <label>Battalion <span class="text-danger">*</span></label>
                                    <select asp-for="ReceivedFromBattalionId" asp-items="ViewBag.Battalions"
                                            class="form-control select2">
                                        <option value="">Select Battalion</option>
                                    </select>
                                    <span asp-validation-for="ReceivedFromBattalionId" class="text-danger"></span>
                                </div>
                            </div>

                            <div id="rangeSection" class="source-section" style="display:none;">
                                <div class="form-group">
                                    <label>Range <span class="text-danger">*</span></label>
                                    <select asp-for="ReceivedFromRangeId" asp-items="ViewBag.Ranges"
                                            class="form-control select2">
                                        <option value="">Select Range</option>
                                    </select>
                                    <span asp-validation-for="ReceivedFromRangeId" class="text-danger"></span>
                                </div>
                            </div>

                            <div id="zilaSection" class="source-section" style="display:none;">
                                <div class="form-group">
                                    <label>Zila <span class="text-danger">*</span></label>
                                    <select asp-for="ReceivedFromZilaId" asp-items="ViewBag.Zilas"
                                            class="form-control select2">
                                        <option value="">Select Zila</option>
                                    </select>
                                    <span asp-validation-for="ReceivedFromZilaId" class="text-danger"></span>
                                </div>
                            </div>

                            <div id="upazilaSection" class="source-section" style="display:none;">
                                <div class="form-group">
                                    <label>Upazila <span class="text-danger">*</span></label>
                                    <select asp-for="ReceivedFromUpazilaId" asp-items="ViewBag.Upazilas"
                                            class="form-control select2">
                                        <option value="">Select Upazila</option>
                                    </select>
                                    <span asp-validation-for="ReceivedFromUpazilaId" class="text-danger"></span>
                                </div>
                            </div>

                            <div id="individualSection" class="source-section" style="display:none;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Individual Name <span class="text-danger">*</span></label>
                                            <input asp-for="ReceivedFromIndividualName" class="form-control" />
                                            <span asp-validation-for="ReceivedFromIndividualName" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Badge No <span class="text-danger">*</span></label>
                                            <input asp-for="ReceivedFromIndividualBadgeNo" class="form-control" />
                                            <span asp-validation-for="ReceivedFromIndividualBadgeNo" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Mobile</label>
                                            <input type="text" name="ReceivedFromIndividualMobile" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="externalSection" class="source-section" style="display:none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>External Source Name <span class="text-danger">*</span></label>
                                            <input type="text" name="ExternalSourceName" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Contact Information</label>
                                            <input type="text" name="ExternalContact" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="OverallCondition">Overall Condition</label>
                                        <select asp-for="OverallCondition" asp-items="ViewBag.Conditions"
                                                class="form-control">
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Status</label>
                                        <input asp-for="Status" class="form-control" value="Pending" readonly />
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label asp-for="Remarks">Remarks</label>
                                <textarea asp-for="Remarks" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-boxes"></i> Receive Items
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-default" id="scanBarcodeBtn">
                                    <i class="fas fa-barcode"></i> Scan Barcode
                                </button>
                                <button type="button" class="btn btn-sm btn-primary" id="addItemBtn">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Barcode Scanner Section -->
                            <div id="barcodeSection" style="display: none;" class="mb-3">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                    </div>
                                    <input type="text" id="barcodeInput" class="form-control"
                                           placeholder="Scan or enter barcode" />
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-primary" id="processBarcodeBtn">
                                            Process
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered table-sm" id="itemsTable">
                                    <thead class="bg-light">
                                        <tr>
                                            <th width="3%">#</th>
                                            <th width="18%">ITEM CODE/NAME</th>
                                            <th width="10%">CATEGORY</th>
                                            <th width="8%">CURRENT STOCK</th>
                                            <th width="8%">RECEIVE QTY</th>
                                            <th width="6%">UNIT</th>
                                            <th width="8%">BATCH NO</th>
                                            <th width="6%">LEDGER NO</th>
                                            <th width="6%">PAGE NO</th>
                                            <th width="8%">USABLE</th>
                                            <th width="8%">PARTIAL</th>
                                            <th width="8%">UNUSABLE</th>
                                            <th width="3%">ACTION</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemsContainer">
                                        <!-- Items will be added dynamically -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="4" class="text-right"><strong>Total Items:</strong></td>
                                            <td id="totalItems" class="text-center font-weight-bold">0</td>
                                            <td colspan="8"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Voucher Document Upload -->
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-file-upload"></i> Voucher Document
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="voucherDocument">Upload Supporting Document</label>
                                <div class="input-group">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="voucherDocument"
                                               name="voucherDocument" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                        <label class="custom-file-label" for="voucherDocument">Choose file</label>
                                    </div>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Upload return voucher, gate pass, or authorization document. Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max 5MB)
                                </small>
                                <div id="voucherPreview" class="mt-2" style="display: none;">
                                    <img id="voucherPreviewImage" src="" alt="Preview"
                                         style="max-width: 200px; max-height: 200px;" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Signature Section -->
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">Receiver Information</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Receiver Name</label>
                                        <input asp-for="ReceiverName" class="form-control"
                                               value="@User.Identity.Name" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Receiver Badge No</label>
                                        <input asp-for="ReceiverBadgeNo" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Receiver Designation</label>
                                        <input asp-for="ReceiverDesignation" class="form-control" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Digital Signature</label>
                                <div class="border p-2">
                                    <canvas id="signatureCanvas" width="700" height="150" style="border: 1px solid #ddd; width: 100%; max-width: 700px;"></canvas>
                                    <input type="hidden" asp-for="ReceiverSignature" id="signatureData" />
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-secondary" id="clearSignature">
                                            <i class="fas fa-eraser"></i> Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Actions -->
                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title">Actions</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Assessment Notes</label>
                                <textarea asp-for="AssessmentNotes" class="form-control" rows="3"
                                          placeholder="Enter any assessment notes..."></textarea>
                            </div>

                            <button type="submit" name="action" value="save" class="btn btn-primary btn-block">
                                <i class="fas fa-save"></i> Save as Draft
                            </button>
                            <button type="submit" name="action" value="complete" class="btn btn-success btn-block">
                                <i class="fas fa-check"></i> Complete Receive
                            </button>
                            <a asp-action="Index" class="btn btn-default btn-block">Cancel</a>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">Summary</h3>
                        </div>
                        <div class="card-body">
                            <div class="info-box bg-info">
                                <span class="info-box-icon"><i class="fas fa-boxes"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Total Items</span>
                                    <span class="info-box-number" id="itemCount">0</span>
                                </div>
                            </div>
                            <div class="info-box bg-success">
                                <span class="info-box-icon"><i class="fas fa-check"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Good Condition</span>
                                    <span class="info-box-number" id="goodCount">0</span>
                                </div>
                            </div>
                            <div class="info-box bg-warning">
                                <span class="info-box-icon"><i class="fas fa-exclamation"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Damaged</span>
                                    <span class="info-box-number" id="damagedCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="card card-info collapsed-card">
                        <div class="card-header">
                            <h3 class="card-title">Instructions</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Select receive type and source</li>
                                <li><i class="fas fa-check text-success"></i> Add items to receive</li>
                                <li><i class="fas fa-check text-success"></i> Specify condition for each item</li>
                                <li><i class="fas fa-check text-success"></i> Damaged items will be recorded</li>
                                <li><i class="fas fa-check text-success"></i> Stock updates automatically</li>
                                <li><i class="fas fa-info text-info"></i> Use scan for barcode input</li>
                                <li><i class="fas fa-info text-info"></i> Signature required for completion</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Issue Search Modal -->
<div class="modal fade" id="issueSearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search Approved Issues</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="issueSearchInput" class="form-control mb-3"
                       placeholder="Search by issue number...">
                <div id="issueSearchResults"></div>
            </div>
        </div>
    </div>
</div>

<!-- Item Selection Modal -->
<div class="modal fade" id="itemModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Item</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="input-group">
                        <input type="text" id="itemSearch" class="form-control"
                               placeholder="Search by name or code..." />
                        <div class="input-group-append">
                            <button type="button" class="btn btn-primary" id="searchItemsBtn">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Unit</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsList">
                            <tr>
                                <td colspan="6" class="text-center">Select a store first to view items</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Select2 -->
    <script src="~/adminlte/plugins/select2/js/select2.full.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Toastr -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        let itemIndex = 0;
        let signaturePad;
        let selectedItems = [];
        window.storeItems = [];

        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4'
            });

            // Initialize signature pad
            initSignaturePad();

            // Set today's date as default
            if (!$('#ReceiveDate').val()) {
                $('#ReceiveDate').val(new Date().toISOString().split('T')[0]);
            }

            // ==================== Item Modal Handlers ====================
            $('#addItemBtn').click(function() {
                const storeId = $('#StoreId').val();
                if (!storeId) {
                    toastr.warning('Please select a receiving store first', 'Store Required');
                    return;
                }
                loadStoreItems(storeId);
                $('#itemModal').modal('show');
            });

            $('#searchItemsBtn').click(function() {
                const storeId = $('#StoreId').val();
                if (storeId) {
                    loadStoreItems(storeId);
                }
            });

            $('#itemSearch').on('keyup', function(e) {
                if (e.key === 'Enter') {
                    $('#searchItemsBtn').click();
                }
            });

            // ==================== Barcode Scanner Handlers ====================
            $('#scanBarcodeBtn').click(function() {
                const storeId = $('#StoreId').val();
                if (!storeId) {
                    toastr.warning('Please select a receiving store first', 'Store Required');
                    return;
                }
                $('#barcodeSection').slideToggle();
                $('#barcodeInput').focus();
            });

            $('#processBarcodeBtn').click(function() {
                processBarcode();
            });

            $('#barcodeInput').on('keyup', function(e) {
                if (e.key === 'Enter') {
                    processBarcode();
                }
            });

            // ==================== Item Selection Handler ====================
            $(document).on('click', '.select-item:not(:disabled)', function() {
                const item = $(this).data('item');
                if (item) {
                    addItemToTable(item);
                    $(this).prop('disabled', true)
                           .removeClass('btn-primary')
                           .addClass('btn-secondary')
                           .html('Already Added');

                    if (!event.shiftKey) {
                        $('#itemModal').modal('hide');
                    }
                }
            });

            // ==================== Remove Item Handler ====================
            $(document).on('click', '.remove-item', function() {
                const row = $(this).closest('tr');
                const itemId = row.attr('id').replace('item_', '');
                const itemIdValue = row.find('input[name*=".ItemId"]').val();

                row.remove();
                selectedItems = selectedItems.filter(id => id != itemIdValue);

                // Re-enable item in modal
                $(`.select-item[data-item-id="${itemIdValue}"]`)
                    .prop('disabled', false)
                    .removeClass('btn-secondary')
                    .addClass('btn-primary')
                    .html('<i class="fas fa-plus"></i> Select');

                updateSummary();
                toastr.info('Item removed', '', {timeOut: 1500, positionClass: 'toast-bottom-right'});
            });

            // ==================== Ledger Book Management ====================
            // Load ledger books when store is selected
            $('#StoreId').on('change', function() {
                const storeId = $(this).val();
                if (!storeId) {
                    // Clear all ledger book dropdowns if no store selected
                    $('.ledger-book-select').empty().append('<option value="">Select Ledger</option>');
                    $('.page-no-field').val('');
                    return;
                }

                // Load ledger books for this store with bookType = 'Receive'
                $.ajax({
                    url: '/LedgerBook/GetActiveLedgerBooks',
                    type: 'GET',
                    data: {
                        storeId: storeId,
                        bookType: 'Receive'
                    },
                    success: function(ledgerBooks) {
                        // Update all existing ledger book dropdowns
                        $('.ledger-book-select').each(function() {
                            const select = $(this);
                            const currentValue = select.val();

                            select.empty();
                            select.append('<option value="">Select Ledger</option>');

                            ledgerBooks.forEach(function(book) {
                                let status = '';
                                if (book.pagesRemaining <= 10) {
                                    status = '⚠️ Almost Full';
                                } else if (book.pagesRemaining <= 50) {
                                    status = '⏰ Low';
                                }

                                select.append(`<option value="${book.id}"
                                                      data-ledger-no="${book.ledgerNo}"
                                                      data-next-page="${book.currentPageNo}">
                                                   ${book.ledgerNo} - Page: ${book.currentPageNo} ${status}
                                               </option>`);
                            });

                            // Restore previous selection if it exists
                            if (currentValue) {
                                select.val(currentValue);
                            }
                        });

                        if (ledgerBooks.length === 0) {
                            toastr.warning('No active ledger books found for this store. Please create one first.', 'Warning', {
                                timeOut: 5000
                            });
                        }
                    },
                    error: function() {
                        toastr.error('Failed to load ledger books', 'Error');
                    }
                });
            });

            // Auto-load ledger books if store is already selected on page load
            if ($('#StoreId').val()) {
                $('#StoreId').trigger('change');
            }
        });

        function initSignaturePad() {
            const canvas = document.getElementById('signatureCanvas');
            if (canvas && typeof SignaturePad !== 'undefined') {
                // Resize canvas to match display size
                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    const width = canvas.offsetWidth;
                    const height = canvas.offsetHeight;
                    canvas.width = width * ratio;
                    canvas.height = height * ratio;
                    canvas.getContext('2d').scale(ratio, ratio);
                    if (signaturePad) {
                        signaturePad.clear(); // Clear after resize
                    }
                }

                resizeCanvas();

                signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)',
                    minWidth: 0.5,
                    maxWidth: 2.5
                });

                // Clear signature button
                $('#clearSignature').click(function() {
                    if (signaturePad) {
                        signaturePad.clear();
                        $('#signatureData').val('');
                    }
                });

                // Save signature data on mouse/touch end
                const saveSignature = function() {
                    if (signaturePad && !signaturePad.isEmpty()) {
                        $('#signatureData').val(signaturePad.toDataURL());
                    }
                };

                canvas.addEventListener('mouseup', saveSignature);
                canvas.addEventListener('touchend', saveSignature);

                // Handle window resize
                window.addEventListener('resize', function() {
                    resizeCanvas();
                });
            } else {
                console.error('SignaturePad library not loaded or canvas not found');
            }
        }

        function addItem() {
            const rowNumber = itemIndex + 1;
            const row = `
                <tr id="item_${itemIndex}" class="item-row">
                    <td>${rowNumber}</td>
                    <td>
                        <select name="Items[${itemIndex}].ItemId" class="form-control form-control-sm item-select select2"
                                onchange="updateSummary()" required>
                            <option value="">Select Item</option>
                            @foreach (var item in ViewBag.Items)
                            {
                                    <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </td>
                    <td>
                        <select name="Items[${itemIndex}].StoreId" class="form-control form-control-sm store-select" required>
                            <option value="">Select Store</option>
                            @foreach (var store in ViewBag.Stores)
                            {
                                    <option value="@store.Value">@store.Text</option>
                            }
                        </select>
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].Quantity"
                               class="form-control form-control-sm quantity-input"
                               min="0.01" step="0.01" onchange="updateSummary()" required />
                    </td>
                    <td>
                        <select name="Items[${itemIndex}].Condition"
                                class="form-control form-control-sm condition-select"
                                onchange="updateSummary()">
                            <option value="Good">Good</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Expired">Expired</option>
                        </select>
                    </td>
                    <td>
                        <select name="Items[${itemIndex}].LedgerBookId"
                                class="form-control form-control-sm ledger-book-select"
                                data-item-index="${itemIndex}"
                                onchange="updatePageNumber(this)">
                            <option value="">Select Ledger</option>
                        </select>
                        <input type="hidden" name="Items[${itemIndex}].LedgerNo" class="ledger-no-hidden" />
                    </td>
                    <td>
                        <input type="text" name="Items[${itemIndex}].PageNo"
                               class="form-control form-control-sm page-no-field"
                               placeholder="Page" readonly />
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].UsableQuantity"
                               class="form-control form-control-sm"
                               min="0" step="0.01" placeholder="Usable" />
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].PartiallyUsableQuantity"
                               class="form-control form-control-sm"
                               min="0" step="0.01" placeholder="Partial" />
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].UnusableQuantity"
                               class="form-control form-control-sm"
                               min="0" step="0.01" placeholder="Unusable" />
                    </td>
                    <td>
                        <input type="text" name="Items[${itemIndex}].Remarks"
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm"
                                onclick="removeItem('item_${itemIndex}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            $('#itemsBody').append(row);

            // Reinitialize Select2 for new elements
            $(`#item_${itemIndex} .select2`).select2({
                theme: 'bootstrap4',
                width: '100%'
            });

            // Set default store if only one exists
            const storeSelect = $(`#item_${itemIndex} .store-select`);
            if (storeSelect.find('option').length === 2) {
                storeSelect.prop('selectedIndex', 1);
            }

            itemIndex++;
            updateSummary();
        }

        function removeItem(rowId) {
            $('#' + rowId).remove();
            updateRowNumbers();
            updateSummary();
        }

        function updateRowNumbers() {
            let rowNum = 1;
            $('.item-row').each(function() {
                $(this).find('td:first').text(rowNum++);
            });
        }

        function updateSummary() {
            let totalQuantity = 0;
            let goodCount = 0;
            let damagedCount = 0;
            let itemCount = 0;

            $('.item-row').each(function() {
                const qty = parseFloat($(this).find('.quantity-input').val()) || 0;
                const condition = $(this).find('.condition-select').val();

                if (qty > 0) {
                    totalQuantity += qty;
                    itemCount++;

                    switch(condition) {
                        case 'Good':
                            goodCount++;
                            break;
                        case 'Damaged':
                            damagedCount++;
                            break;
                    }
                }
            });

            $('#totalQuantity').text(totalQuantity.toFixed(2));
            $('#itemCount').text(itemCount);
            $('#goodCount').text(goodCount);
            $('#damagedCount').text(damagedCount);
        }

        // ==================== Load Store Items (for modal) ====================
        function loadStoreItems(storeId) {
            const searchTerm = $('#itemSearch').val() || '';

            $.ajax({
                url: '/Store/GetStoreItems',
                type: 'GET',
                data: { storeId: storeId, searchTerm: searchTerm },
                beforeSend: function() {
                    $('#itemsList').html('<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>');
                },
                success: function(items) {
                    const tbody = $('#itemsList');
                    tbody.empty();

                    if (!items || items.length === 0) {
                        tbody.append('<tr><td colspan="6" class="text-center">No items found</td></tr>');
                        return;
                    }

                    window.storeItems = items;
                    items.forEach(function(item) {
                        tbody.append(createItemRow(item));
                    });
                },
                error: function(xhr) {
                    $('#itemsList').html('<tr><td colspan="6" class="text-center text-danger">Error loading items</td></tr>');
                }
            });
        }

        function createItemRow(item) {
            const stockClass = item.quantity <= 0 ? 'text-danger font-weight-bold' :
                             item.quantity <= (item.minimumStock || 0) ? 'text-warning font-weight-bold' :
                             'text-success';

            const isDisabled = selectedItems.includes(item.itemId);
            const buttonClass = isDisabled ? 'btn-secondary' : 'btn-primary';
            const buttonText = isDisabled ? 'Already Added' : '<i class="fas fa-plus"></i> Select';

            return `
                <tr data-item-id="${item.itemId}">
                    <td><strong>${item.itemCode || item.code || '-'}</strong></td>
                    <td>${item.itemName || item.name || '-'}</td>
                    <td>${item.categoryName || '-'}</td>
                    <td class="${stockClass}">${item.quantity || 0} ${item.unit || ''}</td>
                    <td>${item.unit || '-'}</td>
                    <td>
                        <button type="button" class="btn btn-sm ${buttonClass} select-item"
                                data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}'
                                ${isDisabled ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </td>
                </tr>
            `;
        }

        // ==================== Add Item to Table (modal-based) ====================
        function addItemToTable(item) {
            if (selectedItems.includes(item.itemId)) {
                toastr.info('Item already added', '', {timeOut: 1500});
                return;
            }

            const stockValue = item.currentStock || item.quantity || 0;
            const storeId = $('#StoreId').val();

            const row = `
                <tr id="item_${item.itemId}" class="item-row">
                    <td class="text-center">${itemIndex + 1}</td>
                    <td>
                        <input type="hidden" name="Items[${itemIndex}].ItemId" value="${item.itemId}" />
                        <input type="hidden" name="Items[${itemIndex}].StoreId" value="${storeId}" />
                        <strong>${item.itemCode || item.code || '-'}</strong><br/>
                        <small class="text-muted">${item.itemName || item.name || '-'}</small>
                    </td>
                    <td>${item.categoryName || '-'}</td>
                    <td class="text-success">
                        ${stockValue} ${item.unit || ''}
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].Quantity"
                               class="form-control form-control-sm item-quantity"
                               min="0.01" step="0.01"
                               value="1" required />
                    </td>
                    <td>${item.unit || '-'}
                        <input type="hidden" name="Items[${itemIndex}].Unit" value="${item.unit || ''}" />
                    </td>
                    <td>
                        <input type="text" name="Items[${itemIndex}].BatchNumber"
                               class="form-control form-control-sm"
                               value="${item.batchNumber || ''}" placeholder="Batch No" />
                    </td>
                    <td>
                        <select name="Items[${itemIndex}].LedgerBookId"
                                class="form-control form-control-sm ledger-book-select"
                                data-item-index="${itemIndex}"
                                onchange="updatePageNumber(this)">
                            <option value="">Select Ledger</option>
                        </select>
                        <input type="hidden" name="Items[${itemIndex}].LedgerNo" class="ledger-no-hidden" />
                    </td>
                    <td>
                        <input type="text" name="Items[${itemIndex}].PageNo"
                               class="form-control form-control-sm page-no-field"
                               placeholder="Page" readonly />
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].UsableQuantity"
                               class="form-control form-control-sm"
                               min="0" step="0.01" placeholder="Usable" />
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].PartiallyUsableQuantity"
                               class="form-control form-control-sm"
                               min="0" step="0.01" placeholder="Partial" />
                    </td>
                    <td>
                        <input type="number" name="Items[${itemIndex}].UnusableQuantity"
                               class="form-control form-control-sm"
                               min="0" step="0.01" placeholder="Unusable" />
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-danger remove-item" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

            $('#itemsContainer').append(row);
            selectedItems.push(item.itemId);

            // Populate ledger dropdown
            const newLedgerDropdown = $(`#item_${item.itemId}`).find('.ledger-book-select');
            if (newLedgerDropdown.length > 0) {
                populateLedgerDropdown(newLedgerDropdown[0]);
            }

            itemIndex++;
            updateSummary();

            toastr.success(`${item.itemName || item.name} added`, 'Item Added', {
                timeOut: 1500,
                positionClass: 'toast-bottom-right'
            });
        }

        // ==================== Process Barcode ====================
        function processBarcode() {
            const barcode = $('#barcodeInput').val().trim();
            if (!barcode) {
                toastr.warning('Please enter a barcode', 'Barcode Required');
                return;
            }

            const item = window.storeItems.find(i => i.barcode === barcode || i.itemCode === barcode || i.code === barcode);

            if (item) {
                addItemToTable(item);
                $('#barcodeInput').val('').focus();
                toastr.success('Item added via barcode', '', {timeOut: 1500, positionClass: 'toast-bottom-right'});
            } else {
                toastr.error('Item not found with this barcode', 'Not Found');
                $('#barcodeInput').select();
            }
        }

        // ==================== Populate Ledger Dropdown ====================
        function populateLedgerDropdown(selectElement) {
            const storeId = $('#StoreId').val();
            if (!storeId) return;

            $.ajax({
                url: '/LedgerBook/GetActiveLedgerBooks',
                type: 'GET',
                data: {
                    storeId: storeId,
                    bookType: 'Receive'
                },
                success: function(ledgerBooks) {
                    const $select = $(selectElement);
                    $select.empty();
                    $select.append('<option value="">Select Ledger</option>');

                    ledgerBooks.forEach(function(book) {
                        let status = '';
                        if (book.pagesRemaining <= 10) {
                            status = '⚠️ Almost Full';
                        } else if (book.pagesRemaining <= 50) {
                            status = '⏰ Low';
                        }

                        $select.append(`<option value="${book.id}"
                                              data-ledger-no="${book.ledgerNo}"
                                              data-next-page="${book.currentPageNo}">
                                           ${book.ledgerNo} - Page: ${book.currentPageNo} ${status}
                                       </option>`);
                    });
                },
                error: function() {
                    console.error('Failed to load ledger books for dropdown');
                }
            });
        }

        // ==================== Update Page Number from Ledger Book ====================
        window.updatePageNumber = function(selectElement) {
            const $select = $(selectElement);
            const $row = $select.closest('tr');
            const $selectedOption = $select.find('option:selected');
            const $pageField = $row.find('.page-no-field');
            const $ledgerNoField = $row.find('.ledger-no-hidden');

            if ($selectedOption.val()) {
                const nextPage = $selectedOption.data('next-page');
                const ledgerNo = $selectedOption.data('ledger-no');

                $pageField.val(nextPage);
                $ledgerNoField.val(ledgerNo);
            } else {
                $pageField.val('');
                $ledgerNoField.val('');
            }
        };

        // Handle receive type change
        $('#receiveType').change(function() {
            $('.source-section').hide();
            $('.source-section input, .source-section select').prop('required', false);

            const type = $(this).val();
            let sectionId = null;

            switch(type) {
                case 'Battalion':
                    sectionId = '#battalionSection';
                    break;
                case 'Range':
                    sectionId = '#rangeSection';
                    break;
                case 'Zila':
                    sectionId = '#zilaSection';
                    break;
                case 'Upazila':
                    sectionId = '#upazilaSection';
                    break;
                case 'Individual':
                    sectionId = '#individualSection';
                    break;
                case 'External':
                    sectionId = '#externalSection';
                    break;
            }

            if (sectionId) {
                $(sectionId).show();
                $(sectionId + ' input, ' + sectionId + ' select').prop('required', true);
            }
        });

        // Form validation
        $('#receiveForm').submit(function(e) {
            // Check items
            if ($('#itemsBody tr').length === 0) {
                e.preventDefault();
                toastr.error('Please add at least one item to receive.');
                return false;
            }

            // Save signature data if present (BEFORE validation)
            if (signaturePad && !signaturePad.isEmpty()) {
                $('#signatureData').val(signaturePad.toDataURL());
            }

            // Check signature if completing (AFTER saving)
            const action = $(e.originalEvent.submitter).val();
            if (action === 'complete') {
                if (!$('#signatureData').val() || (signaturePad && signaturePad.isEmpty())) {
                    e.preventDefault();
                    toastr.warning('Please provide signature to complete receive.');
                    return false;
                }
            }

            return true;
        });

        function searchIssue() {
            $('#issueSearchModal').modal('show');
        }

        $('#issueSearchInput').on('input', function() {
            const searchTerm = $(this).val();
            if (searchTerm.length > 2) {
                $.get('/Issue/SearchApproved', { term: searchTerm }, function(data) {
                    let html = '<div class="list-group">';
                    data.forEach(issue => {
                        html += `
                            <a href="#" class="list-group-item list-group-item-action"
                               onclick="selectIssue(${issue.id}, '${issue.issueNo}')">
                                <strong>${issue.issueNo}</strong> - ${issue.issuedTo}
                                <br><small>Date: ${issue.issueDate}</small>
                            </a>
                        `;
                    });
                    html += '</div>';
                    $('#issueSearchResults').html(html);
                });
            }
        });

        function selectIssue(id, issueNo) {
            $('#originalIssueId').val(id);
            $('#originalIssueNo').val(issueNo);
            $('#issueSearchModal').modal('hide');

            // Load issue items
            $.get('/Receive/GetIssueItems/' + id, function(data) {
                if (data.success && data.items) {
                    $('#itemsBody').empty();
                    itemIndex = 0;

                    // ✅ FIX: Auto-select the CORRECT store (from original issue)
                    let originalStoreId = null;

                    data.items.forEach(item => {
                        // Get the original store from the first item
                        if (originalStoreId === null) {
                            originalStoreId = item.storeId;
                            // Auto-select the store in the main form
                            $('#StoreId').val(originalStoreId).trigger('change');
                            toastr.info('Store automatically selected from original issue', 'Info', {
                                timeOut: 3000
                            });
                        }

                        addItem();
                        const row = $(`#item_${itemIndex - 1}`);
                        row.find('.item-select').val(item.itemId).trigger('change');
                        row.find('.store-select').val(item.storeId);
                        row.find('.quantity-input').val(item.quantity);
                    });

                    // ✅ Make all item stores readonly/disabled to prevent changes
                    $('.store-select').prop('disabled', true);

                    updateSummary();

                    // Show info message
                    toastr.warning('Items must be received back to the SAME store from which they were issued!', 'Important', {
                        timeOut: 5000
                    });
                }
            });
        }

        function bulkAddItems() {
            // Implementation for bulk add modal
            toastr.info('Bulk add functionality to be implemented');
        }

        function scanBarcodes() {
            // Implementation for barcode scanning
            toastr.info('Barcode scanning functionality to be implemented');
        }

        function scanVoucherModal() {
            // Redirect to scan voucher page
            window.location.href = '@Url.Action("ScanVoucher", "Receive")';
        }

        // ==================== File Upload Preview ====================
        $('#voucherDocument').on('change', function() {
            const fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').html(fileName);

            const file = this.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#voucherPreviewImage').attr('src', e.target.result);
                    $('#voucherPreview').show();
                }
                reader.readAsDataURL(file);
            } else {
                $('#voucherPreview').hide();
            }

            if (file && file.size > 5 * 1024 * 1024) {
                Swal.fire({
                    icon: 'error',
                    title: 'File Too Large',
                    text: 'File size must be less than 5MB',
                    confirmButtonText: 'OK'
                });
                $(this).val('');
                $(this).next('.custom-file-label').html('Choose file');
                $('#voucherPreview').hide();
            }
        });
    </script>

    <!-- Signature Pad Library -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
}

@section Styles {
    <link rel="stylesheet" href="~/adminlte/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="~/adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">

    <style>
        #signatureCanvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 700px;
            height: 150px;
            cursor: crosshair;
            touch-action: none;
        }

        .source-section {
            animation: fadeIn 0.3s;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .info-box-number {
            font-size: 24px;
        }

        .select2-container--bootstrap4 .select2-selection--single {
            height: 31px !important;
        }
    </style>
}