@using IMS.Application.DTOs
@model IssueVoucherDto
@{
    ViewData["Title"] = "Voucher Generated";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-qrcode"></i> Issue Voucher Generated
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Issues</a></li>
                    <li class="breadcrumb-item active">Voucher Generated</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-check-circle"></i> Voucher Generated Successfully
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>Success!</strong> Issue voucher has been generated with QR code.
                        </div>

                        <div class="voucher-preview" style="border: 2px solid #28a745; border-radius: 8px; padding: 20px; background-color: #f8f9fa;">
                            <div class="row">
                                <div class="col-md-8">
                                    <h4 class="text-success">Voucher Details</h4>
                                    <table class="table table-sm">
                                        <tr>
                                            <th width="40%">Voucher Number:</th>
                                            <td><span class="badge badge-success badge-lg">@Model.VoucherNumber</span></td>
                                        </tr>
                                        <tr>
                                            <th>Issue Number:</th>
                                            <td>@Model.IssueId</td>
                                        </tr>
                                        <tr>
                                            <th>Issue Date:</th>
                                            <td>@Model.IssueDate.ToString("dd MMMM yyyy")</td>
                                        </tr>
                                        <tr>
                                            <th>Issued To:</th>
                                            <td><strong>@Model.IssuedTo</strong></td>
                                        </tr>
                                        <tr>
                                            <th>Purpose:</th>
                                            <td>@Model.Purpose</td>
                                        </tr>
                                        <tr>
                                            <th>Total Items:</th>
                                            <td>
                                                <span class="badge badge-primary">@Model.Items.Count items</span>
                                                <span class="badge badge-info">@Model.Items.Sum(i => i.Quantity) units</span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-4 text-center">
                                    <h5 class="text-success">QR Code</h5>
                                    @if (!string.IsNullOrEmpty(Model.QRCodeImage))
                                    {
                                        <img src="data:image/png;base64,@Model.QRCodeImage" alt="QR Code"
                                             id="qrCodeImage"
                                             style="width: 200px; height: 200px; border: 2px solid #28a745; padding: 10px; background-color: white;" />
                                        <p class="mt-2"><small class="text-muted">Scan to verify</small></p>
                                    }
                                </div>
                            </div>

                            <hr />

                            <h5 class="text-success">Items Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="bg-light">
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="15%">Code</th>
                                            <th width="35%">Item Name</th>
                                            <th width="15%">Quantity</th>
                                            <th width="15%">Unit</th>
                                            <th width="15%">Store</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            var itemIndex = 1;
                                        }
                                        @foreach (var item in Model.Items)
                                        {
                                            <tr>
                                                <td>@(itemIndex++)</td>
                                                <td>@item.ItemCode</td>
                                                <td>@item.ItemName</td>
                                                <td class="text-center"><strong>@item.Quantity</strong></td>
                                                <td>@item.Unit</td>
                                                <td>@item.StoreName</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.IssuedToDetails))
                        {
                            <div class="alert alert-info mt-3">
                                <strong>Additional Details:</strong> @Model.IssuedToDetails
                            </div>
                        }
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-info">
                        <h3 class="card-title">
                            <i class="fas fa-info-circle"></i> Next Steps
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="callout callout-success">
                                    <h5><i class="fas fa-1"></i> Print Voucher</h5>
                                    <p>Print the voucher with QR code for physical handover</p>
                                    <a asp-action="PrintVoucher" asp-route-id="@Model.IssueId"
                                       target="_blank" class="btn btn-success btn-sm">
                                        <i class="fas fa-print"></i> Print Now
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="callout callout-warning">
                                    <h5><i class="fas fa-2"></i> Physical Handover</h5>
                                    <p>Process the physical handover and collect signature</p>
                                    <a asp-action="ProcessHandover" asp-route-id="@Model.IssueId"
                                       class="btn btn-warning btn-sm">
                                        <i class="fas fa-handshake"></i> Process Handover
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="callout callout-info">
                                    <h5><i class="fas fa-3"></i> Track Status</h5>
                                    <p>Monitor the issue status and completion</p>
                                    <a asp-action="Details" asp-route-id="@Model.IssueId"
                                       class="btn btn-info btn-sm">
                                        <i class="fas fa-eye"></i> View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div class="card-body">
                        <a asp-action="PrintVoucher" asp-route-id="@Model.IssueId"
                           target="_blank" class="btn btn-primary btn-block mb-2">
                            <i class="fas fa-print"></i> Print Voucher
                        </a>
                        <a asp-action="ProcessHandover" asp-route-id="@Model.IssueId"
                           class="btn btn-success btn-block mb-2">
                            <i class="fas fa-handshake"></i> Process Handover
                        </a>
                        <button type="button" class="btn btn-info btn-block mb-2"
                                onclick="downloadQRCode()">
                            <i class="fas fa-download"></i> Download QR Code
                        </button>
                        <a asp-action="Details" asp-route-id="@Model.IssueId"
                           class="btn btn-default btn-block">
                            <i class="fas fa-arrow-left"></i> Back to Issue
                        </a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-success">
                        <h3 class="card-title">
                            <i class="fas fa-mobile-alt"></i> QR Code Preview
                        </h3>
                    </div>
                    <div class="card-body text-center">
                        @if (!string.IsNullOrEmpty(Model.QRCodeImage))
                        {
                            <img src="data:image/png;base64,@Model.QRCodeImage"
                                 id="qrCodePreview"
                                 alt="QR Code"
                                 class="img-fluid"
                                 style="max-width: 250px; border: 3px solid #28a745; padding: 15px; background-color: white;" />
                            <p class="mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Recipients can scan this code to view issue details
                                </small>
                            </p>
                        }
                    </div>
                </div>

                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-exclamation-triangle"></i> Important Notes
                        </h3>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0">
                            <li>Keep the voucher safe until handover is complete</li>
                            <li>Physical handover requires recipient signature</li>
                            <li>QR code is unique and cannot be reused</li>
                            <li>Print voucher before processing handover</li>
                        </ul>
                    </div>
                </div>

                <div class="info-box bg-info">
                    <span class="info-box-icon"><i class="fas fa-check"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Status</span>
                        <span class="info-box-number">Ready for Handover</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(function() {
            toastr.success('Voucher generated successfully!', 'Success', {
                timeOut: 3000,
                positionClass: 'toast-top-right'
            });
        });

        function downloadQRCode() {
            var qrImage = document.getElementById('qrCodeImage');
            if (!qrImage) return;

            var canvas = document.createElement('canvas');
            canvas.width = qrImage.naturalWidth || 200;
            canvas.height = qrImage.naturalHeight || 200;

            var ctx = canvas.getContext('2d');
            ctx.drawImage(qrImage, 0, 0);

            canvas.toBlob(function(blob) {
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.download = 'voucher-qr-@(Model.VoucherNumber).png';
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                toastr.success('QR Code downloaded successfully!');
            });
        }
    </script>
}