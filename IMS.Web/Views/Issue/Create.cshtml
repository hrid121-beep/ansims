@using IMS.Application.DTOs
@model IssueDto
@{
    ViewData["Title"] = "Create Issue";
    var stores = ViewBag.Stores as IEnumerable<StoreDto> ?? new List<StoreDto>();
    var battalions = ViewBag.Battalions as IEnumerable<BattalionDto> ?? new List<BattalionDto>();
    var ranges = ViewBag.Ranges as IEnumerable<RangeDto> ?? new List<RangeDto>();
    var zilas = ViewBag.Zilas as IEnumerable<ZilaDto> ?? new List<ZilaDto>();
    var upazilas = ViewBag.Upazilas as IEnumerable<UpazilaDto> ?? new List<UpazilaDto>();
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Create Issue</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Issues</a></li>
                    <li class="breadcrumb-item active">Create</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <form asp-action="Create" method="post" id="issueForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="IssueNo" value="@ViewBag.IssueNo" />

            <div class="row">
                <div class="col-lg-8">
                    <!-- Issue Details Card -->
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-clipboard-check"></i> Issue Information
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Issue No</label>
                                        <input type="text" class="form-control" value="@ViewBag.IssueNo" readonly />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label asp-for="IssueDate">Issue Date <span class="text-danger">*</span></label>
                                        <input asp-for="IssueDate" type="date" class="form-control" required
                                               value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                        <span asp-validation-for="IssueDate" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label asp-for="MemoNo">Memo No <span class="text-danger" id="memoRequired" style="display:none;">*</span></label>
                                        <input asp-for="MemoNo" class="form-control" id="memoNo" placeholder="Enter memo number" />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label asp-for="MemoDate">Memo Date</label>
                                        <input asp-for="MemoDate" type="date" class="form-control" id="memoDate" />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label asp-for="FromStoreId">From Store <span class="text-danger">*</span></label>
                                        <select asp-for="FromStoreId" class="form-control select2" id="fromStore" required>
                                            <option value="">Select Store</option>
                                            @if (stores.Any())
                                            {
                                                @foreach (var store in stores)
                                                {
                                                    <option value="@store.Id" data-store-type="@store.StoreTypeName">@store.Name - @store.Code</option>
                                                }
                                            }
                                        </select>
                                        <span asp-validation-for="FromStoreId" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label asp-for="IssuedToType">Issue To Type <span class="text-danger">*</span></label>
                                        <select asp-for="IssuedToType" class="form-control" id="issueToType" required>
                                            <option value="">Select Type</option>
                                            <option value="Battalion">Battalion</option>
                                            <option value="Range">Range</option>
                                            <option value="Zila">Zila</option>
                                            <option value="Upazila">Upazila</option>
                                            <option value="Individual">Individual</option>
                                        </select>
                                        <span asp-validation-for="IssuedToType" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Dynamic Issue To Selection -->
                            <div class="row" id="issueToSection" style="display: none;">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label id="issueToLabel">Issue To <span class="text-danger">*</span></label>

                                        <!-- Battalion Selection -->
                                        <select asp-for="IssuedToBattalionId" class="form-control select2 issue-to-select"
                                                id="battalionSelect" style="display: none;">
                                            <option value="">Select Battalion</option>
                                            @foreach (var battalion in battalions)
                                            {
                                                <option value="@battalion.Id">@battalion.Name - @battalion.Code</option>
                                            }
                                        </select>

                                        <!-- Range Selection -->
                                        <select asp-for="IssuedToRangeId" class="form-control select2 issue-to-select"
                                                id="rangeSelect" style="display: none;">
                                            <option value="">Select Range</option>
                                            @foreach (var range in ranges)
                                            {
                                                <option value="@range.Id">@range.Name</option>
                                            }
                                        </select>

                                        <!-- Zila Selection -->
                                        <select asp-for="IssuedToZilaId" class="form-control select2 issue-to-select"
                                                id="zilaSelect" style="display: none;">
                                            <option value="">Select Zila</option>
                                            @foreach (var zila in zilas)
                                            {
                                                <option value="@zila.Id">@zila.Name</option>
                                            }
                                        </select>

                                        <!-- Upazila Selection -->
                                        <select asp-for="IssuedToUpazilaId" class="form-control select2 issue-to-select"
                                                id="upazilaSelect" style="display: none;">
                                            <option value="">Select Upazila</option>
                                            @foreach (var upazila in upazilas)
                                            {
                                                <option value="@upazila.Id">@upazila.Name</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6" id="individualSection" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label asp-for="IssuedToIndividualName">Name <span class="text-danger">*</span></label>
                                                <input asp-for="IssuedToIndividualName" class="form-control" placeholder="Enter name" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label asp-for="IssuedToIndividualBadgeNo">Badge No <span class="text-danger">*</span></label>
                                                <input asp-for="IssuedToIndividualBadgeNo" class="form-control" placeholder="Enter badge no" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="Purpose">Purpose <span class="text-danger">*</span></label>
                                        <select asp-for="Purpose" class="form-control" id="purposeSelect" required>
                                            <option value="">Select Purpose</option>
                                            <option value="Regular Supply">Regular Supply</option>
                                            <option value="Emergency">Emergency</option>
                                            <option value="Training">Training</option>
                                            <option value="Operation">Operation</option>
                                            <option value="Replacement">Replacement</option>
                                            <option value="Other">Other</option>
                                        </select>
                                        <input type="text" id="purposeOther" class="form-control mt-2"
                                               style="display: none;" placeholder="Specify purpose" />
                                        <span asp-validation-for="Purpose" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="DeliveryLocation">Delivery Location</label>
                                        <input asp-for="DeliveryLocation" class="form-control" placeholder="Enter delivery location" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label asp-for="Remarks">Remarks</label>
                                        <textarea asp-for="Remarks" class="form-control" rows="2" placeholder="Additional notes..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Card -->
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-boxes"></i> Issue Items
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-default" id="scanBarcodeBtn">
                                    <i class="fas fa-barcode"></i> Scan Barcode
                                </button>
                                <button type="button" class="btn btn-sm btn-primary" id="addItemBtn">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Barcode Scanner Section -->
                            <div id="barcodeSection" style="display: none;" class="mb-3">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                    </div>
                                    <input type="text" id="barcodeInput" class="form-control"
                                           placeholder="Scan or enter barcode" />
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-primary" id="processBarcodeBtn">
                                            Process
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered table-sm" id="itemsTable">
                                    <thead class="bg-light">
                                        <tr>
                                            <th width="3%">#</th>
                                            <th width="18%">ITEM CODE/NAME</th>
                                            <th width="10%">CATEGORY</th>
                                            <th width="8%">CURRENT STOCK</th>
                                            <th width="8%">REQUEST QTY</th>
                                            <th width="6%">UNIT</th>
                                            <th width="8%">BATCH NO</th>
                                            <th width="6%">LEDGER NO</th>
                                            <th width="6%">PAGE NO</th>
                                            <th width="8%">USABLE</th>
                                            <th width="8%">PARTIAL</th>
                                            <th width="8%">UNUSABLE</th>
                                            <th width="3%">ACTION</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemsContainer">
                                        <!-- Items will be added dynamically -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="4" class="text-right"><strong>Total Items:</strong></td>
                                            <td id="totalItems" class="text-center font-weight-bold">0</td>
                                            <td colspan="8"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Voucher Document Upload -->
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-file-upload"></i> Voucher Document <span class="text-danger" id="docRequired" style="display:none;">*</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="voucherDocument">Upload Supporting Document</label>
                                <div class="input-group">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="voucherDocument"
                                               name="voucherDocument" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                        <label class="custom-file-label" for="voucherDocument">Choose file</label>
                                    </div>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Upload allotment letter, authorization memo, or approval document. Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max 5MB)
                                </small>
                                <small class="text-danger" id="docWarning" style="display:none;">
                                    <i class="fas fa-exclamation-triangle"></i> <strong>Document upload is mandatory for issues from Provision Store</strong>
                                </small>
                                <div id="voucherPreview" class="mt-2" style="display: none;">
                                    <img id="voucherPreviewImage" src="" alt="Preview"
                                         style="max-width: 200px; max-height: 200px;" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Authorization Section -->
                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-user-check"></i> Authorization
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Issued By</label>
                                        <input type="text" class="form-control" value="@User.Identity.Name" readonly />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="SignerName">Authorized By</label>
                                        <input asp-for="SignerName" class="form-control" placeholder="Name of authorizing officer" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="SignerBadgeId">Badge ID</label>
                                        <input asp-for="SignerBadgeId" class="form-control" placeholder="Badge ID" />
                                    </div>
                                </div>
                            </div>

                            <!-- Digital Signature Capture -->
                            <div class="row">
                                <div class="col-md-12">
                                    <label>Digital Signature</label>
                                    <div class="border p-2">
                                        <canvas id="signatureCanvas" width="700" height="150" style="border: 1px solid #ddd; width: 100%; max-width: 700px;"></canvas>
                                        <input type="hidden" asp-for="SignaturePath" id="signatureData" />
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-secondary" id="clearSignature">
                                                <i class="fas fa-eraser"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="col-lg-4">
                    <!-- Summary Card -->
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-bar"></i> Issue Summary
                            </h3>
                        </div>
                        <div class="card-body">
                            <dl class="row">
                                <dt class="col-sm-6">Issue Type:</dt>
                                <dd class="col-sm-6" id="summaryType">-</dd>

                                <dt class="col-sm-6">Issue To:</dt>
                                <dd class="col-sm-6" id="summaryTo">-</dd>

                                <dt class="col-sm-6">From Store:</dt>
                                <dd class="col-sm-6" id="summaryStore">-</dd>

                                <dt class="col-sm-6">Total Items:</dt>
                                <dd class="col-sm-6" id="summaryItems">0</dd>

                                <dt class="col-sm-6">Total Quantity:</dt>
                                <dd class="col-sm-6" id="summaryQuantity">0</dd>

                                <dt class="col-sm-6">Status:</dt>
                                <dd class="col-sm-6"><span class="badge badge-warning">Draft</span></dd>
                            </dl>
                        </div>
                    </div>

                    <!-- Stock Alerts -->
                    <div class="card card-danger" id="stockAlerts" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-exclamation-triangle"></i> Stock Alerts
                            </h3>
                        </div>
                        <div class="card-body">
                            <ul id="alertsList" class="list-unstyled">
                                <!-- Alerts will be added dynamically -->
                            </ul>
                        </div>
                    </div>

                    <!-- Actions Card -->
                    <div class="card">
                        <div class="card-body">
                            <button type="button" id="saveDraftBtn" class="btn btn-block btn-secondary">
                                <i class="fas fa-save"></i> Save as Draft
                            </button>
                            <button type="button" id="submitForApprovalBtn" class="btn btn-block btn-primary">
                                <i class="fas fa-paper-plane"></i> Submit for Approval
                            </button>
                            <a asp-action="Index" class="btn btn-block btn-default">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Item Selection Modal -->
<div class="modal fade" id="itemModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Item</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="input-group">
                        <input type="text" id="itemSearch" class="form-control"
                               placeholder="Search by name or code..." />
                        <div class="input-group-append">
                            <button type="button" class="btn btn-primary" id="searchItemsBtn">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Unit</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsList">
                            <tr>
                                <td colspan="6" class="text-center">Select a store first to view items</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <link href="~/adminlte/plugins/select2/css/select2.min.css" rel="stylesheet" />
    <link href="~/adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css" rel="stylesheet" />

    <script src="~/adminlte/plugins/select2/js/select2.full.min.js"></script>
    <script src="~/js/signature_pad.min.js"></script>
    <script src="~/adminlte/plugins/sweetalert2/sweetalert2.all.min.js"></script>

    <script>
        $(document).ready(function() {
            let itemIndex = 0;
            let signaturePad = null;
            let selectedItems = [];
            let formChanged = false;
            window.storeItems = [];

            $('.select2').select2({
                theme: 'bootstrap4',
                width: '100%',
                placeholder: function() {
                    return $(this).data('placeholder') || 'Select an option';
                },
                allowClear: true
            });

            const canvas = document.getElementById('signatureCanvas');
            if (canvas && typeof SignaturePad !== 'undefined') {
                signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)'
                });

                $('#clearSignature').click(function() {
                    if (signaturePad) {
                        signaturePad.clear();
                        $('#signatureData').val('');
                    }
                });

                canvas.addEventListener('mouseup', function() {
                    if (signaturePad && !signaturePad.isEmpty()) {
                        $('#signatureData').val(signaturePad.toDataURL());
                    }
                });
            }

            // ==================== Provision Store Validation ====================
            function checkProvisionStoreRequirements() {
                const selectedOption = $('#fromStore option:selected');
                const storeTypeName = selectedOption.data('store-type') || '';

                const isProvisionStore = storeTypeName.toLowerCase().includes('provision');

                if (isProvisionStore) {
                    $('#docRequired, #memoRequired, #docWarning').show();
                    $('#voucherDocument, #memoNo').prop('required', true);

                    toastr.info('Document upload and memo number are mandatory for Provision Store', 'Note', {
                        timeOut: 5000,
                        positionClass: 'toast-top-right'
                    });
                } else {
                    $('#docRequired, #memoRequired, #docWarning').hide();
                    $('#voucherDocument, #memoNo').prop('required', false);
                }
            }

            $('#fromStore').on('change', function() {
                checkProvisionStoreRequirements();
            });

            // ==================== Form Submission Validation ====================
            function validateProvisionStoreFields() {
                const selectedOption = $('#fromStore option:selected');
                const storeTypeName = selectedOption.data('store-type') || '';
                const isProvisionStore = storeTypeName.toLowerCase().includes('provision');

                if (isProvisionStore) {
                    const hasDocument = $('#voucherDocument')[0].files.length > 0;
                    const hasMemoNo = $('#memoNo').val().trim() !== '';

                    if (!hasDocument) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Document Required',
                            text: 'Document upload is mandatory for issues from Provision Store. Please upload allotment letter or authorization document.',
                            confirmButtonText: 'OK'
                        });
                        return false;
                    }

                    if (!hasMemoNo) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Memo Number Required',
                            text: 'Memo number is mandatory for issues from Provision Store.',
                            confirmButtonText: 'OK'
                        });
                        $('#memoNo').focus();
                        return false;
                    }
                }

                return true;
            }

            // ==================== Form Submission Handlers ====================
            $('#saveDraftBtn').click(function(e) {
                e.preventDefault();

                const items = $('#itemsContainer tr').length;
                if (items === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No Items',
                        text: 'Please add at least one item to save as draft',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                if (signaturePad && !signaturePad.isEmpty()) {
                    $('#signatureData').val(signaturePad.toDataURL());
                }

                var formData = new FormData($('#issueForm')[0]);
                formData.append('action', 'draft');

                $.ajax({
                    url: $('#issueForm').attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    beforeSend: function() {
                        Swal.fire({
                            title: 'Saving Draft...',
                            text: 'Please wait',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                    },
                    success: function(result) {
                        if (result.success) {
                            formChanged = false;
                            Swal.fire({
                                icon: 'success',
                                title: 'Saved!',
                                text: result.message || 'Draft saved successfully',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                window.location.href = result.redirectUrl;
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: result.message || 'Failed to save draft'
                            });
                        }
                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while saving the draft'
                        });
                    }
                });
            });

            $('#submitForApprovalBtn').click(function(e) {
                e.preventDefault();

                const items = $('#itemsContainer tr').length;
                if (items === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No Items',
                        text: 'Please add at least one item to issue',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                const issueType = $('#issueToType').val();
                if (!issueType) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Issue Type Required',
                        text: 'Please select issue type',
                        confirmButtonText: 'OK'
                    });
                    $('#issueToType').focus();
                    return;
                }

                if (issueType === 'Individual') {
                    const name = $('#IssuedToIndividualName').val();
                    const badge = $('#IssuedToIndividualBadgeNo').val();

                    if (!name || !badge) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Individual Details Required',
                            text: 'Please enter individual name and badge number',
                            confirmButtonText: 'OK'
                        });
                        return;
                    }
                } else {
                    const selector = '#' + issueType.toLowerCase() + 'Select';
                    if (!$(selector).val()) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Selection Required',
                            text: `Please select ${issueType}`,
                            confirmButtonText: 'OK'
                        });
                        $(selector).focus();
                        return;
                    }
                }

                if (!$('#fromStore').val()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Store Required',
                        text: 'Please select a store',
                        confirmButtonText: 'OK'
                    });
                    $('#fromStore').focus();
                    return;
                }

                const purpose = $('#purposeSelect').val();
                if (!purpose) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Purpose Required',
                        text: 'Please select purpose',
                        confirmButtonText: 'OK'
                    });
                    $('#purposeSelect').focus();
                    return;
                }

                if (purpose === 'Other' && !$('#purposeOther').val()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Purpose Details Required',
                        text: 'Please specify the purpose',
                        confirmButtonText: 'OK'
                    });
                    $('#purposeOther').focus();
                    return;
                }

                if (!validateProvisionStoreFields()) {
                    return;
                }

                if (signaturePad && !signaturePad.isEmpty()) {
                    $('#signatureData').val(signaturePad.toDataURL());
                }

                Swal.fire({
                    title: 'Submit Issue for Approval?',
                    html: `
                        <div class="text-left">
                            <p><strong>Items:</strong> ${items}</p>
                            <p><strong>Total Quantity:</strong> ${$('#summaryQuantity').text()}</p>
                            <p><strong>Issue To:</strong> ${$('#summaryTo').text()}</p>
                        </div>
                        <p class="mt-3">This action will submit the issue for approval.</p>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, submit for approval',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        var formData = new FormData($('#issueForm')[0]);
                        formData.append('action', 'submit');

                        $.ajax({
                            url: $('#issueForm').attr('action'),
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            beforeSend: function() {
                                Swal.fire({
                                    title: 'Submitting...',
                                    text: 'Please wait',
                                    allowOutsideClick: false,
                                    didOpen: () => {
                                        Swal.showLoading();
                                    }
                                });
                            },
                            success: function(result) {
                                if (result.success) {
                                    formChanged = false;
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success!',
                                        text: result.message || 'Issue submitted for approval successfully',
                                        timer: 2000,
                                        showConfirmButton: false
                                    }).then(() => {
                                        window.location.href = result.redirectUrl;
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: result.message || 'Failed to submit issue'
                                    });
                                }
                            },
                            error: function(xhr) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'An error occurred while submitting the issue'
                                });
                            }
                        });
                    }
                });
            });

            // ==================== Issue Type Handling ====================
            $('#issueToType').change(function() {
                const type = $(this).val();

                $('.issue-to-select').hide().prop('required', false).val('').trigger('change');
                $('#individualSection').hide();
                $('#issueToSection').hide();

                $('#IssuedToIndividualName').val('').prop('required', false);
                $('#IssuedToIndividualBadgeNo').val('').prop('required', false);

                if (type) {
                    $('#issueToSection').show();
                    $('#summaryType').text(type);

                    switch(type) {
                        case 'Battalion':
                            $('#battalionSelect').show().prop('required', true);
                            $('#issueToLabel').text('Select Battalion');
                            break;
                        case 'Range':
                            $('#rangeSelect').show().prop('required', true);
                            $('#issueToLabel').text('Select Range');
                            break;
                        case 'Zila':
                            $('#zilaSelect').show().prop('required', true);
                            $('#issueToLabel').text('Select Zila');
                            break;
                        case 'Upazila':
                            $('#upazilaSelect').show().prop('required', true);
                            $('#issueToLabel').text('Select Upazila');
                            break;
                        case 'Individual':
                            $('#individualSection').show();
                            $('#issueToLabel').text('Individual Details');
                            $('#IssuedToIndividualName').prop('required', true);
                            $('#IssuedToIndividualBadgeNo').prop('required', true);
                            break;
                    }
                } else {
                    $('#summaryType').text('-');
                    $('#summaryTo').text('-');
                }
            });

            $('.issue-to-select').change(function() {
                const selectedText = $(this).find('option:selected').text();
                if (selectedText && !selectedText.startsWith('Select')) {
                    $('#summaryTo').text(selectedText);
                }
            });

            $('#IssuedToIndividualName, #IssuedToIndividualBadgeNo').on('input blur', function() {
                const name = $('#IssuedToIndividualName').val();
                const badge = $('#IssuedToIndividualBadgeNo').val();
                if (name || badge) {
                    $('#summaryTo').text(`${name || 'N/A'} (${badge || 'N/A'})`);
                }
            });

            // ==================== Store Selection ====================
            $('#fromStore').change(function() {
                const storeId = $(this).val();
                const storeName = $(this).find('option:selected').text();

                if (storeName && storeName !== 'Select Store') {
                    $('#summaryStore').text(storeName);
                } else {
                    $('#summaryStore').text('-');
                }

                if ($('#itemsContainer tr').length > 0 && storeId) {
                    Swal.fire({
                        title: 'Change Store?',
                        text: 'Changing store will clear all selected items. Continue?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, change store',
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $('#itemsContainer').empty();
                            selectedItems = [];
                            itemIndex = 0;
                            updateSummary();
                            clearStockAlerts();
                            $(this).data('previous', storeId);
                        } else {
                            $(this).val($(this).data('previous')).trigger('change');
                        }
                    });
                } else {
                    $(this).data('previous', storeId);
                }
            });

            $('#fromStore').data('previous', $('#fromStore').val());

            // ==================== Ledger Book Loading ====================
            $('#fromStore').on('change', function() {
                const storeId = $(this).val();
                console.log('Store changed to:', storeId);

                if (!storeId) {
                    $('.ledger-book-select').empty().append('<option value="">Select Ledger</option>');
                    return;
                }

                // Load ledger books for Issue type
                $.ajax({
                    url: '/LedgerBook/GetActiveLedgerBooks',
                    data: { storeId: storeId, bookType: 'Issue' },
                    success: function(ledgerBooks) {
                        console.log('Ledger books received:', ledgerBooks);
                        console.log('Number of ledger books:', ledgerBooks.length);

                        $('.ledger-book-select').each(function() {
                            const select = $(this);
                            select.empty();
                            select.append('<option value="">Select Ledger</option>');

                            if (ledgerBooks && ledgerBooks.length > 0) {
                                ledgerBooks.forEach(function(book) {
                                    console.log('Adding ledger book:', book);
                                    const pagesLeft = book.pagesRemaining || 0;
                                    const status = pagesLeft <= 10 ? '⚠️' : '✅';
                                    select.append(`<option value="${book.id}"
                                                          data-ledger-no="${book.ledgerNo}"
                                                          data-next-page="${book.currentPageNo}">
                                                       ${book.ledgerNo} - Page: ${book.currentPageNo} ${status}
                                                   </option>`);
                                });
                            } else {
                                console.warn('No ledger books found for store:', storeId);
                                select.append('<option value="">No ledger books available</option>');
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error loading ledger books:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                        alert('Error loading ledger books. Check console for details.');
                    }
                });
            });

            // Auto-fill page number when ledger is selected
            window.updatePageNumber = function(selectElement) {
                const $select = $(selectElement);
                const $selectedOption = $select.find('option:selected');
                const nextPage = $selectedOption.data('next-page');
                const ledgerNo = $selectedOption.data('ledger-no');

                const $row = $select.closest('tr');
                const $pageField = $row.find('.page-no-field');
                const $ledgerNoField = $row.find('.ledger-no-hidden');

                if (nextPage) {
                    $pageField.val(nextPage);
                    $ledgerNoField.val(ledgerNo);
                } else {
                    $pageField.val('');
                    $ledgerNoField.val('');
                }
            };

            // ==================== Purpose Selection ====================
            $('#purposeSelect').change(function() {
                if ($(this).val() === 'Other') {
                    $('#purposeOther').show().prop('required', true);
                    $('#purposeOther').on('input', function() {
                        $('#Purpose').val($(this).val());
                    });
                } else {
                    $('#purposeOther').hide().prop('required', false).val('');
                    $('#Purpose').val($(this).val());
                }
            });

            // ==================== Item Management ====================
            $('#addItemBtn').click(function() {
                const storeId = $('#fromStore').val();
                if (!storeId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Store Required',
                        text: 'Please select a store first',
                        confirmButtonText: 'OK'
                    });
                    $('#fromStore').focus();
                    return;
                }

                $('#itemSearch').val('');
                loadAvailableItems(storeId);
                $('#itemModal').modal('show');
            });

            function loadAvailableItems(storeId) {
                $('#itemsList').html('<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading items...</td></tr>');

                $.ajax({
                    url: '@Url.Action("GetAllItemsWithStoreStock", "Store")',
                    type: 'GET',
                    data: { storeId: storeId },
                    success: function(items) {
                        const tbody = $('#itemsList');
                        tbody.empty();

                        if (!items || items.length === 0) {
                            tbody.append('<tr><td colspan="6" class="text-center">No items found</td></tr>');
                            return;
                        }

                        window.storeItems = items;

                        const inStockItems = items.filter(i => i.quantity > 0);
                        const outOfStockItems = items.filter(i => i.quantity <= 0);

                        inStockItems.forEach(function(item) {
                            tbody.append(createItemRow(item));
                        });

                        if (outOfStockItems.length > 0 && inStockItems.length > 0) {
                            tbody.append(`
                                <tr class="bg-light">
                                    <td colspan="6" class="text-center font-weight-bold">
                                        <i class="fas fa-exclamation-triangle text-warning"></i> Out of Stock Items
                                    </td>
                                </tr>
                            `);
                        }

                        outOfStockItems.forEach(function(item) {
                            tbody.append(createItemRow(item));
                        });
                    },
                    error: function(xhr) {
                        $('#itemsList').html('<tr><td colspan="6" class="text-center text-danger">Error loading items</td></tr>');
                    }
                });
            }

            function createItemRow(item) {
                const stockClass = item.quantity <= 0 ? 'text-danger font-weight-bold' :
                                 item.quantity <= (item.minimumStock || 0) ? 'text-warning font-weight-bold' :
                                 'text-success';

                const isDisabled = item.quantity <= 0 || selectedItems.includes(item.itemId);
                const buttonClass = isDisabled ? 'btn-secondary' : 'btn-primary';
                const buttonText = item.quantity <= 0 ? 'No Stock' :
                                  selectedItems.includes(item.itemId) ? 'Already Added' :
                                  '<i class="fas fa-plus"></i> Select';

                return `
                    <tr data-item-id="${item.itemId}">
                        <td><strong>${item.itemCode || item.code || '-'}</strong></td>
                        <td>${item.itemName || item.name || '-'}</td>
                        <td>${item.categoryName || '-'}</td>
                        <td class="${stockClass}">${item.quantity || 0} ${item.unit || ''}</td>
                        <td>${item.unit || '-'}</td>
                        <td>
                            <button type="button" class="btn btn-sm ${buttonClass} select-item"
                                    data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}'
                                    ${isDisabled ? 'disabled' : ''}>
                                ${buttonText}
                            </button>
                        </td>
                    </tr>
                `;
            }

            $(document).on('click', '.select-item:not(:disabled)', function() {
                const item = $(this).data('item');
                if (item) {
                    addItemToTable(item);
                    $(this).prop('disabled', true)
                           .removeClass('btn-primary')
                           .addClass('btn-secondary')
                           .html('Already Added');

                    if (!event.shiftKey) {
                        $('#itemModal').modal('hide');
                    }
                }
            });

            function addItemToTable(item) {
                if (selectedItems.includes(item.itemId)) {
                    const existingRow = $(`#item_${item.itemId}`);
                    if (existingRow.length > 0) {
                        const qtyInput = existingRow.find('.item-quantity');
                        const currentQty = parseFloat(qtyInput.val()) || 0;
                        const maxQty = parseFloat(qtyInput.attr('max')) || item.quantity;

                        if (currentQty < maxQty) {
                            const newQty = Math.min(currentQty + 1, maxQty);
                            qtyInput.val(newQty).trigger('change');
                            existingRow.addClass('table-warning');
                            setTimeout(() => existingRow.removeClass('table-warning'), 500);
                        } else {
                            toastr.warning(`Cannot exceed available stock (${maxQty} ${item.unit})`);
                        }
                        return;
                    }
                }

                const stockValue = item.currentStock || item.quantity || 0;
                const minStock = item.minimumStock || 0;
                const stockClass = stockValue <= minStock ? 'text-danger font-weight-bold' : '';

                const row = `
                    <tr id="item_${item.itemId}" class="item-row">
                        <td class="text-center">${itemIndex + 1}</td>
                        <td>
                            <input type="hidden" name="Items[${itemIndex}].ItemId" value="${item.itemId}" />
                            <input type="hidden" name="Items[${itemIndex}].StoreId" value="${item.storeId || $('#fromStore').val()}" />
                            <strong>${item.itemCode || item.code || '-'}</strong><br/>
                            <small class="text-muted">${item.itemName || item.name || '-'}</small>
                        </td>
                        <td>${item.categoryName || '-'}</td>
                        <td class="${stockClass}">
                            ${stockValue} ${item.unit || ''}
                            ${stockValue <= minStock ? '<i class="fas fa-exclamation-triangle text-warning ml-1"></i>' : ''}
                        </td>
                        <td>
                            <input type="number" name="Items[${itemIndex}].Quantity"
                                   class="form-control form-control-sm item-quantity"
                                   min="0.01" max="${stockValue}" step="0.01"
                                   value="1" required />
                        </td>
                        <td>${item.unit || '-'}
                            <input type="hidden" name="Items[${itemIndex}].Unit" value="${item.unit || ''}" />
                        </td>
                        <td>
                            <input type="text" name="Items[${itemIndex}].BatchNumber"
                                   class="form-control form-control-sm"
                                   value="${item.batchNumber || ''}" placeholder="Batch No" />
                        </td>
                        <td>
                            <select name="Items[${itemIndex}].LedgerBookId"
                                    class="form-control form-control-sm ledger-book-select"
                                    data-item-index="${itemIndex}"
                                    onchange="updatePageNumber(this)">
                                <option value="">Select Ledger</option>
                            </select>
                            <input type="hidden" name="Items[${itemIndex}].LedgerNo" class="ledger-no-hidden" />
                        </td>
                        <td>
                            <input type="text" name="Items[${itemIndex}].PageNo"
                                   class="form-control form-control-sm page-no-field"
                                   placeholder="Page" readonly />
                        </td>
                        <td>
                            <input type="number" name="Items[${itemIndex}].UsableQuantity"
                                   class="form-control form-control-sm"
                                   min="0" step="0.01" placeholder="Usable" />
                        </td>
                        <td>
                            <input type="number" name="Items[${itemIndex}].PartiallyUsableQuantity"
                                   class="form-control form-control-sm"
                                   min="0" step="0.01" placeholder="Partial" />
                        </td>
                        <td>
                            <input type="number" name="Items[${itemIndex}].UnusableQuantity"
                                   class="form-control form-control-sm"
                                   min="0" step="0.01" placeholder="Unusable" />
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-danger remove-item" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;

                $('#itemsContainer').append(row);
                selectedItems.push(item.itemId);
                itemIndex++;

                if (stockValue <= minStock) {
                    addStockAlert(item);
                }

                updateSummary();
                formChanged = true;

                toastr.success(`${item.itemName || item.name} added`, 'Item Added', {
                    timeOut: 1500,
                    positionClass: 'toast-bottom-right'
                });
            }

            $(document).on('click', '.remove-item', function() {
                const row = $(this).closest('tr');
                const itemId = parseInt(row.find('input[name*=".ItemId"]').val());
                const itemName = row.find('small').text();

                Swal.fire({
                    title: 'Remove Item?',
                    text: `Remove ${itemName} from the issue?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, remove',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        selectedItems = selectedItems.filter(id => id !== itemId);
                        $(`#alert_${itemId}`).remove();

                        row.fadeOut(300, function() {
                            $(this).remove();
                            reindexItems();
                            updateSummary();

                            $(`#itemsList tr[data-item-id="${itemId}"] .select-item`)
                                .prop('disabled', false)
                                .removeClass('btn-secondary')
                                .addClass('btn-primary')
                                .html('<i class="fas fa-plus"></i> Select');
                        });

                        toastr.info('Item removed');
                        formChanged = true;
                    }
                });
            });

            // ==================== Barcode Scanner ====================
            $('#scanBarcodeBtn').click(function() {
                $('#barcodeSection').slideToggle();
                if ($('#barcodeSection').is(':visible')) {
                    $('#barcodeInput').focus();
                }
            });

            function processBarcode() {
                const barcode = $('#barcodeInput').val().trim();
                const storeId = $('#fromStore').val();

                if (!barcode) {
                    toastr.warning('Please enter or scan a barcode');
                    return;
                }

                if (!storeId) {
                    toastr.error('Please select a store first');
                    $('#fromStore').focus();
                    return;
                }

                $('#processBarcodeBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');

                $.ajax({
                    url: '@Url.Action("ScanBarcode", "Issue")',
                    type: 'POST',
                    data: {
                        barcodeNumber: barcode,
                        storeId: storeId
                    },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(result) {
                        if (result.isValid) {
                            addItemToTable(result);
                            $('#barcodeInput').val('').focus();
                        } else {
                            toastr.error(result.validationMessage || 'Invalid barcode');
                        }
                    },
                    error: function(xhr) {
                        toastr.error('Error scanning barcode');
                    },
                    complete: function() {
                        $('#processBarcodeBtn').prop('disabled', false).html('Process');
                    }
                });
            }

            $('#processBarcodeBtn').click(processBarcode);

            $('#barcodeInput').keypress(function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    processBarcode();
                }
            });

            // ==================== Quantity Management ====================
            $(document).on('change input', '.item-quantity', function() {
                const max = parseFloat($(this).attr('max'));
                const val = parseFloat($(this).val());

                if (val > max) {
                    $(this).val(max);
                    toastr.warning(`Quantity cannot exceed available stock (${max})`);
                }

                if (val <= 0) {
                    $(this).val(0.01);
                }

                updateSummary();
                formChanged = true;
            });

            // ==================== Stock Alerts ====================
            function addStockAlert(item) {
                const alertId = `alert_${item.itemId}`;
                if ($(`#${alertId}`).length === 0) {
                    const alert = `
                        <li class="mb-2" id="${alertId}">
                            <i class="fas fa-exclamation-circle text-warning"></i>
                            <strong>${item.itemName || item.name}</strong>
                            <span class="text-muted">(${item.quantity} ${item.unit} remaining)</span>
                        </li>
                    `;
                    $('#alertsList').append(alert);
                    $('#stockAlerts').show();
                }
            }

            function clearStockAlerts() {
                $('#alertsList').empty();
                $('#stockAlerts').hide();
            }

            // ==================== Summary & Helper Functions ====================
            function updateSummary() {
                const rows = $('#itemsContainer tr');
                const totalItems = rows.length;
                let totalQuantity = 0;

                rows.each(function() {
                    const qty = parseFloat($(this).find('.item-quantity').val()) || 0;
                    totalQuantity += qty;
                });

                $('#totalItems').text(totalItems);
                $('#summaryItems').text(totalItems);
                $('#summaryQuantity').text(totalQuantity.toFixed(2));

                if (totalItems === 0) {
                    clearStockAlerts();
                }
            }

            function reindexItems() {
                $('#itemsContainer tr').each(function(index) {
                    $(this).find('td:first').text(index + 1);
                    $(this).find('input, select').each(function() {
                        const name = $(this).attr('name');
                        if (name) {
                            const newName = name.replace(/\[\d+\]/, `[${index}]`);
                            $(this).attr('name', newName);
                        }
                    });
                });
                itemIndex = $('#itemsContainer tr').length;
            }

            // ==================== Search functionality ====================
            $('#searchItemsBtn').click(filterItems);
            $('#itemSearch').on('keyup input', filterItems);

            function filterItems() {
                const searchTerm = $('#itemSearch').val().toLowerCase().trim();

                $('#no-results-row').remove();

                if (!searchTerm) {
                    $('#itemsList tr').show();
                    return;
                }

                let foundCount = 0;
                $('#itemsList tr').each(function() {
                    if ($(this).hasClass('bg-light')) {
                        $(this).hide();
                        return;
                    }

                    const rowText = $(this).text().toLowerCase();
                    if (rowText.includes(searchTerm)) {
                        $(this).show();
                        foundCount++;
                    } else {
                        $(this).hide();
                    }
                });

                if (foundCount === 0) {
                    $('#itemsList').append(`
                        <tr id="no-results-row">
                            <td colspan="6" class="text-center text-warning">
                                <i class="fas fa-search"></i> No items found matching "${searchTerm}"
                            </td>
                        </tr>
                    `);
                }
            }

            // ==================== Form Change Tracking ====================
            $(document).on('change', 'input, select, textarea', function() {
                formChanged = true;
            });

            window.addEventListener('beforeunload', function(e) {
                if (formChanged && $('#itemsContainer tr').length > 0) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                }
            });

            $('#issueForm').on('submit', function() {
                formChanged = false;
            });

            // ==================== File Upload Preview ====================
            $('#voucherDocument').on('change', function() {
                const fileName = $(this).val().split('\\').pop();
                $(this).next('.custom-file-label').html(fileName);

                const file = this.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#voucherPreviewImage').attr('src', e.target.result);
                        $('#voucherPreview').show();
                    }
                    reader.readAsDataURL(file);
                } else {
                    $('#voucherPreview').hide();
                }

                if (file && file.size > 5 * 1024 * 1024) {
                    Swal.fire({
                        icon: 'error',
                        title: 'File Too Large',
                        text: 'File size must be less than 5MB'
                    });
                    $(this).val('');
                    $(this).next('.custom-file-label').html('Choose file');
                    $('#voucherPreview').hide();
                }
            });

            // ==================== Initialize ====================
            if (!$('#IssueDate').val()) {
                const today = new Date().toISOString().split('T')[0];
                $('#IssueDate').val(today);
            }

            updateSummary();
            $('[data-toggle="tooltip"]').tooltip();

            if (typeof toastr !== 'undefined') {
                toastr.options = {
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-top-right',
                    timeOut: 3000
                };
            }

            checkProvisionStoreRequirements();
        });
    </script>
}