@model IEnumerable<IMS.Application.DTOs.IssueDto>
@{
    ViewData["Title"] = "Physical Handover";
    var issues = Model?.ToList() ?? new List<IMS.Application.DTOs.IssueDto>();
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-handshake"></i> Physical Handover
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Issues</a></li>
                    <li class="breadcrumb-item active">Physical Handover</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Summary Cards -->
        <div class="row mb-3">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>@issues.Count</h3>
                        <p>Ready for Handover</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-handshake"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>@issues.Sum(i => i.TotalItems)</h3>
                        <p>Total Items</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>@issues.Sum(i => i.TotalQuantity ?? 0).ToString("0.##")</h3>
                        <p>Total Quantity</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-cubes"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-primary">
                    <div class="inner">
                        <h3>৳ @((issues.Sum(i => i.TotalValue ?? 0) % 1 == 0) ? issues.Sum(i => i.TotalValue ?? 0).ToString("N0") : issues.Sum(i => i.TotalValue ?? 0).ToString("N2"))</h3>
                        <p>Total Value</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="card card-success card-outline">
            <div class="card-header bg-white">
                <h3 class="card-title" style="color: #333; font-weight: 600;">
                    <i class="fas fa-clipboard-list text-success"></i> Issues Ready for Physical Handover
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                @if (issues.Any())
                {
                    <!-- Search Box -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                                <input type="text" id="searchBox" class="form-control" placeholder="Search by Voucher No, Issue No, or Issued To...">
                            </div>
                        </div>
                        <div class="col-md-6 text-right">
                            <div class="btn-group">
                                <button type="button" class="btn btn-default btn-sm" onclick="window.print()">
                                    <i class="fas fa-print"></i> Print List
                                </button>
                                <button type="button" class="btn btn-info btn-sm" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table id="handoverTable" class="table table-bordered table-striped table-hover table-sm">
                            <thead class="bg-success">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="12%">Issue No</th>
                                    <th width="12%">Voucher No</th>
                                    <th width="20%">Issued To</th>
                                    <th width="10%">Type</th>
                                    <th width="8%" class="text-center">Items</th>
                                    <th width="10%" class="text-center">Quantity</th>
                                    <th width="12%" class="text-right">Value</th>
                                    <th width="11%">Approved Date</th>
                                    <th width="10%" class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var index = 1;
                                    foreach (var issue in issues)
                                    {
                                        <tr>
                                            <td><strong>@(index++)</strong></td>
                                            <td>
                                                <a asp-action="Details" asp-route-id="@issue.Id" class="text-primary" target="_blank">
                                                    <strong>@issue.IssueNo</strong>
                                                </a>
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(issue.VoucherNumber))
                                                {
                                                    <span class="badge badge-success">@issue.VoucherNumber</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <strong>@issue.IssuedToName</strong>
                                                @if (!string.IsNullOrEmpty(issue.DeliveryLocation))
                                                {
                                                    <br />
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt"></i> @issue.DeliveryLocation
                                                    </small>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge badge-info">@issue.IssuedToType</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge badge-primary">@issue.TotalItems</span>
                                            </td>
                                            <td class="text-center">
                                                <strong>@issue.TotalQuantity?.ToString("0.##")</strong>
                                            </td>
                                            <td class="text-right">
                                                @if (issue.TotalValue.HasValue && issue.TotalValue.Value > 0)
                                                {
                                                    <strong class="text-success">৳ @((issue.TotalValue.Value % 1 == 0) ? issue.TotalValue.Value.ToString("N0") : issue.TotalValue.Value.ToString("N2"))</strong>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <small>@issue.ApprovedDate?.ToString("dd MMM yyyy")</small>
                                            </td>
                                            <td class="text-center">
                                                <a asp-action="ProcessHandover" asp-route-id="@issue.Id"
                                                   class="btn btn-success btn-sm"
                                                   data-toggle="tooltip" title="Process Physical Handover">
                                                    <i class="fas fa-handshake"></i> Process
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            <tfoot>
                                <tr class="bg-light">
                                    <td colspan="5" class="text-right"><strong>Totals:</strong></td>
                                    <td class="text-center"><strong>@issues.Sum(i => i.TotalItems)</strong></td>
                                    <td class="text-center"><strong>@issues.Sum(i => i.TotalQuantity ?? 0).ToString("0.##")</strong></td>
                                    <td class="text-right">
                                        <strong class="text-success">
                                            ৳ @((issues.Sum(i => i.TotalValue ?? 0) % 1 == 0) ? issues.Sum(i => i.TotalValue ?? 0).ToString("N0") : issues.Sum(i => i.TotalValue ?? 0).ToString("N2"))
                                        </strong>
                                    </td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info text-center" style="background-color: #d1ecf1; border-color: #bee5eb;">
                        <i class="fas fa-info-circle fa-2x mb-2" style="color: #0c5460;"></i>
                        <h5 style="color: #0c5460; font-weight: 600;">No Issues Ready for Handover</h5>
                        <p class="mb-0" style="color: #0c5460;">All approved issues with vouchers have been handed over or there are no approved issues yet.</p>
                    </div>
                }
            </div>
            @if (issues.Any())
            {
                <div class="card-footer clearfix">
                    <div class="float-left">
                        <strong>@issues.Count</strong> issue(s) ready for physical handover
                    </div>
                    <div class="float-right">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> These issues have been approved and vouchers generated
                        </small>
                    </div>
                </div>
            }
        </div>

        <!-- Help Card -->
        <div class="card card-info">
            <div class="card-header bg-white">
                <h3 class="card-title" style="color: #333; font-weight: 600;">
                    <i class="fas fa-question-circle text-info"></i> Help & Instructions
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body" style="color: #333;">
                <h5 style="color: #333; font-weight: 600;"><i class="fas fa-clipboard-check text-info"></i> Physical Handover Process:</h5>
                <ol>
                    <li><strong>Select Issue:</strong> Click "Process" button for the issue you want to hand over</li>
                    <li><strong>Verify Details:</strong> Check issue details, items, and quantities</li>
                    <li><strong>Receiver Information:</strong> Enter receiver name, badge ID, and contact details</li>
                    <li><strong>Digital Signature:</strong> Receiver must provide digital signature on the signature pad</li>
                    <li><strong>Complete:</strong> Submit the handover form to finalize the process</li>
                    <li><strong>Confirmation:</strong> System will mark the issue as "Issued" and generate handover receipt</li>
                </ol>

                <div class="alert alert-warning mt-3" style="background-color: #fff3cd; border-color: #ffc107; color: #856404;">
                    <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                    <strong style="color: #856404;">Important:</strong> Ensure receiver physically verifies all items before signing. Digital signature is legally binding.
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(function() {
            // Initialize DataTable
            const table = $('#handoverTable').DataTable({
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
                "order": [[8, "desc"]], // Sort by Approved Date descending
                "pageLength": 25,
                "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip'
            });

            // Custom search
            $('#searchBox').on('keyup', function() {
                table.search(this.value).draw();
            });

            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();
        });

        // Export to Excel
        function exportToExcel() {
            const table = document.getElementById('handoverTable');
            const workbook = XLSX.utils.table_to_book(table, {sheet: "Physical Handover"});
            const filename = `Physical_Handover_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, filename);
        }
    </script>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
}