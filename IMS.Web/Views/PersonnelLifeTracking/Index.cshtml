@using IMS.Application.DTOs
@model IEnumerable<IMS.Application.DTOs.PersonnelItemIssueDto>
@{
    ViewData["Title"] = "Personnel Item Life Tracking";
    var stats = ViewBag.Stats as DashboardStatsDto;
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Personnel Item Life Tracking</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item active">Life Tracking</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <!-- Statistics -->
        <div class="row">
            <div class="col-lg-2 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>@stats?.TotalActiveItems</h3>
                        <p>Active Items</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>@stats?.ExpiredItems</h3>
                        <p>Expired</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>@stats?.ExpiringIn7Days</h3>
                        <p>Expiring in 7 Days</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>@stats?.ExpiringIn30Days</h3>
                        <p>Expiring in 30 Days</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-6">
                <div class="small-box bg-primary">
                    <div class="inner">
                        <h3>@stats?.AnsarItems</h3>
                        <p>Ansar Items</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-6">
                <div class="small-box bg-secondary">
                    <div class="inner">
                        <h3>@stats?.VDPItems</h3>
                        <p>VDP Items</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Items Requiring Attention</h3>
                <div class="card-tools">
                    <div class="btn-group">
                        <a asp-action="Create" class="btn btn-success btn-sm">
                            <i class="fas fa-plus"></i> New Issue
                        </a>
                        <a asp-action="PersonnelItems" class="btn btn-info btn-sm">
                            <i class="fas fa-user"></i> By Personnel
                        </a>
                        <a asp-action="ExpiryReport" class="btn btn-warning btn-sm">
                            <i class="fas fa-file-alt"></i> Report
                        </a>
                        <form asp-action="SendAlerts" method="post" class="d-inline">
                            <button type="submit" class="btn btn-danger btn-sm">
                                <i class="fas fa-bell"></i> Send Alerts
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Filter -->
                <div class="form-group row">
                    <label class="col-sm-2">Show items expiring in:</label>
                    <div class="col-sm-3">
                        <option value="7" selected="@(ViewBag.DaysAhead == 7)">7 days</option>
                        <option value="15" selected="@(ViewBag.DaysAhead == 15)">15 days</option>
                        <option value="30" selected="@(ViewBag.DaysAhead == 30)">30 days</option>
                        <option value="60" selected="@(ViewBag.DaysAhead == 60)">60 days</option>
                        <option value="90" selected="@(ViewBag.DaysAhead == 90)">90 days</option>
                        <option value="180" selected="@(ViewBag.DaysAhead == 180)">6 months</option>
                        <option value="270" selected="@(ViewBag.DaysAhead == 270)">9 months</option>
                        <option value="365" selected="@(ViewBag.DaysAhead == 365)">12 months</option>
                    </div>
                </div>

                <!-- Table -->
                <table class="table table-bordered table-striped" id="lifeTrackingTable">
                    <thead>
                        <tr>
                            <th>Issue No</th>
                            <th>Personnel</th>
                            <th>Type</th>
                            <th>Item</th>
                            <th>Issue Date</th>
                            <th>Received Date</th>
                            <th>Expiry Date</th>
                            <th>Days Remaining</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr class="@($"table-{item.StatusClass}")">
                                <td>@item.IssueNo</td>
                                <td>
                                    <strong>@item.PersonnelName</strong><br/>
                                    <small>@item.PersonnelBadgeNo</small>
                                </td>
                                <td>
                                    <span class="badge badge-@(item.PersonnelType == "Ansar" ? "primary" : "secondary")">
                                        @item.PersonnelType
                                    </span>
                                </td>
                                <td>
                                    <strong>@item.ItemName</strong><br/>
                                    <small>@item.ItemCode</small>
                                </td>
                                <td>@item.IssueDate.ToString("dd/MM/yyyy")</td>
                                <td>
                                    @if (item.ReceivedDate.HasValue)
                                    {
                                        @item.ReceivedDate.Value.ToString("dd/MM/yyyy")
                                    }
                                    else
                                    {
                                        <span class="text-muted">Pending</span>
                                    }
                                </td>
                                <td>
                                    @if (item.LifeExpiryDate.HasValue)
                                    {
                                        @item.LifeExpiryDate.Value.ToString("dd/MM/yyyy")
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (item.RemainingDays.HasValue)
                                    {
                                        if (item.RemainingDays <= 0)
                                        {
                                            <span class="badge badge-danger">Expired</span>
                                        }
                                        else if (item.RemainingDays <= 7)
                                        {
                                            <span class="badge badge-warning">@item.RemainingDays days</span>
                                        }
                                        else if (item.RemainingDays <= 30)
                                        {
                                            <span class="badge badge-info">@item.RemainingDays days</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-success">@item.RemainingDays days</span>
                                        }
                                    }
                                </td>
                                <td>
                                    <span class="badge badge-@item.StatusClass">@item.Status</span>
                                    @if (item.AlertCount > 0)
                                    {
                                        <br/><small>Alerts: @item.AlertCount</small>
                                    }
                                </td>
                                <td>
                                    @if (item.Status == "Active" && item.RemainingDays <= 30)
                                    {
                                        <button class="btn btn-sm btn-warning" onclick="replaceItem(@item.Id)">
                                            <i class="fas fa-sync"></i> Replace
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Replace Modal -->
<div class="modal fade" id="replaceModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Replace Item</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="replaceItemId" />
                <div class="form-group">
                    <label>Replacement Reason</label>
                    <select id="replaceReason" class="form-control">
                        <option value="Expired">Expired</option>
                        <option value="Damaged">Damaged</option>
                        <option value="Lost">Lost</option>
                        <option value="Worn Out">Worn Out</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmReplace()">Replace</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#lifeTrackingTable').DataTable({
                "order": [[7, "asc"]],
                "pageLength": 25
            });

            $('#daysFilter').change(function() {
                window.location.href = '@Url.Action("Index")?daysAhead=' + $(this).val();
            });
        });

        function replaceItem(id) {
            $('#replaceItemId').val(id);
            $('#replaceModal').modal('show');
        }

        function confirmReplace() {
            var id = $('#replaceItemId').val();
            var reason = $('#replaceReason').val();

            $.post('@Url.Action("Replace")', 
                { id: id, reason: reason }, 
                function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                }
            );
        }
    </script>
}