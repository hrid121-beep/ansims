@{
    ViewData["Title"] = "Backup & Restore";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-database"></i> Backup & Restore
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item">System</li>
                    <li class="breadcrumb-item active">Backup & Restore</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- Create Backup -->
            <div class="col-md-6">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-save"></i> Create Database Backup
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="callout callout-info">
                            <h5><i class="fas fa-info-circle"></i> Important</h5>
                            <p class="mb-0">Creating a backup will save the current state of your database. This process may take a few minutes depending on database size.</p>
                        </div>

                        <form asp-action="CreateBackup" method="post" id="backupForm">
                            @Html.AntiForgeryToken()

                            <div class="form-group">
                                <label>Backup Name (Optional)</label>
                                <input type="text" class="form-control" name="backupName" placeholder="Leave empty for auto-generated name" />
                                <small class="form-text text-muted">Default: IMS_Backup_YYYYMMDD_HHMMSS</small>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" name="includeSystemData" checked />
                                    Include System Configuration
                                </label>
                                <br />
                                <label>
                                    <input type="checkbox" name="compressBackup" checked />
                                    Compress Backup File
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block" id="createBackupBtn">
                                <i class="fas fa-save"></i> Create Backup Now
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Automatic Backup Settings -->
                <div class="card card-info card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-clock"></i> Automatic Backup Schedule
                        </h3>
                    </div>
                    <div class="card-body">
                        <form method="post" asp-action="UpdateAutoBackup">
                            @Html.AntiForgeryToken()

                            <div class="form-group">
                                <label>Enable Automatic Backups</label>
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="autoBackupSwitch" name="enabled" />
                                    <label class="custom-control-label" for="autoBackupSwitch">Automatically create backups</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Backup Frequency</label>
                                <select class="form-control" name="frequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Backup Time</label>
                                <input type="time" class="form-control" name="backupTime" value="02:00" />
                                <small class="form-text text-muted">Recommended: Off-peak hours (e.g., 2:00 AM)</small>
                            </div>

                            <div class="form-group">
                                <label>Retention Period (Days)</label>
                                <input type="number" class="form-control" name="retentionDays" value="30" min="1" max="365" />
                                <small class="form-text text-muted">Backups older than this will be automatically deleted</small>
                            </div>

                            <button type="submit" class="btn btn-info btn-block">
                                <i class="fas fa-check"></i> Save Schedule Settings
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Backup History & Restore -->
            <div class="col-md-6">
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-history"></i> Backup History
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-sm btn-tool" onclick="location.reload()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Backup Name</th>
                                        <th>Date</th>
                                        <th>Size</th>
                                        <th width="120">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Sample data - replace with actual backup list -->
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-database fa-2x mb-2"></i>
                                            <p>No backups available yet</p>
                                            <small>Create your first backup to see it here</small>
                                        </td>
                                    </tr>
                                    <!-- Example row:
                                    <tr>
                                        <td>
                                            <i class="fas fa-database text-primary"></i>
                                            IMS_Backup_20250111_143022
                                        </td>
                                        <td>
                                            <small>11/01/2025 14:30</small>
                                        </td>
                                        <td>
                                            <span class="badge badge-info">45.2 MB</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-xs btn-success" title="Restore">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                            <button class="btn btn-xs btn-info" title="Download">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button class="btn btn-xs btn-danger" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Restore from File -->
                <div class="card card-warning card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-upload"></i> Restore from File
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="callout callout-warning">
                            <h5><i class="fas fa-exclamation-triangle"></i> Warning</h5>
                            <p class="mb-0">Restoring a backup will <strong>replace all current data</strong>. Make sure to create a backup before restoring!</p>
                        </div>

                        <form asp-action="RestoreBackup" method="post" enctype="multipart/form-data" id="restoreForm">
                            @Html.AntiForgeryToken()

                            <div class="form-group">
                                <label>Select Backup File</label>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="backupFile" name="backupFile" accept=".bak,.sql,.zip" required />
                                    <label class="custom-file-label" for="backupFile">Choose file...</label>
                                </div>
                                <small class="form-text text-muted">Supported formats: .bak, .sql, .zip</small>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="confirmRestore" required />
                                    I understand this will replace all current data
                                </label>
                            </div>

                            <button type="submit" class="btn btn-warning btn-block" id="restoreBtn" disabled>
                                <i class="fas fa-undo"></i> Restore Database
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Quick Info -->
                <div class="card card-light">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-info-circle"></i> Quick Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-6">Database Size:</dt>
                            <dd class="col-sm-6">-- MB</dd>

                            <dt class="col-sm-6">Last Backup:</dt>
                            <dd class="col-sm-6">Never</dd>

                            <dt class="col-sm-6">Total Backups:</dt>
                            <dd class="col-sm-6">0</dd>

                            <dt class="col-sm-6">Backup Location:</dt>
                            <dd class="col-sm-6"><small>~/Backups/</small></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Custom file input label update
            $('.custom-file-input').on('change', function() {
                var fileName = $(this).val().split('\\').pop();
                $(this).siblings('.custom-file-label').addClass('selected').html(fileName);
            });

            // Enable restore button only when checkbox is checked
            $('#confirmRestore').on('change', function() {
                $('#restoreBtn').prop('disabled', !this.checked);
            });

            // Backup form submission
            $('#backupForm').on('submit', function(e) {
                e.preventDefault();
                var btn = $('#createBackupBtn');
                btn.prop('disabled', true);
                btn.html('<i class="fas fa-spinner fa-spin"></i> Creating Backup...');

                // Submit form
                this.submit();

                // Re-enable after 5 seconds
                setTimeout(function() {
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-save"></i> Create Backup Now');
                }, 5000);
            });

            // Restore form confirmation
            $('#restoreForm').on('submit', function(e) {
                if (!confirm('Are you sure you want to restore this backup? This action cannot be undone!')) {
                    e.preventDefault();
                    return false;
                }

                var btn = $('#restoreBtn');
                btn.prop('disabled', true);
                btn.html('<i class="fas fa-spinner fa-spin"></i> Restoring...');
            });
        });
    </script>
}
