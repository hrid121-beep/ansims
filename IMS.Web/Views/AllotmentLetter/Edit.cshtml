@model IMS.Application.DTOs.AllotmentLetterDto
@{
    ViewData["Title"] = "Edit Allotment Letter";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Edit Allotment Letter</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Allotment Letters</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <form asp-action="Edit" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="AllotmentNo" />
            <input type="hidden" asp-for="AllotmentDate" />
            <input type="hidden" asp-for="Status" />
            <input type="hidden" asp-for="CreatedBy" />
            <input type="hidden" asp-for="CreatedAt" />
            <input type="hidden" asp-for="DocumentPath" />
            <!-- Basic Information -->
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Basic Information</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Allotment No</label>
                                <input type="text" class="form-control" value="@Model.AllotmentNo" readonly />
                                <small class="text-muted">Auto-generated</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Valid From <span class="text-danger">*</span></label>
                                <input asp-for="ValidFrom" type="date" class="form-control" required />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Valid Until <span class="text-danger">*</span></label>
                                <input asp-for="ValidUntil" type="date" class="form-control" required />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>From Store <span class="text-danger">*</span></label>
                                <select asp-for="FromStoreId" asp-items="ViewBag.Stores" class="form-control select2bs4" required>
                                    <option value="">-- Select Store --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>স্মারক নং (Memo No)</label>
                                <input asp-for="ReferenceNo" id="referenceNoInput" class="form-control"
                                       placeholder="৪৪.০৩.০০০০.০১৮.১৩.০০১.২৪"
                                       pattern="[০-৯.]+" />
                                <small class="text-muted">শুধু বাংলা সংখ্যা ব্যবহার করুন। উদাহরণ: ৪৪.০৩.০০০০.০১৮.১৩.০০১.২৪ (স্পেস নিষিদ্ধ / No spaces allowed)</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Upload New Document (Optional)</label>
                                <input type="file" name="documentFile" class="form-control-file" accept=".pdf,.jpg,.jpeg,.png" />
                                <small class="text-muted">Leave empty to keep existing document</small>
                                @if (!string.IsNullOrEmpty(Model.DocumentPath))
                                {
                                    <br />
                                    <a href="@Model.DocumentPath" target="_blank" class="btn btn-sm btn-outline-info mt-2">
                                        <i class="fas fa-file"></i> View Current Document
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Purpose <span class="text-danger">*</span></label>
                                <textarea asp-for="Purpose" class="form-control" rows="2" required
                                          placeholder="Purpose of this allotment..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Government Format Fields (Bengali Support) -->
            <div class="card card-info">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-language"></i> Government Format (Optional)</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Fill these fields for government-format PDF printing with Bengali language support
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Subject (English)</label>
                                <input asp-for="Subject" class="form-control"
                                       placeholder="e.g., Allotment of Kit Bags (New Design)" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>বিষয় (বাংলায়)</label>
                                <input asp-for="SubjectBn" class="form-control"
                                       placeholder="যেমনঃ কিট ব্যাগ (নতুন নকশা) বরাদ্দ প্রদান প্রসঙ্গে" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Body Text (English)</label>
                                <textarea asp-for="BodyText" class="form-control" rows="4"
                                          placeholder="Main instructions in English (4-5 points)"></textarea>
                                <small class="text-muted">Government letter main body/instructions</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>পত্রের মূল অংশ (বাংলায়)</label>
                                <textarea asp-for="BodyTextBn" class="form-control" rows="4"
                                          placeholder="প্রধান নির্দেশনা (৪-৫টি পয়েন্ট)"></textarea>
                                <small class="text-muted">সরকারি পত্রের মূল অংশ/নির্দেশনা</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Collection Deadline</label>
                                <input asp-for="CollectionDeadline" type="date" class="form-control" />
                                <small class="text-muted">Last date to collect items</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Signatory Name</label>
                                <input asp-for="SignatoryName" class="form-control"
                                       placeholder="e.g., এ.বি.এম. ফরহাদ, বিবিএম" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Signatory Designation (English)</label>
                                <input asp-for="SignatoryDesignation" class="form-control"
                                       placeholder="e.g., Deputy Director General" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Signatory Designation (বাংলায়)</label>
                                <input asp-for="SignatoryDesignationBn" class="form-control"
                                       placeholder="যেমনঃ উপ-মহাপরিচালক (প্রশাসন)" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Signatory ID/Code</label>
                                <input asp-for="SignatoryId" class="form-control"
                                       placeholder="e.g., DDG-ADM-001" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Signatory Phone</label>
                                <input asp-for="SignatoryPhone" class="form-control"
                                       placeholder="e.g., +880-2-XXXXXXXX" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Signatory Email</label>
                                <input asp-for="SignatoryEmail" type="email" class="form-control"
                                       placeholder="e.g., ddg.admin@ansar-vdp.gov.bd" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Bengali Date (Optional)</label>
                                <input asp-for="BengaliDate" class="form-control"
                                       placeholder="e.g., ভাদ্র ১৪৩২ বঙ্গাব্দ" />
                                <small class="text-muted">Auto-generated if left blank</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recipients Section (NEW) -->
            <div class="card card-info">
                <div class="card-header">
                    <h3 class="card-title">Recipients & Items</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-success btn-sm" onclick="addRecipient()">
                            <i class="fas fa-plus"></i> Add Recipient
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="recipientsContainer">
                        <!-- Recipients will be added here -->
                    </div>
                    <div class="text-center text-muted" id="noRecipientsMessage">
                        <p>Click "Add Recipient" to start adding recipients and their items</p>
                    </div>
                </div>
            </div>

            <!-- Distribution List Section (অনুলিপি) -->
            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-share-alt"></i> Distribution List (অনুলিপি)</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-default btn-sm" onclick="useDefaultDistribution()">
                            <i class="fas fa-copy"></i> Use Default List
                        </button>
                        <button type="button" class="btn btn-success btn-sm" onclick="addDistributionEntry()">
                            <i class="fas fa-plus"></i> Add Entry
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Distribution List (অনুলিপি)</strong> - Specify who should receive copies of this allotment letter.
                        Use "Default List" for standard distribution or add custom entries.
                    </div>
                    <div id="distributionContainer">
                        <!-- Distribution entries will be added here -->
                    </div>
                    <div class="text-center text-muted" id="noDistributionMessage">
                        <p>Click "Use Default List" to use standard distribution list or "Add Entry" to add custom entries</p>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="card">
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> Update Allotment Letter
                    </button>
                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    <script>
        let recipientIndex = 0;
        const items = @Html.Raw(Json.Serialize(ViewBag.Items));
        const ranges = @Html.Raw(Json.Serialize(ViewBag.RangesList ?? new List<object>()));
        const battalions = @Html.Raw(Json.Serialize(ViewBag.BattalionsList ?? new List<object>()));
        const zilas = @Html.Raw(Json.Serialize(ViewBag.ZilasList ?? new List<object>()));
        const upazilas = @Html.Raw(Json.Serialize(ViewBag.UpazilasList ?? new List<object>()));

        $(document).ready(function() {
            $('.select2bs4').select2({ theme: 'bootstrap4' });
        });

        function addRecipient() {
            $('#noRecipientsMessage').hide();

            const recipientHtml = `
                <div class="card card-outline card-success recipient-card" data-index="${recipientIndex}" style="border-left: 4px solid #28a745;">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="fas fa-map-marker-alt"></i> Recipient #${recipientIndex + 1}
                        </h5>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool text-danger" onclick="removeRecipient(${recipientIndex})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>Serial No <span class="text-danger">*</span></label>
                                    <input name="Recipients[${recipientIndex}].SerialNo" type="number"
                                           class="form-control" value="${recipientIndex + 1}" min="1" required />
                                    <small class="text-muted">Order in PDF</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Entity Type <span class="text-danger">*</span></label>
                                    <select name="Recipients[${recipientIndex}].RecipientType"
                                            class="form-control recipient-type"
                                            data-index="${recipientIndex}" required>
                                        <option value="">-- Select Type --</option>
                                        <option value="Range">Range (→Battalions)</option>
                                        <option value="Battalion">Battalion (Direct)</option>
                                        <option value="Zila">Zila (→Upazilas)</option>
                                        <option value="Upazila">Upazila (→Unions)</option>
                                        <option value="Union">Union (Direct)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Parent Entity <span class="text-danger">*</span></label>
                                    <select id="entitySelect_${recipientIndex}"
                                            class="form-control entity-select"
                                            data-index="${recipientIndex}" required disabled>
                                        <option value="">-- Select Parent --</option>
                                    </select>
                                    <small class="text-muted" id="entityHelp_${recipientIndex}"></small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Recipient <span class="text-danger">*</span></label>
                                    <select id="recipientSelect_${recipientIndex}"
                                            class="form-control recipient-select"
                                            data-index="${recipientIndex}" required disabled>
                                        <option value="">-- Select Recipient --</option>
                                    </select>
                                    <small class="text-muted" id="recipientHelp_${recipientIndex}"></small>
                                </div>
                            </div>
                        </div>

                        <!-- Bengali Fields for Recipient -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>বাংলা নাম (Recipient Name in Bengali)</label>
                                    <input type="text" name="Recipients[${recipientIndex}].RecipientNameBn"
                                           class="form-control"
                                           placeholder="যেমনঃ কক্সবাজার আনসার ব্যাটালিয়ন (১ বিএন)" />
                                    <small class="text-muted">Bengali name for government format PDF</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>কর্মরত জনবল (Staff Strength)</label>
                                    <input type="text" name="Recipients[${recipientIndex}].StaffStrength"
                                           class="form-control"
                                           placeholder="যেমনঃ ৫০০" />
                                    <small class="text-muted">Optional: Number of personnel (in Bengali numerals)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Recipient Name (populated from selected entity) -->
                        <input type="hidden" name="Recipients[${recipientIndex}].RecipientName"
                               id="recipientName_${recipientIndex}" />
                        <input type="hidden" name="Recipients[${recipientIndex}].RangeId"
                               id="rangeId_${recipientIndex}" />
                        <input type="hidden" name="Recipients[${recipientIndex}].BattalionId"
                               id="battalionId_${recipientIndex}" />
                        <input type="hidden" name="Recipients[${recipientIndex}].ZilaId"
                               id="zilaId_${recipientIndex}" />
                        <input type="hidden" name="Recipients[${recipientIndex}].UpazilaId"
                               id="upazilaId_${recipientIndex}" />
                        <input type="hidden" name="Recipients[${recipientIndex}].UnionId"
                               id="unionId_${recipientIndex}" />

                        <!-- Items for this recipient -->
                        <div class="mt-3">
                            <label><strong>Items for this Recipient:</strong></label>
                            <button type="button" class="btn btn-primary btn-xs ml-2"
                                    onclick="addRecipientItem(${recipientIndex})">
                                <i class="fas fa-plus"></i> Add Item
                            </button>

                            <table class="table table-sm table-bordered mt-2">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="20%">Item</th>
                                        <th width="20%">বাংলা নাম</th>
                                        <th width="12%">Quantity</th>
                                        <th width="10%">Unit</th>
                                        <th width="10%">একক (Bn)</th>
                                        <th width="20%">Remarks</th>
                                        <th width="8%"></th>
                                    </tr>
                                </thead>
                                <tbody id="recipientItems_${recipientIndex}">
                                    <!-- Items will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            $('#recipientsContainer').append(recipientHtml);

            // Initialize event handlers for this recipient using IIFE to capture correct index
            (function(idx) {
                $(`.recipient-type[data-index="${idx}"]`).change(function() {
                    updateEntityDropdown(idx);
                });

                $(`.entity-select[data-index="${idx}"]`).change(function() {
                    loadRecipientDropdown(idx);
                });

                $(`.recipient-select[data-index="${idx}"]`).change(function() {
                    updateRecipientData(idx);
                });
            })(recipientIndex);

            recipientIndex++;
        }

        function updateEntityDropdown(index) {
            const type = $(`.recipient-type[data-index="${index}"]`).val();
            const entitySelect = $(`#entitySelect_${index}`);
            const recipientSelect = $(`#recipientSelect_${index}`);

            entitySelect.html('<option value="">-- Select Parent --</option>');
            recipientSelect.html('<option value="">-- Select Recipient --</option>');
            recipientSelect.prop('disabled', true);

            // Clear help text
            $(`#entityHelp_${index}`).text('');
            $(`#recipientHelp_${index}`).text('');

            // If no type selected, keep dropdown disabled
            if (!type) {
                entitySelect.prop('disabled', true);
                return;
            }

            // Enable dropdown and populate based on type
            entitySelect.prop('disabled', false);

            let data = [];
            let helpText = '';
            let recipientHelpText = '';

            if (type === 'Range') {
                data = ranges;
                helpText = 'Select Range';
                recipientHelpText = 'Then select Battalion under that Range';
            } else if (type === 'Battalion') {
                data = battalions;
                helpText = 'Select Battalion directly';
                recipientSelect.prop('disabled', false);
                recipientSelect.html('<option value="">Auto-filled</option>');
            } else if (type === 'Zila') {
                data = zilas;
                helpText = 'Select Zila';
                recipientHelpText = 'Then select Upazila under that Zila';
            } else if (type === 'Upazila') {
                data = upazilas;
                helpText = 'Select Upazila';
                recipientHelpText = 'Then select Union under that Upazila';
            } else if (type === 'Union') {
                // For Union, load all unions (if needed, or make it direct selection)
                helpText = 'Union selected directly';
                recipientSelect.prop('disabled', false);
                recipientSelect.html('<option value="">Auto-filled</option>');
            }

            $(`#entityHelp_${index}`).text(helpText);
            $(`#recipientHelp_${index}`).text(recipientHelpText);

            data.forEach(entity => {
                entitySelect.append(`<option value="${entity.id}">${entity.name}</option>`);
            });

            // Clear hidden fields
            $(`#rangeId_${index}, #battalionId_${index}, #zilaId_${index}, #upazilaId_${index}, #unionId_${index}`).val('');
            $(`#recipientName_${index}`).val('');
        }

        function loadRecipientDropdown(index) {
            const type = $(`.recipient-type[data-index="${index}"]`).val();
            const parentEntityId = $(`#entitySelect_${index}`).val();
            const recipientSelect = $(`#recipientSelect_${index}`);

            recipientSelect.html('<option value="">-- Loading... --</option>');

            if (!parentEntityId) {
                recipientSelect.prop('disabled', true);
                return;
            }

            // For direct selection (Battalion, Union), auto-fill
            if (type === 'Battalion') {
                const entityName = $(`#entitySelect_${index} option:selected`).text();
                $(`#recipientName_${index}`).val(entityName);
                $(`#battalionId_${index}`).val(parentEntityId);
                recipientSelect.html(`<option value="${parentEntityId}">${entityName}</option>`);
                recipientSelect.val(parentEntityId);
                recipientSelect.prop('disabled', true);
                return;
            }

            if (type === 'Union') {
                const entityName = $(`#entitySelect_${index} option:selected`).text();
                $(`#recipientName_${index}`).val(entityName);
                $(`#unionId_${index}`).val(parentEntityId);
                recipientSelect.html(`<option value="${parentEntityId}">${entityName}</option>`);
                recipientSelect.val(parentEntityId);
                recipientSelect.prop('disabled', true);
                return;
            }

            // For cascading selection (Range→Battalion, Zila→Upazila, Upazila→Union)
            let apiUrl = '';
            if (type === 'Range') apiUrl = `/AllotmentLetter/GetBattalionsByRange?rangeId=${parentEntityId}`;
            else if (type === 'Zila') apiUrl = `/AllotmentLetter/GetUpazilasByZila?zilaId=${parentEntityId}`;
            else if (type === 'Upazila') apiUrl = `/AllotmentLetter/GetUnionsByUpazila?upazilaId=${parentEntityId}`;

            if (apiUrl) {
                $.getJSON(apiUrl, function(data) {
                    recipientSelect.html('<option value="">-- Select Recipient --</option>');
                    if (data.length === 0) {
                        recipientSelect.append('<option value="">No recipients found</option>');
                        recipientSelect.prop('disabled', true);
                    } else {
                        data.forEach(item => {
                            recipientSelect.append(`<option value="${item.id}">${item.name}</option>`);
                        });
                        recipientSelect.prop('disabled', false);
                    }
                }).fail(function() {
                    recipientSelect.html('<option value="">Error loading recipients</option>');
                    recipientSelect.prop('disabled', true);
                });
            }
        }

        function updateRecipientData(index) {
            const type = $(`.recipient-type[data-index="${index}"]`).val();
            const recipientId = $(`#recipientSelect_${index}`).val();
            const recipientName = $(`#recipientSelect_${index} option:selected`).text();

            // Set recipient name
            $(`#recipientName_${index}`).val(recipientName);

            // Set appropriate ID field based on final recipient type
            $(`#rangeId_${index}, #battalionId_${index}, #zilaId_${index}, #upazilaId_${index}, #unionId_${index}`).val('');

            if (type === 'Range') {
                // Final recipient is Battalion
                $(`#battalionId_${index}`).val(recipientId);
            } else if (type === 'Battalion') {
                $(`#battalionId_${index}`).val(recipientId);
            } else if (type === 'Zila') {
                // Final recipient is Upazila
                $(`#upazilaId_${index}`).val(recipientId);
            } else if (type === 'Upazila') {
                // Final recipient is Union
                $(`#unionId_${index}`).val(recipientId);
            } else if (type === 'Union') {
                $(`#unionId_${index}`).val(recipientId);
            }
        }

        function addRecipientItem(recipientIdx) {
            const currentItemCount = $(`#recipientItems_${recipientIdx} tr`).length;

            const itemOptions = items.map(item =>
                `<option value="${item.id}">${item.itemCode} - ${item.name}</option>`
            ).join('');

            const row = `
                <tr data-item-index="${currentItemCount}">
                    <td>
                        <select name="Recipients[${recipientIdx}].Items[${currentItemCount}].ItemId"
                                class="form-control form-control-sm item-select"
                                data-recipient-idx="${recipientIdx}"
                                data-item-idx="${currentItemCount}" required>
                            <option value="">-- Select Item --</option>
                            ${itemOptions}
                        </select>
                        <input type="hidden" name="Recipients[${recipientIdx}].Items[${currentItemCount}].ItemName"
                               id="itemName_${recipientIdx}_${currentItemCount}" />
                        <input type="hidden" name="Recipients[${recipientIdx}].Items[${currentItemCount}].ItemCode"
                               id="itemCode_${recipientIdx}_${currentItemCount}" />
                    </td>
                    <td>
                        <input name="Recipients[${recipientIdx}].Items[${currentItemCount}].ItemNameBn"
                               type="text" class="form-control form-control-sm"
                               placeholder="যেমনঃ কিট ব্যাগ" />
                    </td>
                    <td>
                        <input name="Recipients[${recipientIdx}].Items[${currentItemCount}].AllottedQuantity"
                               type="number" class="form-control form-control-sm"
                               min="1" step="0.01" required />
                    </td>
                    <td>
                        <input name="Recipients[${recipientIdx}].Items[${currentItemCount}].Unit"
                               type="text" class="form-control form-control-sm" value="PCS" />
                    </td>
                    <td>
                        <input name="Recipients[${recipientIdx}].Items[${currentItemCount}].UnitBn"
                               type="text" class="form-control form-control-sm"
                               placeholder="টি" />
                    </td>
                    <td>
                        <input name="Recipients[${recipientIdx}].Items[${currentItemCount}].Remarks"
                               type="text" class="form-control form-control-sm" placeholder="Optional" />
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-xs"
                                onclick="removeRecipientItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

            $(`#recipientItems_${recipientIdx}`).append(row);

            // Attach change event to item dropdown to populate ItemName, ItemCode, and Unit
            $(`#recipientItems_${recipientIdx} .item-select`).last().change(function() {
                const selectedItemId = parseInt($(this).val());
                const recipIdx = $(this).data('recipient-idx');
                const itmIdx = $(this).data('item-idx');

                if (selectedItemId) {
                    const selectedItem = items.find(item => item.id === selectedItemId);
                    if (selectedItem) {
                        // Populate hidden fields
                        $(`#itemName_${recipIdx}_${itmIdx}`).val(selectedItem.name);
                        $(`#itemCode_${recipIdx}_${itmIdx}`).val(selectedItem.itemCode);

                        // Populate Unit field from item
                        const unitInput = $(this).closest('tr').find('input[name*=".Unit"]').not('[name*="UnitBn"]');
                        if (selectedItem.unit) {
                            unitInput.val(selectedItem.unit);
                        }
                    }
                }
            });
        }

        function removeRecipientItem(btn) {
            $(btn).closest('tr').remove();
        }

        function removeRecipient(index) {
            if (confirm('Are you sure you want to remove this recipient?')) {
                $(`.recipient-card[data-index="${index}"]`).remove();

                // Show message if no recipients left
                if ($('#recipientsContainer .recipient-card').length === 0) {
                    $('#noRecipientsMessage').show();
                }
            }
        }

        // Validation before submit
        $('form').submit(function(e) {
            const recipientCount = $('#recipientsContainer .recipient-card').length;

            if (recipientCount === 0) {
                e.preventDefault();
                alert('Please add at least one recipient with items.');
                return false;
            }

            // Check each recipient has at least one item
            let hasError = false;
            $('.recipient-card').each(function() {
                const index = $(this).data('index');
                const itemCount = $(`#recipientItems_${index} tr`).length;
                if (itemCount === 0) {
                    alert(`Recipient #${index + 1} must have at least one item.`);
                    hasError = true;
                    return false;
                }
            });

            if (hasError) {
                e.preventDefault();
                return false;
            }
        });

        // ===== Distribution List Functions =====
        let distributionIndex = 0;

        function addDistributionEntry() {
            $('#noDistributionMessage').hide();

            const entryHtml = `
                <div class="card card-outline card-warning distribution-entry" data-dist-index="${distributionIndex}" style="border-left: 3px solid #ffc107; margin-bottom: 10px;">
                    <div class="card-header py-2">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-user-tie"></i> Entry #<span class="entry-serial">${distributionIndex + 1}</span>
                        </h6>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool text-danger" onclick="removeDistribution(${distributionIndex})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div class="row">
                            <div class="col-md-1">
                                <div class="form-group mb-2">
                                    <label class="small">ক্রম</label>
                                    <input name="DistributionList[${distributionIndex}].SerialNo"
                                           type="number" class="form-control form-control-sm"
                                           value="${distributionIndex + 1}" min="1" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="small">Recipient Title (English)</label>
                                    <input name="DistributionList[${distributionIndex}].RecipientTitle"
                                           type="text" class="form-control form-control-sm"
                                           placeholder="e.g., Director General" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="small">প্রাপক পদবি (বাংলা) <span class="text-danger">*</span></label>
                                    <input name="DistributionList[${distributionIndex}].RecipientTitleBn"
                                           type="text" class="form-control form-control-sm"
                                           placeholder="যেমনঃ মহাপরিচালক মহোদয়ের সচিবালয়" required />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-2">
                                    <label class="small">Purpose (English)</label>
                                    <input name="DistributionList[${distributionIndex}].Purpose"
                                           type="text" class="form-control form-control-sm"
                                           placeholder="e.g., For information" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-2">
                                    <label class="small">উদ্দেশ্য (বাংলা)</label>
                                    <input name="DistributionList[${distributionIndex}].PurposeBn"
                                           type="text" class="form-control form-control-sm"
                                           placeholder="যেমনঃ অবগতির জন্য" />
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group mb-2">
                                    <label class="small">Order</label>
                                    <input name="DistributionList[${distributionIndex}].DisplayOrder"
                                           type="number" class="form-control form-control-sm"
                                           value="${distributionIndex}" min="0" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="small">Address (English)</label>
                                    <input name="DistributionList[${distributionIndex}].Address"
                                           type="text" class="form-control form-control-sm"
                                           placeholder="e.g., Ansar-VDP HQ, Khilgaon, Dhaka" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="small">ঠিকানা (বাংলা)</label>
                                    <input name="DistributionList[${distributionIndex}].AddressBn"
                                           type="text" class="form-control form-control-sm"
                                           placeholder="যেমনঃ বাংলাদেশ আনসার ও গ্রাম প্রতিরক্ষা বাহিনী, সদর দপ্তর, খিলগাঁও, ঢাকা।" />
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="DistributionList[${distributionIndex}].AllotmentLetterId" value="@Model.Id" />
                    </div>
                </div>
            `;

            $('#distributionContainer').append(entryHtml);
            distributionIndex++;
        }

        function removeDistribution(index) {
            if (confirm('Remove this distribution entry?')) {
                $(`.distribution-entry[data-dist-index="${index}"]`).remove();
                updateDistributionSerials();

                // Show message if no entries left
                if ($('#distributionContainer .distribution-entry').length === 0) {
                    $('#noDistributionMessage').show();
                }
            }
        }

        function updateDistributionSerials() {
            let serial = 1;
            $('.distribution-entry').each(function() {
                $(this).find('.entry-serial').text(serial);
                serial++;
            });
        }

        function useDefaultDistribution() {
            // Clear existing entries
            $('#distributionContainer').empty();
            $('#noDistributionMessage').hide();

            // Default distribution list (8 entries)
            const defaultList = [
                {
                    title: 'Director General\'s Secretariat',
                    titleBn: 'মহাপরিচালক মহোদয়ের সচিবালয়',
                    address: 'Bangladesh Ansar & VDP, HQ, Khilgaon, Dhaka',
                    addressBn: 'বাংলাদেশ আনসার ও গ্রাম প্রতিরক্ষা বাহিনী, সদর দপ্তর, খিলগাঁও, ঢাকা।',
                    purpose: '',
                    purposeBn: ''
                },
                {
                    title: 'Additional Director General\'s Office',
                    titleBn: 'অতিরিক্ত মহাপরিচালক মহোদয়ের দপ্তর',
                    address: 'Bangladesh Ansar & VDP, HQ, Khilgaon, Dhaka',
                    addressBn: 'বাংলাদেশ আনসার ও গ্রাম প্রতিরক্ষা বাহিনী, সদর দপ্তর, খিলগাঁও, ঢাকা',
                    purpose: 'For information',
                    purposeBn: 'সময় অবগতির জন্য'
                },
                {
                    title: 'Commandant',
                    titleBn: 'কমান্ডান্ট',
                    address: 'Bangladesh Ansar-VDP Academy, Safipur, Gazipur',
                    addressBn: 'বাংলাদেশ আনসার-ভিডিপি একাডেমী, সফিপুর, গাজীপুর',
                    purpose: '',
                    purposeBn: ''
                },
                {
                    title: 'Deputy Director General (Admin/Ops/Training)',
                    titleBn: 'উপমহাপরিচালক (প্রশাসন/অপারেশনস্/প্রশিক্ষণ)',
                    address: 'Bangladesh Ansar & VDP, HQ, Khilgaon, Dhaka',
                    addressBn: 'বাংলাদেশ আনসার ও গ্রাম প্রতিরক্ষা বাহিনী, সদর দপ্তর, খিলগাঁও, ঢাকা',
                    purpose: '',
                    purposeBn: ''
                },
                {
                    title: 'Deputy Director General/Director',
                    titleBn: 'উপমহাপরিচালক/পরিচালক',
                    address: 'Bangladesh Ansar & VDP (Concerned Range)',
                    addressBn: 'বাংলাদেশ আনসার ও গ্রাম প্রতিরক্ষা বাহিনী (সংশ্লিষ্ট রেঞ্জ)',
                    purpose: 'For information and necessary action',
                    purposeBn: 'সময় অবগতি ও প্রয়োজনীয় ব্যবস্থা গ্রহণের জন্য'
                },
                {
                    title: 'Assistant Director - Central Ansar/VDP Store',
                    titleBn: 'সহকারী পরিচালক - কেন্দ্রীয় আনসার/ভিডিপি ভাণ্ডার',
                    address: 'Ansar-VDP Academy, Safipur, Gazipur',
                    addressBn: 'আনসার-ভিডিপি একাডেমী, সফিপুর, গাজীপুর',
                    purpose: 'For information and necessary action',
                    purposeBn: 'অবগতি ও প্রয়োজনীয় ব্যবস্থা গ্রহণের জন্য'
                },
                {
                    title: 'Quarter Master',
                    titleBn: 'কোয়াটার মাস্টার',
                    address: 'Store Branch, HQ, Khilgaon, Dhaka',
                    addressBn: 'ভাণ্ডার শাখা, সদর দপ্তর, খিলগাঁও, ঢাকা',
                    purpose: '',
                    purposeBn: ''
                },
                {
                    title: 'Office/Master Copy - Deputy Director (Store)',
                    titleBn: 'দপ্তর/মাস্টার কপি - উপপরিচালক (ভাণ্ডার)',
                    address: '',
                    addressBn: '',
                    purpose: '',
                    purposeBn: ''
                }
            ];

            // Reset distribution index
            distributionIndex = 0;

            // Add each default entry
            defaultList.forEach((entry, idx) => {
                addDistributionEntryWithData(
                    idx + 1,
                    entry.title,
                    entry.titleBn,
                    entry.address,
                    entry.addressBn,
                    entry.purpose,
                    entry.purposeBn
                );
            });
        }

        function addDistributionEntryWithData(serialNo, title, titleBn, address, addressBn, purpose, purposeBn) {
            $('#noDistributionMessage').hide();

            const entryHtml = `
                <div class="card card-outline card-warning distribution-entry" data-dist-index="${distributionIndex}" style="border-left: 3px solid #ffc107; margin-bottom: 10px;">
                    <div class="card-header py-2">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-user-tie"></i> Entry #<span class="entry-serial">${serialNo}</span>
                        </h6>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool text-danger" onclick="removeDistribution(${distributionIndex})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div class="row">
                            <div class="col-md-1">
                                <div class="form-group mb-2">
                                    <label class="small">ক্রম</label>
                                    <input name="DistributionList[${distributionIndex}].SerialNo"
                                           type="number" class="form-control form-control-sm"
                                           value="${serialNo}" min="1" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="small">Recipient Title (English)</label>
                                    <input name="DistributionList[${distributionIndex}].RecipientTitle"
                                           type="text" class="form-control form-control-sm"
                                           value="${title}" placeholder="e.g., Director General" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="small">প্রাপক পদবি (বাংলা) <span class="text-danger">*</span></label>
                                    <input name="DistributionList[${distributionIndex}].RecipientTitleBn"
                                           type="text" class="form-control form-control-sm"
                                           value="${titleBn}" placeholder="যেমনঃ মহাপরিচালক মহোদয়ের সচিবালয়" required />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-2">
                                    <label class="small">Purpose (English)</label>
                                    <input name="DistributionList[${distributionIndex}].Purpose"
                                           type="text" class="form-control form-control-sm"
                                           value="${purpose}" placeholder="e.g., For information" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-2">
                                    <label class="small">উদ্দেশ্য (বাংলা)</label>
                                    <input name="DistributionList[${distributionIndex}].PurposeBn"
                                           type="text" class="form-control form-control-sm"
                                           value="${purposeBn}" placeholder="যেমনঃ অবগতির জন্য" />
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group mb-2">
                                    <label class="small">Order</label>
                                    <input name="DistributionList[${distributionIndex}].DisplayOrder"
                                           type="number" class="form-control form-control-sm"
                                           value="${distributionIndex}" min="0" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="small">Address (English)</label>
                                    <input name="DistributionList[${distributionIndex}].Address"
                                           type="text" class="form-control form-control-sm"
                                           value="${address}" placeholder="e.g., Ansar-VDP HQ, Khilgaon, Dhaka" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="small">ঠিকানা (বাংলা)</label>
                                    <input name="DistributionList[${distributionIndex}].AddressBn"
                                           type="text" class="form-control form-control-sm"
                                           value="${addressBn}" placeholder="যেমনঃ বাংলাদেশ আনসার ও গ্রাম প্রতিরক্ষা বাহিনী, সদর দপ্তর, খিলগাঁও, ঢাকা।" />
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="DistributionList[${distributionIndex}].AllotmentLetterId" value="@Model.Id" />
                    </div>
                </div>
            `;

            $('#distributionContainer').append(entryHtml);
            distributionIndex++;
        }

        // Load existing recipients on page load (for Edit mode)
        $(document).ready(function() {
            // Load Recipients
            @if (Model.Recipients != null && Model.Recipients.Any())
            {
                <text>
                // Load existing recipients
                @foreach (var recipient in Model.Recipients)
                {
                    <text>
                    (function() {
                        const idx = recipientIndex;
                        addRecipient();

                        // Populate recipient data
                        setTimeout(function() {
                            $(`.recipient-type[data-index="${idx}"]`).val('@recipient.RecipientType').trigger('change');

                            setTimeout(function() {
                                @if (recipient.BattalionId.HasValue)
                                {
                                    <text>$(`#entitySelect_${idx}`).val(@recipient.BattalionId).trigger('change');</text>
                                }
                                else if (recipient.RangeId.HasValue)
                                {
                                    <text>$(`#entitySelect_${idx}`).val(@recipient.RangeId).trigger('change');</text>
                                }
                                else if (recipient.ZilaId.HasValue)
                                {
                                    <text>$(`#entitySelect_${idx}`).val(@recipient.ZilaId).trigger('change');</text>
                                }
                                else if (recipient.UpazilaId.HasValue)
                                {
                                    <text>$(`#entitySelect_${idx}`).val(@recipient.UpazilaId).trigger('change');</text>
                                }
                                else if (recipient.UnionId.HasValue)
                                {
                                    <text>$(`#entitySelect_${idx}`).val(@recipient.UnionId).trigger('change');</text>
                                }

                                // Populate Bengali fields
                                $(`input[name="Recipients[${idx}].RecipientNameBn"]`).val('@recipient.RecipientNameBn');
                                $(`input[name="Recipients[${idx}].StaffStrength"]`).val('@recipient.StaffStrength');

                                // Load items for this recipient
                                @foreach (var item in recipient.Items)
                                {
                                    <text>
                                    addRecipientItem(idx);
                                    const itemRow = $(`#recipientItems_${idx} tr`).last();
                                    itemRow.find('.item-select').val(@item.ItemId).trigger('change');
                                    itemRow.find('input[name*="AllottedQuantity"]').val(@item.AllottedQuantity);
                                    itemRow.find('input[name*="ItemNameBn"]').val('@item.ItemNameBn');
                                    itemRow.find('input[name*="Unit"]').not('[name*="UnitBn"]').val('@item.Unit');
                                    itemRow.find('input[name*="UnitBn"]').val('@item.UnitBn');
                                    itemRow.find('input[name*="Remarks"]').val('@item.Remarks');
                                    </text>
                                }
                            }, 500);
                        }, 100);
                    })();
                    </text>
                }
                </text>
            }
            else
            {
                <text>
                // No existing recipients, add first recipient
                addRecipient();
                </text>
            }

            // Load Distribution List
            @if (Model.DistributionList != null && Model.DistributionList.Any())
            {
                <text>
                // Load existing distribution list entries
                $('#noDistributionMessage').hide();
                @foreach (var distEntry in Model.DistributionList.OrderBy(d => d.DisplayOrder).ThenBy(d => d.SerialNo))
                {
                    <text>
                    addDistributionEntryWithData(
                        @distEntry.SerialNo,
                        '@Html.Raw(distEntry.RecipientTitle?.Replace("'", "\\'") ?? "")',
                        '@Html.Raw(distEntry.RecipientTitleBn?.Replace("'", "\\'") ?? "")',
                        '@Html.Raw(distEntry.Address?.Replace("'", "\\'") ?? "")',
                        '@Html.Raw(distEntry.AddressBn?.Replace("'", "\\'") ?? "")',
                        '@Html.Raw(distEntry.Purpose?.Replace("'", "\\'") ?? "")',
                        '@Html.Raw(distEntry.PurposeBn?.Replace("'", "\\'") ?? "")'
                    );
                    </text>
                }
                </text>
            }

            // ===== Prevent Whitespace in ReferenceNo (স্মারক নং) =====
            $('#referenceNoInput').on('keypress', function(e) {
                // Prevent spacebar (keyCode 32)
                if (e.which === 32) {
                    e.preventDefault();
                    return false;
                }
            });

            // Remove whitespace on paste
            $('#referenceNoInput').on('paste', function(e) {
                setTimeout(function() {
                    var $input = $('#referenceNoInput');
                    var value = $input.val();
                    // Remove all whitespace characters
                    $input.val(value.replace(/\s/g, ''));
                }, 10);
            });

            // Remove whitespace on blur (when user leaves field)
            $('#referenceNoInput').on('blur', function() {
                var value = $(this).val();
                $(this).val(value.replace(/\s/g, ''));
            });

            // Prevent whitespace on input (covers all scenarios)
            $('#referenceNoInput').on('input', function() {
                var value = $(this).val();
                if (/\s/.test(value)) {
                    $(this).val(value.replace(/\s/g, ''));
                }
            });
        });
    </script>
}
