@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Loss Report";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var losses = Model?.ToList() ?? new List<dynamic>();

    // Calculate statistics
    var totalLosses = losses.Count();
    var totalValue = losses.Sum(l => (decimal)l.Value);
    var damageCount = losses.Count(l => ((string)l.LossType).Equals("Damage", StringComparison.OrdinalIgnoreCase));
    var theftCount = losses.Count(l => ((string)l.LossType).Equals("Theft", StringComparison.OrdinalIgnoreCase));
    var expiryCount = losses.Count(l => ((string)l.LossType).Equals("Expiry", StringComparison.OrdinalIgnoreCase));
    var writeOffCount = losses.Count(l => ((string)l.LossType).Equals("WriteOff", StringComparison.OrdinalIgnoreCase));

    var damagePercent = totalLosses > 0 ? (damageCount * 100.0 / totalLosses) : 0;
    var theftPercent = totalLosses > 0 ? (theftCount * 100.0 / totalLosses) : 0;
    var expiryPercent = totalLosses > 0 ? (expiryCount * 100.0 / totalLosses) : 0;
    var writeOffPercent = totalLosses > 0 ? (writeOffCount * 100.0 / totalLosses) : 0;

    // Prepare chart data
    var lossesByMonthData = losses.Any()
        ? losses.GroupBy(l => new DateTime(((DateTime)l.LossDate).Year, ((DateTime)l.LossDate).Month, 1))
                 .OrderBy(g => g.Key)
                 .Take(12)
                 .Select(g => (object)new {
                     Month = g.Key.ToString("MMM yyyy"),
                     Value = g.Sum(l => (decimal)l.Value)
                 }).ToList()
        : new List<object>();
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-exclamation-triangle text-danger"></i> Loss Report
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Reports</a></li>
                    <li class="breadcrumb-item active">Loss Report</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <i class="icon fas fa-check"></i> @TempData["Success"]
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <i class="icon fas fa-ban"></i> @TempData["Error"]
            </div>
        }

        <!-- Filter Card -->
        <div class="card card-danger card-outline">
            <div class="card-header bg-light">
                <h3 class="card-title"><i class="fas fa-filter"></i> <strong>Advanced Filter Options</strong></h3>
                <div class="card-tools">
                    <span class="badge badge-info mr-2">Real-time Filtering</span>
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form asp-action="LossReport" method="get" id="filterForm">
                    <!-- Row 1: Server-side filters -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="fromDate"><i class="far fa-calendar-alt"></i> From Date:</label>
                                <input type="date" class="form-control" id="fromDate" name="fromDate" value="@ViewBag.FromDate">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="toDate"><i class="far fa-calendar-alt"></i> To Date:</label>
                                <input type="date" class="form-control" id="toDate" name="toDate" value="@ViewBag.ToDate">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="lossType"><i class="fas fa-exclamation-triangle"></i> Loss Type:</label>
                                <select class="form-control select2" id="lossType" name="lossType">
                                    @Html.Raw(ViewBag.LossTypes)
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="storeId"><i class="fas fa-warehouse"></i> Store:</label>
                                <select class="form-control select2" id="storeId" name="storeId">
                                    @Html.Raw(ViewBag.Stores)
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-danger btn-block">
                                    <i class="fas fa-search"></i> Generate
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Client-side filters -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-search"></i> Search:</label>
                                <input type="text" id="searchFilter" class="form-control" placeholder="Search by Loss No, Item, or Reason">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-greater-than-equal"></i> Min Quantity:</label>
                                <input type="number" id="minQtyFilter" class="form-control" placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-less-than-equal"></i> Max Quantity:</label>
                                <input type="number" id="maxQtyFilter" class="form-control" placeholder="999999">
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Value filters -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-greater-than-equal"></i> Min Value (৳):</label>
                                <input type="number" id="minValueFilter" class="form-control" placeholder="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-less-than-equal"></i> Max Value (৳):</label>
                                <input type="number" id="maxValueFilter" class="form-control" placeholder="999999999" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-sort-alpha-down"></i> Sort By:</label>
                                <select id="sortByFilter" class="form-control select2">
                                    <option value="">-- Default --</option>
                                    <option value="value-desc">Value (High to Low)</option>
                                    <option value="value-asc">Value (Low to High)</option>
                                    <option value="qty-desc">Quantity (High to Low)</option>
                                    <option value="qty-asc">Quantity (Low to High)</option>
                                    <option value="date-desc">Date (Newest First)</option>
                                    <option value="date-asc">Date (Oldest First)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-secondary btn-block" onclick="clearFilters()">
                                    <i class="fas fa-redo"></i> Reset Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row">
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box bg-danger">
                    <span class="info-box-icon"><i class="fas fa-times-circle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Losses</span>
                        <span class="info-box-number">@totalLosses</span>
                        <div class="progress">
                            <div class="progress-bar" style="width: 100%"></div>
                        </div>
                        <span class="progress-description">
                            ৳@totalValue.ToString("N2") Total Value
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box bg-warning">
                    <span class="info-box-icon"><i class="fas fa-hammer"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Damage</span>
                        <span class="info-box-number">@damageCount</span>
                        <div class="progress">
                            <div class="progress-bar" style="width: @damagePercent%"></div>
                        </div>
                        <span class="progress-description">
                            @damagePercent.ToString("F1")% of Total Losses
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box bg-dark">
                    <span class="info-box-icon"><i class="fas fa-user-secret"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Theft</span>
                        <span class="info-box-number">@theftCount</span>
                        <div class="progress">
                            <div class="progress-bar" style="width: @theftPercent%"></div>
                        </div>
                        <span class="progress-description">
                            @theftPercent.ToString("F1")% of Total Losses
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box bg-secondary">
                    <span class="info-box-icon"><i class="fas fa-calendar-times"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Expiry/Write-off</span>
                        <span class="info-box-number">@(expiryCount + writeOffCount)</span>
                        <div class="progress">
                            <div class="progress-bar" style="width: @(expiryPercent + writeOffPercent)%"></div>
                        </div>
                        <span class="progress-description">
                            @((expiryPercent + writeOffPercent).ToString("F1"))% of Total Losses
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loss Details Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-table"></i> Loss Details</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-success btn-sm" onclick="exportToCSV()">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table id="lossTable" class="table table-bordered table-striped table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Loss No</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Item</th>
                            <th>Store</th>
                            <th class="text-right">Quantity</th>
                            <th class="text-right">Value</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (losses.Any())
                        {
                            var serial = 1;
                            @foreach (var loss in losses.OrderByDescending(l => (DateTime)l.LossDate))
                            {
                                var lossTypeBadge = "";
                                var lossTypeText = (string)loss.LossType;
                                switch (lossTypeText.ToLower())
                                {
                                    case "damage":
                                        lossTypeBadge = "badge-warning";
                                        break;
                                    case "theft":
                                        lossTypeBadge = "badge-dark";
                                        break;
                                    case "expiry":
                                        lossTypeBadge = "badge-secondary";
                                        break;
                                    case "writeoff":
                                        lossTypeBadge = "badge-danger";
                                        lossTypeText = "Write-off";
                                        break;
                                    default:
                                        lossTypeBadge = "badge-info";
                                        break;
                                }

                                <tr>
                                    <td>@serial</td>
                                    <td><strong>@loss.LossNo</strong></td>
                                    <td>@((DateTime)loss.LossDate).ToString("dd-MMM-yyyy")</td>
                                    <td><span class="badge @lossTypeBadge">@lossTypeText</span></td>
                                    <td>@loss.ItemName</td>
                                    <td>@loss.StoreName</td>
                                    <td class="text-right">@loss.Quantity</td>
                                    <td class="text-right">৳@((decimal)loss.Value).ToString("N2")</td>
                                    <td>@loss.Reason</td>
                                </tr>
                                serial++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="9" class="text-center text-muted">
                                    <i class="fas fa-info-circle"></i> No loss records found for the selected criteria.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Row -->
        <div class="row">
            <!-- Loss Type Distribution -->
            <div class="col-md-6">
                <div class="card card-danger">
                    <div class="card-header">
                        <h3 class="card-title">Loss Type Distribution</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="pieChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Monthly Loss Trend -->
            <div class="col-md-6">
                <div class="card card-danger">
                    <div class="card-header">
                        <h3 class="card-title">Monthly Loss Value Trend</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            <canvas id="lineChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(function () {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4',
                allowClear: true
            });

            // Initialize DataTable with enhanced filtering
            var table = $("#lossTable").DataTable({
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                "pageLength": 25,
                "order": [[2, "desc"]], // Sort by date descending
                "columnDefs": [
                    { "orderable": false, "targets": 0 } // Disable sorting on serial column
                ],
                "language": {
                    "search": "Quick Table Search:",
                    "lengthMenu": "Show _MENU_ losses per page",
                    "info": "Showing _START_ to _END_ of _TOTAL_ losses",
                    "infoEmpty": "No losses available",
                    "infoFiltered": "(filtered from _MAX_ total losses)"
                }
            });

            // Apply advanced filters
            $('#searchFilter, #minQtyFilter, #maxQtyFilter, #minValueFilter, #maxValueFilter, #sortByFilter').on('change keyup', function() {
                applyAdvancedFilters();
            });

            function applyAdvancedFilters() {
                var searchFilter = $('#searchFilter').val().toLowerCase();
                var minQty = parseFloat($('#minQtyFilter').val()) || 0;
                var maxQty = parseFloat($('#maxQtyFilter').val()) || Infinity;
                var minValue = parseFloat($('#minValueFilter').val()) || 0;
                var maxValue = parseFloat($('#maxValueFilter').val()) || Infinity;
                var sortBy = $('#sortByFilter').val();

                // Custom filtering function
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        if (settings.nTable.id !== 'lossTable') return true;

                        // Column indices: 1=Loss No, 2=Date, 3=Type, 4=Item, 5=Store, 6=Quantity, 7=Value, 8=Reason
                        var rowLossNo = data[1].toLowerCase();
                        var rowItem = data[4].toLowerCase();
                        var rowReason = data[8].toLowerCase();
                        var rowQty = parseFloat(data[6].replace(/[^0-9.-]+/g, '')) || 0;
                        var rowValue = parseFloat(data[7].replace(/[^0-9.-]+/g, '')) || 0;

                        // Search filter (Loss No, Item, Reason)
                        if (searchFilter && !rowLossNo.includes(searchFilter) &&
                            !rowItem.includes(searchFilter) && !rowReason.includes(searchFilter)) return false;

                        // Quantity range filter
                        if (rowQty < minQty || rowQty > maxQty) return false;

                        // Value range filter
                        if (rowValue < minValue || rowValue > maxValue) return false;

                        return true;
                    }
                );

                table.draw();
                $.fn.dataTable.ext.search.pop();

                // Apply sorting if specified
                if (sortBy) {
                    var orderColumn, orderDir;
                    if (sortBy === 'value-desc') { orderColumn = 7; orderDir = 'desc'; }
                    else if (sortBy === 'value-asc') { orderColumn = 7; orderDir = 'asc'; }
                    else if (sortBy === 'qty-desc') { orderColumn = 6; orderDir = 'desc'; }
                    else if (sortBy === 'qty-asc') { orderColumn = 6; orderDir = 'asc'; }
                    else if (sortBy === 'date-desc') { orderColumn = 2; orderDir = 'desc'; }
                    else if (sortBy === 'date-asc') { orderColumn = 2; orderDir = 'asc'; }

                    if (orderColumn !== undefined) {
                        table.order([orderColumn, orderDir]).draw();
                    }
                }
            }

            // Pie Chart - Loss Type Distribution
            var pieChartCanvas = $('#pieChart').get(0).getContext('2d');
            var pieData = {
                labels: ['Damage', 'Theft', 'Expiry', 'Write-off'],
                datasets: [{
                    data: [@damageCount, @theftCount, @expiryCount, @writeOffCount],
                    backgroundColor: ['#ffc107', '#343a40', '#6c757d', '#dc3545']
                }]
            };
            new Chart(pieChartCanvas, {
                type: 'pie',
                data: pieData,
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Line Chart - Monthly Trend (using actual data grouped by month)
            var lossesByMonth = @Html.Raw(Json.Serialize(lossesByMonthData));

            var lineChartCanvas = $('#lineChart').get(0).getContext('2d');
            var lineChartData = {
                labels: lossesByMonth.length > 0 ? lossesByMonth.map(m => m.Month) : [],
                datasets: [{
                    label: 'Loss Value (৳)',
                    backgroundColor: 'rgba(220,53,69,0.1)',
                    borderColor: 'rgba(220,53,69,1)',
                    pointRadius: 5,
                    pointColor: '#dc3545',
                    pointStrokeColor: 'rgba(220,53,69,1)',
                    pointHighlightFill: '#fff',
                    pointHighlightStroke: 'rgba(220,53,69,1)',
                    data: lossesByMonth.length > 0 ? lossesByMonth.map(m => m.Value) : []
                }]
            };
            new Chart(lineChartCanvas, {
                type: 'line',
                data: lineChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });

        function exportToCSV() {
            var fromDate = document.getElementById('fromDate').value;
            var toDate = document.getElementById('toDate').value;
            var lossType = document.getElementById('lossType').value;
            var storeId = document.getElementById('storeId').value;

            var url = '@Url.Action("ExportLossReportCsv", "Report")' + '?';
            var params = [];

            if (fromDate) params.push('fromDate=' + fromDate);
            if (toDate) params.push('toDate=' + toDate);
            if (lossType) params.push('lossType=' + lossType);
            if (storeId) params.push('storeId=' + storeId);

            url += params.join('&');
            window.location.href = url;
        }

        function exportToPDF() {
            var fromDate = document.getElementById('fromDate').value;
            var toDate = document.getElementById('toDate').value;
            var lossType = document.getElementById('lossType').value;
            var storeId = document.getElementById('storeId').value;

            var url = '@Url.Action("ExportLossReportPdf", "Report")' + '?';
            var params = [];

            if (fromDate) params.push('fromDate=' + fromDate);
            if (toDate) params.push('toDate=' + toDate);
            if (lossType) params.push('lossType=' + lossType);
            if (storeId) params.push('storeId=' + storeId);

            url += params.join('&');
            window.location.href = url;
        }

        // Clear all filters
        function clearFilters() {
            $('#filterForm')[0].reset();
            $('.select2').val('').trigger('change');
            $('#searchFilter, #minQtyFilter, #maxQtyFilter, #minValueFilter, #maxValueFilter').val('');
            window.location.href = '@Url.Action("LossReport", "Report")';
        }
    </script>
}
