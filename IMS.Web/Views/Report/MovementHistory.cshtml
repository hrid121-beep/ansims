@{
    ViewData["Title"] = "Movement History";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Movement History</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Reports</a></li>
                    <li class="breadcrumb-item active">Movement History</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Timeline Filter -->
        <div class="card card-secondary">
            <div class="card-header bg-light">
                <h3 class="card-title">
                    <i class="fas fa-filter"></i> <strong>Advanced Filter Options</strong>
                </h3>
                <div class="card-tools">
                    <span class="badge badge-info mr-2">Real-time Filtering</span>
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form id="filterForm">
                    <!-- Row 1: Main filters -->
                    <div class="row">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-box"></i> Item:</label>
                                <select id="itemFilter" class="form-control select2" style="width: 100%;">
                                    <option value="">All Items</option>
                                    <option>Laptop Dell XPS</option>
                                    <option>Office Paper A4</option>
                                    <option>Printer HP LaserJet</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-exchange-alt"></i> Movement Type:</label>
                                <select id="typeFilter" class="form-control select2" style="width: 100%;">
                                    <option value="">All Types</option>
                                    <option>Purchase</option>
                                    <option>Issue</option>
                                    <option>Transfer</option>
                                    <option>Loss</option>
                                    <option>Return</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-warehouse"></i> Store:</label>
                                <select id="storeFilter" class="form-control select2" style="width: 100%;">
                                    <option value="">All Stores</option>
                                    <option>Main Warehouse</option>
                                    <option>Branch Store 1</option>
                                    <option>Branch Store 2</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="far fa-calendar-alt"></i> From Date:</label>
                                <input type="date" id="fromDate" class="form-control" value="2025-01-01">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="far fa-calendar-alt"></i> To Date:</label>
                                <input type="date" id="toDate" class="form-control" value="2025-01-27">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-secondary btn-block">
                                    <i class="fas fa-search"></i> Generate
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Additional filters -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label><i class="fas fa-search"></i> Search:</label>
                                <input type="text" id="searchFilter" class="form-control"
                                       placeholder="Search by Reference No, User, or Item">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-greater-than-equal"></i> Min Quantity:</label>
                                <input type="number" id="minQtyFilter" class="form-control" placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-less-than-equal"></i> Max Quantity:</label>
                                <input type="number" id="maxQtyFilter" class="form-control" placeholder="99999">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-sort-alpha-down"></i> Sort By:</label>
                                <select id="sortByFilter" class="form-control select2">
                                    <option value="">-- Default --</option>
                                    <option value="date-desc">Date (Newest First)</option>
                                    <option value="date-asc">Date (Oldest First)</option>
                                    <option value="qty-desc">Quantity (High to Low)</option>
                                    <option value="qty-asc">Quantity (Low to High)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-secondary btn-block" onclick="clearFilters()">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Movement Statistics -->
        <div class="row">
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-info"><i class="fas fa-shopping-cart"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Purchases</span>
                        <span class="info-box-number">1,410</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-success"><i class="fas fa-arrow-right"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Issues</span>
                        <span class="info-box-number">892</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-warning"><i class="fas fa-exchange-alt"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Transfers</span>
                        <span class="info-box-number">234</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-danger"><i class="fas fa-times"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Losses</span>
                        <span class="info-box-number">56</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movement History Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Complete Movement History</h3>
                <div class="card-tools">
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <input type="text" name="table_search" class="form-control float-right" placeholder="Search">
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-default">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <table id="movementTable" class="table table-bordered table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Movement ID</th>
                            <th>Type</th>
                            <th>Item</th>
                            <th data-type="num">Quantity</th>
                            <th>From</th>
                            <th>To</th>
                            <th>User</th>
                            <th>Reference</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2025-01-27 14:30</td>
                            <td>MV-2025-1234</td>
                            <td><span class="badge badge-success">Issue</span></td>
                            <td>Office Paper A4</td>
                            <td>-5 Reams</td>
                            <td>Main Warehouse</td>
                            <td>Admin Dept</td>
                            <td>John Doe</td>
                            <td>ISS-2025-045</td>
                            <td>Monthly supply</td>
                        </tr>
                        <tr>
                            <td>2025-01-27 12:15</td>
                            <td>MV-2025-1233</td>
                            <td><span class="badge badge-info">Purchase</span></td>
                            <td>Laptop Dell XPS</td>
                            <td>+10 Units</td>
                            <td>ABC Suppliers</td>
                            <td>Main Warehouse</td>
                            <td>Jane Smith</td>
                            <td>PO-2025-023</td>
                            <td>New stock arrival</td>
                        </tr>
                        <tr>
                            <td>2025-01-26 16:45</td>
                            <td>MV-2025-1232</td>
                            <td><span class="badge badge-warning">Transfer</span></td>
                            <td>Printer HP LaserJet</td>
                            <td>2 Units</td>
                            <td>Branch Store 1</td>
                            <td>Branch Store 2</td>
                            <td>Mike Johnson</td>
                            <td>TRF-2025-018</td>
                            <td>Store rebalancing</td>
                        </tr>
                        <tr>
                            <td>2025-01-26 10:20</td>
                            <td>MV-2025-1231</td>
                            <td><span class="badge badge-danger">Loss</span></td>
                            <td>Monitor 24"</td>
                            <td>-1 Unit</td>
                            <td>Main Warehouse</td>
                            <td>-</td>
                            <td>Sarah Wilson</td>
                            <td>LS-2025-012</td>
                            <td>Damaged in storage</td>
                        </tr>
                        <tr>
                            <td>2025-01-25 15:30</td>
                            <td>MV-2025-1230</td>
                            <td><span class="badge badge-primary">Return</span></td>
                            <td>Office Chair</td>
                            <td>+3 Units</td>
                            <td>HR Dept</td>
                            <td>Main Warehouse</td>
                            <td>Emily Brown</td>
                            <td>RET-2025-005</td>
                            <td>Excess inventory</td>
                        </tr>
                        <tr>
                            <td>2025-01-25 09:00</td>
                            <td>MV-2025-1229</td>
                            <td><span class="badge badge-success">Issue</span></td>
                            <td>Notebooks</td>
                            <td>-50 Units</td>
                            <td>Main Warehouse</td>
                            <td>Sales Dept</td>
                            <td>David Wilson</td>
                            <td>ISS-2025-044</td>
                            <td>Training materials</td>
                        </tr>
                        <tr>
                            <td>2025-01-24 14:20</td>
                            <td>MV-2025-1228</td>
                            <td><span class="badge badge-info">Purchase</span></td>
                            <td>Cleaning Supplies</td>
                            <td>+20 Sets</td>
                            <td>CleanCo Ltd</td>
                            <td>Main Warehouse</td>
                            <td>Mike Davis</td>
                            <td>PO-2025-022</td>
                            <td>Monthly restock</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Movement Timeline -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-clock"></i>
                            Movement Timeline
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            <!-- Timeline item -->
                            <div class="time-label">
                                <span class="bg-red">27 Jan 2025</span>
                            </div>
                            <div>
                                <i class="fas fa-arrow-right bg-success"></i>
                                <div class="timeline-item">
                                    <span class="time"><i class="fas fa-clock"></i> 14:30</span>
                                    <h3 class="timeline-header">Issue to Admin Department</h3>
                                    <div class="timeline-body">
                                        5 Reams of Office Paper A4 issued from Main Warehouse
                                    </div>
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-shopping-cart bg-info"></i>
                                <div class="timeline-item">
                                    <span class="time"><i class="fas fa-clock"></i> 12:15</span>
                                    <h3 class="timeline-header">Purchase Received</h3>
                                    <div class="timeline-body">
                                        10 Units of Laptop Dell XPS received from ABC Suppliers
                                    </div>
                                </div>
                            </div>

                            <div class="time-label">
                                <span class="bg-green">26 Jan 2025</span>
                            </div>
                            <div>
                                <i class="fas fa-exchange-alt bg-warning"></i>
                                <div class="timeline-item">
                                    <span class="time"><i class="fas fa-clock"></i> 16:45</span>
                                    <h3 class="timeline-header">Store Transfer</h3>
                                    <div class="timeline-body">
                                        2 Units of Printer HP LaserJet transferred from Branch Store 1 to Branch Store 2
                                    </div>
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-times bg-danger"></i>
                                <div class="timeline-item">
                                    <span class="time"><i class="fas fa-clock"></i> 10:20</span>
                                    <h3 class="timeline-header">Loss Reported</h3>
                                    <div class="timeline-body">
                                        1 Unit of Monitor 24" damaged in Main Warehouse storage
                                    </div>
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-clock bg-gray"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movement Summary Chart -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Daily Movement Summary</h3>
            </div>
            <div class="card-body">
                <div class="chart">
                    <canvas id="movementChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(function () {
            //Initialize Select2 Elements with theme
            $('.select2').select2({
                theme: 'bootstrap4',
                allowClear: true
            });

            // Initialize DataTable with enhanced filtering
            var table = $("#movementTable").DataTable({
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                "pageLength": 25,
                "order": [[0, "desc"]], // Sort by Date/Time descending
                "language": {
                    "search": "Quick Table Search:",
                    "lengthMenu": "Show _MENU_ movements per page",
                    "info": "Showing _START_ to _END_ of _TOTAL_ movements",
                    "infoEmpty": "No movements available",
                    "infoFiltered": "(filtered from _MAX_ total movements)"
                }
            });

            // Apply advanced filters
            $('#itemFilter, #typeFilter, #storeFilter, #searchFilter, #minQtyFilter, #maxQtyFilter, #sortByFilter').on('change keyup', function() {
                applyAdvancedFilters();
            });

            function applyAdvancedFilters() {
                var itemFilter = $('#itemFilter').val().toLowerCase();
                var typeFilter = $('#typeFilter').val().toLowerCase();
                var storeFilter = $('#storeFilter').val().toLowerCase();
                var searchFilter = $('#searchFilter').val().toLowerCase();
                var minQty = parseFloat($('#minQtyFilter').val()) || 0;
                var maxQty = parseFloat($('#maxQtyFilter').val()) || Infinity;
                var sortBy = $('#sortByFilter').val();

                // Custom filtering function
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        if (settings.nTable.id !== 'movementTable') return true;

                        // Column indices: 0=Date, 1=MovementID, 2=Type, 3=Item, 4=Qty, 5=From, 6=To, 7=User, 8=Ref, 9=Notes
                        var rowType = data[2].toLowerCase();
                        var rowItem = data[3].toLowerCase();
                        var rowFrom = data[5].toLowerCase();
                        var rowTo = data[6].toLowerCase();
                        var rowUser = data[7].toLowerCase();
                        var rowRef = data[8].toLowerCase();
                        var rowQtyText = data[4];
                        var rowQty = Math.abs(parseFloat(rowQtyText.replace(/[^0-9.-]+/g, ''))) || 0;

                        // Item filter
                        if (itemFilter && !rowItem.includes(itemFilter)) return false;

                        // Type filter
                        if (typeFilter && !rowType.includes(typeFilter)) return false;

                        // Store filter (From or To)
                        if (storeFilter && !rowFrom.includes(storeFilter) && !rowTo.includes(storeFilter)) return false;

                        // Search filter (Movement ID, Item, User, Reference)
                        if (searchFilter && !data[1].toLowerCase().includes(searchFilter) &&
                            !rowItem.includes(searchFilter) && !rowUser.includes(searchFilter) &&
                            !rowRef.includes(searchFilter)) return false;

                        // Quantity range filter
                        if (rowQty < minQty || rowQty > maxQty) return false;

                        return true;
                    }
                );

                table.draw();
                $.fn.dataTable.ext.search.pop();

                // Apply sorting if specified
                if (sortBy) {
                    var orderColumn, orderDir;
                    if (sortBy === 'date-desc') { orderColumn = 0; orderDir = 'desc'; }
                    else if (sortBy === 'date-asc') { orderColumn = 0; orderDir = 'asc'; }
                    else if (sortBy === 'qty-desc') { orderColumn = 4; orderDir = 'desc'; }
                    else if (sortBy === 'qty-asc') { orderColumn = 4; orderDir = 'asc'; }

                    if (orderColumn !== undefined) {
                        table.order([orderColumn, orderDir]).draw();
                    }
                }
            }

            // Movement Chart
            var movementChartCanvas = $('#movementChart').get(0).getContext('2d');
            var movementChartData = {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [
                    {
                        label: 'Purchases',
                        backgroundColor: '#17a2b8',
                        borderColor: '#17a2b8',
                        data: [65, 59, 80, 81, 56, 55, 40]
                    },
                    {
                        label: 'Issues',
                        backgroundColor: '#28a745',
                        borderColor: '#28a745',
                        data: [28, 48, 40, 19, 86, 27, 90]
                    },
                    {
                        label: 'Transfers',
                        backgroundColor: '#ffc107',
                        borderColor: '#ffc107',
                        data: [18, 28, 20, 29, 16, 17, 20]
                    },
                    {
                        label: 'Losses',
                        backgroundColor: '#dc3545',
                        borderColor: '#dc3545',
                        data: [5, 8, 3, 6, 4, 7, 2]
                    }
                ]
            };

            var movementChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                datasetFill: false,
                scales: {
                    xAxes: [{
                        stacked: true,
                    }],
                    yAxes: [{
                        stacked: true
                    }]
                }
            };

            new Chart(movementChartCanvas, {
                type: 'bar',
                data: movementChartData,
                options: movementChartOptions
            });
        });

        // Clear all filters
        function clearFilters() {
            $('#filterForm')[0].reset();
            $('.select2').val('').trigger('change');
            $('#searchFilter, #minQtyFilter, #maxQtyFilter').val('');
            location.reload();
        }
    </script>
}