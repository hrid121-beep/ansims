@{
    ViewData["Title"] = "Issue Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Issue Report</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Reports</a></li>
                    <li class="breadcrumb-item active">Issue Report</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Filter Card -->
        <div class="card">
            <div class="card-header bg-light">
                <h3 class="card-title"><i class="fas fa-filter"></i> <strong>Advanced Filter Options</strong></h3>
                <div class="card-tools">
                    <span class="badge badge-info mr-2">Real-time Filtering</span>
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form asp-action="IssueReport" method="get" id="filterForm">
                    <div class="row">
                        <!-- From Date -->
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-calendar-alt"></i> From Date:</label>
                                <input type="date" id="fromDate" name="fromDate" class="form-control" value="@ViewBag.FromDate">
                            </div>
                        </div>

                        <!-- To Date -->
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-calendar-check"></i> To Date:</label>
                                <input type="date" id="toDate" name="toDate" class="form-control" value="@ViewBag.ToDate">
                            </div>
                        </div>

                        <!-- Store Filter -->
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-warehouse"></i> Store:</label>
                                <select id="storeId" name="storeId" class="form-control select2" asp-items="ViewBag.Stores">
                                </select>
                            </div>
                        </div>

                        <!-- Status Filter -->
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-info-circle"></i> Status:</label>
                                <select id="statusFilter" name="status" class="form-control">
                                    <option value="">All Status</option>
                                    <option value="Draft">Draft</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Issued">Issued</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Category Filter -->
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-tags"></i> Category:</label>
                                <select id="categoryFilter" name="category" class="form-control">
                                    <option value="">All Categories</option>
                                    <option value="Stationery">Stationery</option>
                                    <option value="IT Supplies">IT Supplies</option>
                                    <option value="Furniture">Furniture</option>
                                    <option value="Maintenance">Maintenance</option>
                                </select>
                            </div>
                        </div>

                        <!-- Department Filter -->
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-building"></i> Department:</label>
                                <select id="departmentFilter" name="department" class="form-control">
                                    <option value="">All Departments</option>
                                    <option value="Admin">Admin</option>
                                    <option value="IT">IT</option>
                                    <option value="HR">HR</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Facilities">Facilities</option>
                                </select>
                            </div>
                        </div>

                        <!-- Search -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-search"></i> Search (Issue#/Item/Issued To):</label>
                                <input type="text" id="searchTerm" name="searchTerm" class="form-control"
                                       placeholder="Enter issue number, item name, or recipient..." />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Min Quantity -->
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-less-than-equal"></i> Min. Qty:</label>
                                <input type="number" id="minQty" name="minQty" class="form-control"
                                       placeholder="Min" step="0.01" />
                            </div>
                        </div>

                        <!-- Max Quantity -->
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-greater-than-equal"></i> Max. Qty:</label>
                                <input type="number" id="maxQty" name="maxQty" class="form-control"
                                       placeholder="Max" step="0.01" />
                            </div>
                        </div>

                        <!-- Min Value -->
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-dollar-sign"></i> Min. Value:</label>
                                <input type="number" id="minValue" name="minValue" class="form-control"
                                       placeholder="Min ৳" step="0.01" />
                            </div>
                        </div>

                        <!-- Max Value -->
                        <div class="col-md-2">
                            <div class="form-group">
                                <label><i class="fas fa-dollar-sign"></i> Max. Value:</label>
                                <input type="number" id="maxValue" name="maxValue" class="form-control"
                                       placeholder="Max ৳" step="0.01" />
                            </div>
                        </div>

                        <!-- Apply Button -->
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                            </div>
                        </div>

                        <!-- Reset Button -->
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-secondary btn-block" onclick="clearFilters()">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="info-box bg-info">
                    <span class="info-box-icon"><i class="fas fa-arrow-right"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Issues</span>
                        <span class="info-box-number">892</span>
                        <div class="progress">
                            <div class="progress-bar" style="width: 70%"></div>
                        </div>
                        <span class="progress-description">
                            70% Increase in 30 Days
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-box bg-success">
                    <span class="info-box-icon"><i class="fas fa-box"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Items Issued</span>
                        <span class="info-box-number">15,234</span>
                        <div class="progress">
                            <div class="progress-bar" style="width: 85%"></div>
                        </div>
                        <span class="progress-description">
                            85% of Monthly Target
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-box bg-warning">
                    <span class="info-box-icon"><i class="fas fa-dollar-sign"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Value</span>
                        <span class="info-box-number">$45,678</span>
                        <div class="progress">
                            <div class="progress-bar" style="width: 50%"></div>
                        </div>
                        <span class="progress-description">
                            50% of Budget Used
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-box bg-danger">
                    <span class="info-box-icon"><i class="fas fa-users"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Departments</span>
                        <span class="info-box-number">12</span>
                        <div class="progress">
                            <div class="progress-bar" style="width: 100%"></div>
                        </div>
                        <span class="progress-description">
                            All Departments Active
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Report Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Issue Details</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-success btn-sm" onclick="exportToExcel()">
                        <i class="fas fa-download"></i> Export Excel
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-bordered table-striped table-hover" id="issueTable">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 50px;">#</th>
                            <th>Issue #</th>
                            <th>Date</th>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th data-type="num">Quantity</th>
                            <th data-type="num-fmt">Unit Price</th>
                            <th data-type="num-fmt">Total Value</th>
                            <th>Issued To</th>
                            <th>Department</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-center">1</td>
                            <td>ISS-2025-001</td>
                            <td>2025-01-15</td>
                            <td>Office Paper A4</td>
                            <td>Stationery</td>
                            <td>10 Reams</td>
                            <td>$5.00</td>
                            <td>$50.00</td>
                            <td>John Smith</td>
                            <td>Admin</td>
                            <td><span class="badge badge-success">Completed</span></td>
                        </tr>
                        <tr>
                            <td class="text-center">2</td>
                            <td>ISS-2025-002</td>
                            <td>2025-01-16</td>
                            <td>Printer Cartridge</td>
                            <td>IT Supplies</td>
                            <td>2 Units</td>
                            <td>$45.00</td>
                            <td>$90.00</td>
                            <td>Sarah Johnson</td>
                            <td>IT</td>
                            <td><span class="badge badge-success">Completed</span></td>
                        </tr>
                        <tr>
                            <td class="text-center">3</td>
                            <td>ISS-2025-003</td>
                            <td>2025-01-17</td>
                            <td>Cleaning Supplies</td>
                            <td>Maintenance</td>
                            <td>5 Sets</td>
                            <td>$20.00</td>
                            <td>$100.00</td>
                            <td>Mike Davis</td>
                            <td>Facilities</td>
                            <td><span class="badge badge-success">Completed</span></td>
                        </tr>
                        <tr>
                            <td class="text-center">4</td>
                            <td>ISS-2025-004</td>
                            <td>2025-01-18</td>
                            <td>Desk Lamp</td>
                            <td>Furniture</td>
                            <td>3 Units</td>
                            <td>$25.00</td>
                            <td>$75.00</td>
                            <td>Emily Brown</td>
                            <td>HR</td>
                            <td><span class="badge badge-warning">Pending</span></td>
                        </tr>
                        <tr>
                            <td class="text-center">5</td>
                            <td>ISS-2025-005</td>
                            <td>2025-01-19</td>
                            <td>Notebooks</td>
                            <td>Stationery</td>
                            <td>50 Units</td>
                            <td>$2.00</td>
                            <td>$100.00</td>
                            <td>David Wilson</td>
                            <td>Sales</td>
                            <td><span class="badge badge-success">Completed</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Issues by Department</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="departmentChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daily Issue Trend</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="trendChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Styles {
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css" />
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-responsive/css/responsive.bootstrap4.min.css" />
}

@section Scripts {
    <!-- Chart.js -->
    <script src="~/adminlte/plugins/chart.js/Chart.min.js"></script>
    <!-- DataTables -->
    <script src="~/adminlte/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>

    <script>
        $(function () {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4'
            });

            // Department Chart - Check if canvas exists
            var departmentCanvas = document.getElementById('departmentChart');
            if (departmentCanvas) {
                var ctx1 = departmentCanvas.getContext('2d');
                new Chart(ctx1, {
                    type: 'pie',
                    data: {
                        labels: ['Admin', 'IT', 'Sales', 'HR', 'Facilities'],
                        datasets: [{
                            data: [120, 89, 156, 78, 92],
                            backgroundColor: ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        legend: {
                            position: 'bottom'
                        }
                    }
                });
            }

            // Trend Chart - Check if canvas exists
            var trendCanvas = document.getElementById('trendChart');
            if (trendCanvas) {
                var ctx2 = trendCanvas.getContext('2d');
                new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Issues',
                            data: [12, 19, 15, 25, 22, 18, 28],
                            borderColor: '#3c8dbc',
                            backgroundColor: 'rgba(60, 141, 188, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });
            }
        });

        // Initialize DataTable with advanced filtering
        var table = $('#issueTable').DataTable({
            "responsive": true,
            "lengthChange": true,
            "autoWidth": false,
            "pageLength": 25,
            "order": [[1, "desc"]], // Sort by Date descending (latest first)
            "language": {
                "search": "Quick Search:",
                "lengthMenu": "Show _MENU_ issues per page",
                "info": "Showing _START_ to _END_ of _TOTAL_ issues",
                "infoEmpty": "No issues available",
                "infoFiltered": "(filtered from _MAX_ total issues)"
            }
        });

        // Apply advanced filters when form inputs change
        $('#statusFilter, #categoryFilter, #departmentFilter').on('change', function() {
            applyAdvancedFilters();
        });

        $('#searchTerm, #minQty, #maxQty, #minValue, #maxValue').on('keyup change', function() {
            applyAdvancedFilters();
        });

        function applyAdvancedFilters() {
            var searchTerm = $('#searchTerm').val().toLowerCase();
            var status = $('#statusFilter').val();
            var category = $('#categoryFilter').val();
            var department = $('#departmentFilter').val();
            var minQty = parseFloat($('#minQty').val()) || -Infinity;
            var maxQty = parseFloat($('#maxQty').val()) || Infinity;
            var minValue = parseFloat($('#minValue').val()) || -Infinity;
            var maxValue = parseFloat($('#maxValue').val()) || Infinity;

            // Custom filter function
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    if (settings.nTable.id !== 'issueTable') {
                        return true;
                    }

                    // Extract values from table row
                    var issueNo = data[0].toLowerCase();
                    var itemName = data[2].toLowerCase();
                    var itemCategory = data[3];
                    var quantity = parseFloat(data[4].replace(/[^0-9.]/g, '')) || 0;
                    var totalValue = parseFloat(data[6].replace(/[$,]/g, '')) || 0;
                    var issuedTo = data[7].toLowerCase();
                    var dept = data[8];
                    var statusBadge = data[9];

                    // Search term filter (Issue #, Item Name, Issued To)
                    if (searchTerm && !(issueNo.includes(searchTerm) || itemName.includes(searchTerm) || issuedTo.includes(searchTerm))) {
                        return false;
                    }

                    // Status filter
                    if (status && !statusBadge.includes(status)) {
                        return false;
                    }

                    // Category filter
                    if (category && itemCategory !== category) {
                        return false;
                    }

                    // Department filter
                    if (department && dept !== department) {
                        return false;
                    }

                    // Quantity range filter
                    if (quantity < minQty || quantity > maxQty) {
                        return false;
                    }

                    // Value range filter
                    if (totalValue < minValue || totalValue > maxValue) {
                        return false;
                    }

                    return true;
                }
            );

            table.draw();
            $.fn.dataTable.ext.search.pop(); // Remove custom filter after drawing
        }

        // Clear all filters
        function clearFilters() {
            $('#filterForm')[0].reset();
            $('.select2').val('').trigger('change');
            window.location.href = '@Url.Action("IssueReport", "Report")';
        }

        // Export to Excel
        function exportToExcel() {
            var fromDate = document.getElementById('fromDate').value;
            var toDate = document.getElementById('toDate').value;
            var storeId = document.getElementById('storeId').value;

            var url = '@Url.Action("ExportIssueReport", "Report")' +
                      '?fromDate=' + encodeURIComponent(fromDate) +
                      '&toDate=' + encodeURIComponent(toDate);

            if (storeId) {
                url += '&storeId=' + storeId;
            }

            window.location.href = url;
        }

        // Export to PDF
        function exportToPDF() {
            var fromDate = document.getElementById('fromDate').value;
            var toDate = document.getElementById('toDate').value;
            var storeId = document.getElementById('storeId').value;

            var url = '@Url.Action("ExportIssueReportPdf", "Report")' +
                      '?fromDate=' + encodeURIComponent(fromDate) +
                      '&toDate=' + encodeURIComponent(toDate);

            if (storeId) {
                url += '&storeId=' + storeId;
            }

            window.location.href = url;
        }
    </script>
}