@model IMS.Application.DTOs.ExpiryReportDto
@{
    ViewData["Title"] = "Expiry Report";
}

@section Styles {
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
}

<section class="content">
    <div class="container-fluid">
        <!-- Filter Card -->
        <div class="card card-secondary">
            <div class="card-header bg-light">
                <h3 class="card-title"><i class="fas fa-filter"></i> <strong>Advanced Filter Options</strong></h3>
                <div class="card-tools">
                    <span class="badge badge-info mr-2">Real-time Filtering</span>
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form asp-action="ExpiryReport" method="get" id="filterForm">
                    <!-- Row 1: Server-side filters -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label><i class="fas fa-warehouse"></i> Store:</label>
                                <select name="storeId" id="storeId" asp-items="ViewBag.Stores" class="form-control select2" style="width: 100%;">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label><i class="far fa-clock"></i> Look Ahead Period:</label>
                                <select name="daysAhead" id="daysAhead" asp-items="ViewBag.DaysAheadOptions" class="form-control select2">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-secondary btn-block">
                                    <i class="fas fa-search"></i> Generate
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-secondary btn-block" onclick="clearFilters()">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Client-side filters -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-tags"></i> Category:</label>
                                <select id="categoryFilter" class="form-control select2">
                                    <option value="">-- All Categories --</option>
                                    <!-- Will be populated by JS from table data -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-info-circle"></i> Status:</label>
                                <select id="statusFilter" class="form-control select2">
                                    <option value="">-- All Statuses --</option>
                                    <option value="expired">Expired</option>
                                    <option value="expiring">Expiring Soon</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-search"></i> Search:</label>
                                <input type="text" id="searchFilter" class="form-control" placeholder="Search by Item Name, Code, or Batch Number">
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Value range filters -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-greater-than-equal"></i> Min Quantity:</label>
                                <input type="number" id="minQtyFilter" class="form-control" placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-greater-than-equal"></i> Min Value (৳):</label>
                                <input type="number" id="minValueFilter" class="form-control" placeholder="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-less-than-equal"></i> Max Value (৳):</label>
                                <input type="number" id="maxValueFilter" class="form-control" placeholder="999999999" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-sort-alpha-down"></i> Sort By:</label>
                                <select id="sortByFilter" class="form-control select2">
                                    <option value="">-- Default --</option>
                                    <option value="expiry-asc">Expiry Date (Soonest First)</option>
                                    <option value="expiry-desc">Expiry Date (Latest First)</option>
                                    <option value="value-desc">Value (High to Low)</option>
                                    <option value="value-asc">Value (Low to High)</option>
                                    <option value="qty-desc">Quantity (High to Low)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row">
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-danger"><i class="fas fa-times-circle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Already Expired</span>
                        <span class="info-box-number">@(Model.ExpiredItems?.Count ?? 0)</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-warning"><i class="fas fa-exclamation-triangle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Expiring Soon</span>
                        <span class="info-box-number">@(Model.ExpiringItems?.Count ?? 0)</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-info"><i class="fas fa-dollar-sign"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Expired Value</span>
                        <span class="info-box-number">৳@Model.TotalExpiredValue.ToString("N2")</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-secondary"><i class="fas fa-chart-line"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Expiring Value</span>
                        <span class="info-box-number">৳@Model.TotalExpiringValue.ToString("N2")</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expired Items Table -->
        @if (Model.ExpiredItems != null && Model.ExpiredItems.Any())
        {
            <div class="card card-danger">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-times-circle"></i>
                        Already Expired Items
                    </h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 150px;">
                            <input type="text" id="expiredSearch" class="form-control float-right" placeholder="Search">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped table-hover" id="expiredTable">
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th>Batch Number</th>
                                <th class="text-right">Quantity</th>
                                <th>Unit</th>
                                <th>Expiry Date</th>
                                <th class="text-right">Days Ago</th>
                                <th class="text-right">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.ExpiredItems.OrderBy(x => x.ExpiryDate))
                            {
                                var daysAgo = (DateTime.Now - item.ExpiryDate).Days;
                                <tr class="table-danger">
                                    <td><strong>@item.ItemCode</strong></td>
                                    <td>@item.ItemName</td>
                                    <td>@item.CategoryName</td>
                                    <td>@item.StoreName</td>
                                    <td>@item.BatchNumber</td>
                                    <td class="text-right">@((item.Quantity % 1 == 0) ? item.Quantity.ToString("N0") : item.Quantity.ToString("N2"))</td>
                                    <td>@item.Unit</td>
                                    <td>
                                        <span class="badge badge-danger">
                                            @item.ExpiryDate.ToString("dd MMM yyyy")
                                        </span>
                                    </td>
                                    <td class="text-right">@daysAgo days</td>
                                    <td class="text-right">৳@item.Value.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="bg-light font-weight-bold">
                                <td colspan="9" class="text-right">Total Expired Value:</td>
                                <td class="text-right">৳@Model.TotalExpiredValue.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        }

        <!-- Expiring Items Table -->
        @if (Model.ExpiringItems != null && Model.ExpiringItems.Any())
        {
            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Items Expiring Soon
                    </h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 150px;">
                            <input type="text" id="expiringSearch" class="form-control float-right" placeholder="Search">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped table-hover" id="expiringTable">
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th>Batch Number</th>
                                <th class="text-right">Quantity</th>
                                <th>Unit</th>
                                <th>Expiry Date</th>
                                <th class="text-right">Days Left</th>
                                <th class="text-right">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.ExpiringItems.OrderBy(x => x.ExpiryDate))
                            {
                                var daysLeft = (item.ExpiryDate - DateTime.Now).Days;
                                var badgeClass = daysLeft <= 7 ? "badge-danger" : daysLeft <= 30 ? "badge-warning" : "badge-info";
                                var rowClass = daysLeft <= 7 ? "table-danger" : daysLeft <= 30 ? "table-warning" : "";
                                <tr class="@rowClass">
                                    <td><strong>@item.ItemCode</strong></td>
                                    <td>@item.ItemName</td>
                                    <td>@item.CategoryName</td>
                                    <td>@item.StoreName</td>
                                    <td>@item.BatchNumber</td>
                                    <td class="text-right">@((item.Quantity % 1 == 0) ? item.Quantity.ToString("N0") : item.Quantity.ToString("N2"))</td>
                                    <td>@item.Unit</td>
                                    <td>
                                        <span class="badge @badgeClass">
                                            @item.ExpiryDate.ToString("dd MMM yyyy")
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <strong>@daysLeft days</strong>
                                    </td>
                                    <td class="text-right">৳@item.Value.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="bg-light font-weight-bold">
                                <td colspan="9" class="text-right">Total Expiring Value:</td>
                                <td class="text-right">৳@Model.TotalExpiringValue.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        }

        @if ((Model.ExpiredItems == null || !Model.ExpiredItems.Any()) && (Model.ExpiringItems == null || !Model.ExpiringItems.Any()))
        {
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <strong>Great News!</strong> No expired or expiring items found for the selected criteria.
            </div>
        }
    </div>
</section>

@section Scripts {
    <script src="~/adminlte/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4'
            });

            // Initialize DataTable for Expired Items
            @if (Model.ExpiredItems != null && Model.ExpiredItems.Any())
            {
                <text>
                var expiredTable = $('#expiredTable').DataTable({
                    responsive: true,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                    order: [[7, 'asc']], // Sort by Expiry Date ascending
                    language: {
                        search: "অনুসন্ধান:",
                        lengthMenu: "প্রদর্শন _MENU_ এন্ট্রি",
                        info: "দেখানো হচ্ছে _START_ থেকে _END_ পর্যন্ত, মোট _TOTAL_ টি",
                        infoEmpty: "কোনো এন্ট্রি নেই",
                        infoFiltered: "(মোট _MAX_ এন্ট্রি থেকে ফিল্টার করা হয়েছে)",
                        paginate: {
                            first: "প্রথম",
                            last: "শেষ",
                            next: "পরবর্তী",
                            previous: "পূর্ববর্তী"
                        },
                        emptyTable: "টেবিলে কোনো ডেটা নেই"
                    }
                });

                // Custom search box for expired items
                $('#expiredSearch').on('keyup', function() {
                    expiredTable.search(this.value).draw();
                });
                </text>
            }

            // Initialize DataTable for Expiring Items
            @if (Model.ExpiringItems != null && Model.ExpiringItems.Any())
            {
                <text>
                var expiringTable = $('#expiringTable').DataTable({
                    responsive: true,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                    order: [[7, 'asc']], // Sort by Expiry Date ascending
                    language: {
                        search: "অনুসন্ধান:",
                        lengthMenu: "প্রদর্শন _MENU_ এন্ট্রি",
                        info: "দেখানো হচ্ছে _START_ থেকে _END_ পর্যন্ত, মোট _TOTAL_ টি",
                        infoEmpty: "কোনো এন্ট্রি নেই",
                        infoFiltered: "(মোট _MAX_ এন্ট্রি থেকে ফিল্টার করা হয়েছে)",
                        paginate: {
                            first: "প্রথম",
                            last: "শেষ",
                            next: "পরবর্তী",
                            previous: "পূর্ববর্তী"
                        },
                        emptyTable: "টেবিলে কোনো ডেটা নেই"
                    }
                });

                // Custom search box for expiring items
                $('#expiringSearch').on('keyup', function() {
                    expiringTable.search(this.value).draw();
                });
                </text>
            }
        });

        // Print function
        function printReport() {
            window.print();
        }

        // Export to Excel
        function exportToExcel() {
            var storeId = '@ViewBag.StoreId';
            var daysAhead = '@ViewBag.DaysAhead';

            var url = '@Url.Action("ExportExpiryReport", "Report")' + '?';

            if (storeId) url += 'storeId=' + storeId + '&';
            if (daysAhead) url += 'daysAhead=' + daysAhead;

            window.location.href = url;
        }

        // Export to PDF
        function exportToPDF() {
            var storeId = '@ViewBag.StoreId';
            var daysAhead = '@ViewBag.DaysAhead';

            var url = '@Url.Action("ExpiryReportPdf", "Report")' + '?';

            if (storeId) url += 'storeId=' + storeId + '&';
            if (daysAhead) url += 'daysAhead=' + daysAhead;

            window.location.href = url;
        }

        // Clear all filters
        function clearFilters() {
            $('#filterForm')[0].reset();
            $('.select2').val('').trigger('change');
            $('#searchFilter, #minQtyFilter, #minValueFilter, #maxValueFilter, #categoryFilter, #statusFilter, #sortByFilter').val('');
            window.location.href = '@Url.Action("ExpiryReport", "Report")';
        }
    </script>


    <!-- Print Styles -->
    <style>
        @@media print {
            .main-sidebar, .main-header, .main-footer {
                display: none !important;
            }

            .content-wrapper {
                margin-left: 0 !important;
            }

            .card-tools, #expiredSearch, #expiringSearch, form {
                display: none !important;
            }
        }
    </style>
}
