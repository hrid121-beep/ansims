@model IMS.Application.DTOs.ExpiryReportDto
@{
    ViewData["Title"] = "Expiry Report";
}

<div class="row">
    <div class="col-12">
        <!-- Header with Export Options -->
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-calendar-times"></i>
                    Expiry Report
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" onclick="printReport()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn btn-tool" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button type="button" class="btn btn-tool" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filter Section -->
                <form asp-action="ExpiryReport" method="get" class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Store</label>
                                <select name="storeId" asp-items="ViewBag.Stores" class="form-control select2">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Look Ahead Period</label>
                                <select name="daysAhead" asp-items="ViewBag.DaysAheadOptions" class="form-control">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Apply Filter
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Summary Statistics -->
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger">
                            <div class="inner">
                                <h3>@(Model.ExpiredItems?.Count ?? 0)</h3>
                                <p>Already Expired</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-times-circle"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning">
                            <div class="inner">
                                <h3>@(Model.ExpiringItems?.Count ?? 0)</h3>
                                <p>Expiring Soon</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info">
                            <div class="inner">
                                <h3>৳@Model.TotalExpiredValue.ToString("N2")</h3>
                                <p>Expired Value</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-secondary">
                            <div class="inner">
                                <h3>৳@Model.TotalExpiringValue.ToString("N2")</h3>
                                <p>Expiring Value</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Expired Items Table -->
@if (Model.ExpiredItems != null && Model.ExpiredItems.Any())
{
    <div class="row">
        <div class="col-12">
            <div class="card card-danger">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-times-circle"></i>
                        Already Expired Items
                    </h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" id="expiredSearch" class="form-control float-right" placeholder="Search">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover text-nowrap" id="expiredTable">
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th>Batch Number</th>
                                <th class="text-right">Quantity</th>
                                <th>Unit</th>
                                <th>Expiry Date</th>
                                <th class="text-right">Days Ago</th>
                                <th class="text-right">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.ExpiredItems.OrderBy(x => x.ExpiryDate))
                            {
                                var daysAgo = (DateTime.Now - item.ExpiryDate).Days;
                                <tr class="table-danger">
                                    <td><strong>@item.ItemCode</strong></td>
                                    <td>@item.ItemName</td>
                                    <td>@item.CategoryName</td>
                                    <td>@item.StoreName</td>
                                    <td>@item.BatchNumber</td>
                                    <td class="text-right">@((item.Quantity % 1 == 0) ? item.Quantity.ToString("N0") : item.Quantity.ToString("N2"))</td>
                                    <td>@item.Unit</td>
                                    <td>
                                        <span class="badge badge-danger">
                                            @item.ExpiryDate.ToString("dd MMM yyyy")
                                        </span>
                                    </td>
                                    <td class="text-right">@daysAgo days</td>
                                    <td class="text-right">৳@item.Value.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="bg-light font-weight-bold">
                                <td colspan="9" class="text-right">Total Expired Value:</td>
                                <td class="text-right">৳@Model.TotalExpiredValue.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

<!-- Expiring Items Table -->
@if (Model.ExpiringItems != null && Model.ExpiringItems.Any())
{
    <div class="row">
        <div class="col-12">
            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Items Expiring Soon
                    </h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" id="expiringSearch" class="form-control float-right" placeholder="Search">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover text-nowrap" id="expiringTable">
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th>Batch Number</th>
                                <th class="text-right">Quantity</th>
                                <th>Unit</th>
                                <th>Expiry Date</th>
                                <th class="text-right">Days Left</th>
                                <th class="text-right">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.ExpiringItems.OrderBy(x => x.ExpiryDate))
                            {
                                var daysLeft = (item.ExpiryDate - DateTime.Now).Days;
                                var badgeClass = daysLeft <= 7 ? "badge-danger" : daysLeft <= 30 ? "badge-warning" : "badge-info";
                                var rowClass = daysLeft <= 7 ? "table-danger" : daysLeft <= 30 ? "table-warning" : "";
                                <tr class="@rowClass">
                                    <td><strong>@item.ItemCode</strong></td>
                                    <td>@item.ItemName</td>
                                    <td>@item.CategoryName</td>
                                    <td>@item.StoreName</td>
                                    <td>@item.BatchNumber</td>
                                    <td class="text-right">@((item.Quantity % 1 == 0) ? item.Quantity.ToString("N0") : item.Quantity.ToString("N2"))</td>
                                    <td>@item.Unit</td>
                                    <td>
                                        <span class="badge @badgeClass">
                                            @item.ExpiryDate.ToString("dd MMM yyyy")
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <strong>@daysLeft days</strong>
                                    </td>
                                    <td class="text-right">৳@item.Value.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="bg-light font-weight-bold">
                                <td colspan="9" class="text-right">Total Expiring Value:</td>
                                <td class="text-right">৳@Model.TotalExpiringValue.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

@if ((Model.ExpiredItems == null || !Model.ExpiredItems.Any()) && (Model.ExpiringItems == null || !Model.ExpiringItems.Any()))
{
    <div class="row">
        <div class="col-12">
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <strong>Great News!</strong> No expired or expiring items found for the selected criteria.
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4'
            });

            // Table Search for Expired Items
            $('#expiredSearch').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('#expiredTable tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });

            // Table Search for Expiring Items
            $('#expiringSearch').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('#expiringTable tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });

        // Print function
        function printReport() {
            window.print();
        }

        // Export to Excel
        function exportToExcel() {
            var storeId = '@ViewBag.StoreId';
            var daysAhead = '@ViewBag.DaysAhead';

            var url = '@Url.Action("ExportExpiryReport", "Report")' + '?';

            if (storeId) url += 'storeId=' + storeId + '&';
            if (daysAhead) url += 'daysAhead=' + daysAhead;

            window.location.href = url;
        }

        // Export to PDF
        function exportToPDF() {
            var storeId = '@ViewBag.StoreId';
            var daysAhead = '@ViewBag.DaysAhead';

            var url = '@Url.Action("ExportExpiryReportPdf", "Report")' + '?';

            if (storeId) url += 'storeId=' + storeId + '&';
            if (daysAhead) url += 'daysAhead=' + daysAhead;

            window.location.href = url;
        }
    </script>

    <!-- Print Styles -->
    <style>
        @@media print {
            .main-sidebar, .main-header, .main-footer {
                display: none !important;
            }

            .content-wrapper {
                margin-left: 0 !important;
            }

            .card-tools, #expiredSearch, #expiringSearch, form {
                display: none !important;
            }
        }
    </style>
}
