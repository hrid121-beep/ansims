@model IMS.Application.DTOs.ExpiryReportDto
@{
    ViewData["Title"] = "Expiry Report";
}

@section Styles {
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
}

<section class="content">
    <div class="container-fluid">
        <!-- Filter Card -->
        <div class="card card-secondary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-filter"></i> Filter Options</h3>
            </div>
            <div class="card-body">
                <form asp-action="ExpiryReport" method="get">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="form-group">
                                <label>Store:</label>
                                <select name="storeId" asp-items="ViewBag.Stores" class="form-control select2" style="width: 100%;">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label>Look Ahead Period:</label>
                                <select name="daysAhead" asp-items="ViewBag.DaysAheadOptions" class="form-control">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-secondary btn-block">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row">
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-danger"><i class="fas fa-times-circle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Already Expired</span>
                        <span class="info-box-number">@(Model.ExpiredItems?.Count ?? 0)</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-warning"><i class="fas fa-exclamation-triangle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Expiring Soon</span>
                        <span class="info-box-number">@(Model.ExpiringItems?.Count ?? 0)</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-info"><i class="fas fa-dollar-sign"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Expired Value</span>
                        <span class="info-box-number">৳@Model.TotalExpiredValue.ToString("N2")</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-secondary"><i class="fas fa-chart-line"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Expiring Value</span>
                        <span class="info-box-number">৳@Model.TotalExpiringValue.ToString("N2")</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expired Items Table -->
        @if (Model.ExpiredItems != null && Model.ExpiredItems.Any())
        {
            <div class="card card-danger">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-times-circle"></i>
                        Already Expired Items
                    </h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 150px;">
                            <input type="text" id="expiredSearch" class="form-control float-right" placeholder="Search">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped table-hover" id="expiredTable">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 50px;">#</th>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th>Batch Number</th>
                                <th class="text-right">Quantity</th>
                                <th>Unit</th>
                                <th>Expiry Date</th>
                                <th class="text-right">Days Ago</th>
                                <th class="text-right">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var serialNo = 1;
                            }
                            @foreach (var item in Model.ExpiredItems.OrderBy(x => x.ExpiryDate))
                            {
                                var daysAgo = (DateTime.Now - item.ExpiryDate).Days;
                                <tr class="table-danger">
                                    <td class="text-center">@serialNo</td>
                                    <td><strong>@item.ItemCode</strong></td>
                                    <td>@item.ItemName</td>
                                    <td>@item.CategoryName</td>
                                    <td>@item.StoreName</td>
                                    <td>@item.BatchNumber</td>
                                    <td class="text-right">@((item.Quantity % 1 == 0) ? item.Quantity.ToString("N0") : item.Quantity.ToString("N2"))</td>
                                    <td>@item.Unit</td>
                                    <td>
                                        <span class="badge badge-danger">
                                            @item.ExpiryDate.ToString("dd MMM yyyy")
                                        </span>
                                    </td>
                                    <td class="text-right">@daysAgo days</td>
                                    <td class="text-right">৳@item.Value.ToString("N2")</td>
                                </tr>
                                serialNo++;
                            }
                        </tbody>
                        <tfoot>
                            <tr class="bg-light font-weight-bold">
                                <td colspan="10" class="text-right">Total Expired Value:</td>
                                <td class="text-right">৳@Model.TotalExpiredValue.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        }

        <!-- Expiring Items Table -->
        @if (Model.ExpiringItems != null && Model.ExpiringItems.Any())
        {
            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Items Expiring Soon
                    </h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 150px;">
                            <input type="text" id="expiringSearch" class="form-control float-right" placeholder="Search">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped table-hover" id="expiringTable">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 50px;">#</th>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th>Batch Number</th>
                                <th class="text-right">Quantity</th>
                                <th>Unit</th>
                                <th>Expiry Date</th>
                                <th class="text-right">Days Left</th>
                                <th class="text-right">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var serialNo2 = 1;
                            }
                            @foreach (var item in Model.ExpiringItems.OrderBy(x => x.ExpiryDate))
                            {
                                var daysLeft = (item.ExpiryDate - DateTime.Now).Days;
                                var badgeClass = daysLeft <= 7 ? "badge-danger" : daysLeft <= 30 ? "badge-warning" : "badge-info";
                                var rowClass = daysLeft <= 7 ? "table-danger" : daysLeft <= 30 ? "table-warning" : "";
                                <tr class="@rowClass">
                                    <td class="text-center">@serialNo2</td>
                                    <td><strong>@item.ItemCode</strong></td>
                                    <td>@item.ItemName</td>
                                    <td>@item.CategoryName</td>
                                    <td>@item.StoreName</td>
                                    <td>@item.BatchNumber</td>
                                    <td class="text-right">@((item.Quantity % 1 == 0) ? item.Quantity.ToString("N0") : item.Quantity.ToString("N2"))</td>
                                    <td>@item.Unit</td>
                                    <td>
                                        <span class="badge @badgeClass">
                                            @item.ExpiryDate.ToString("dd MMM yyyy")
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <strong>@daysLeft days</strong>
                                    </td>
                                    <td class="text-right">৳@item.Value.ToString("N2")</td>
                                </tr>
                                serialNo2++; }
                            }
                        </tbody>
                        <tfoot>
                            <tr class="bg-light font-weight-bold">
                                <td colspan="10" class="text-right">Total Expiring Value:</td>
                                <td class="text-right">৳@Model.TotalExpiringValue.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        }

        @if ((Model.ExpiredItems == null || !Model.ExpiredItems.Any()) && (Model.ExpiringItems == null || !Model.ExpiringItems.Any()))
        {
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <strong>Great News!</strong> No expired or expiring items found for the selected criteria.
            </div>
        }
    </div>
</section>

@section Scripts {
    <script src="~/adminlte/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4'
            });

            // Initialize DataTable for Expired Items
            @if (Model.ExpiredItems != null && Model.ExpiredItems.Any())
            {
                <text>
                var expiredTable = $('#expiredTable').DataTable({
                    responsive: true,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                    order: [[7, 'asc']], // Sort by Expiry Date ascending
                    language: {
                        search: "অনুসন্ধান:",
                        lengthMenu: "প্রদর্শন _MENU_ এন্ট্রি",
                        info: "দেখানো হচ্ছে _START_ থেকে _END_ পর্যন্ত, মোট _TOTAL_ টি",
                        infoEmpty: "কোনো এন্ট্রি নেই",
                        infoFiltered: "(মোট _MAX_ এন্ট্রি থেকে ফিল্টার করা হয়েছে)",
                        paginate: {
                            first: "প্রথম",
                            last: "শেষ",
                            next: "পরবর্তী",
                            previous: "পূর্ববর্তী"
                        },
                        emptyTable: "টেবিলে কোনো ডেটা নেই"
                    }
                });

                // Custom search box for expired items
                $('#expiredSearch').on('keyup', function() {
                    expiredTable.search(this.value).draw();
                });
                </text>
            }

            // Initialize DataTable for Expiring Items
            @if (Model.ExpiringItems != null && Model.ExpiringItems.Any())
            {
                <text>
                var expiringTable = $('#expiringTable').DataTable({
                    responsive: true,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                    order: [[7, 'asc']], // Sort by Expiry Date ascending
                    language: {
                        search: "অনুসন্ধান:",
                        lengthMenu: "প্রদর্শন _MENU_ এন্ট্রি",
                        info: "দেখানো হচ্ছে _START_ থেকে _END_ পর্যন্ত, মোট _TOTAL_ টি",
                        infoEmpty: "কোনো এন্ট্রি নেই",
                        infoFiltered: "(মোট _MAX_ এন্ট্রি থেকে ফিল্টার করা হয়েছে)",
                        paginate: {
                            first: "প্রথম",
                            last: "শেষ",
                            next: "পরবর্তী",
                            previous: "পূর্ববর্তী"
                        },
                        emptyTable: "টেবিলে কোনো ডেটা নেই"
                    }
                });

                // Custom search box for expiring items
                $('#expiringSearch').on('keyup', function() {
                    expiringTable.search(this.value).draw();
                });
                </text>
            }
        });

        // Print function
        function printReport() {
            window.print();
        }

        // Export to Excel
        function exportToExcel() {
            var storeId = '@ViewBag.StoreId';
            var daysAhead = '@ViewBag.DaysAhead';

            var url = '@Url.Action("ExportExpiryReport", "Report")' + '?';

            if (storeId) url += 'storeId=' + storeId + '&';
            if (daysAhead) url += 'daysAhead=' + daysAhead;

            window.location.href = url;
        }

        // Export to PDF
        function exportToPDF() {
            var storeId = '@ViewBag.StoreId';
            var daysAhead = '@ViewBag.DaysAhead';

            var url = '@Url.Action("ExportExpiryReportPdf", "Report")' + '?';

            if (storeId) url += 'storeId=' + storeId + '&';
            if (daysAhead) url += 'daysAhead=' + daysAhead;

            window.location.href = url;
        }
    </script>

    <!-- Print Styles -->
    <style>
        @@media print {
            .main-sidebar, .main-header, .main-footer {
                display: none !important;
            }

            .content-wrapper {
                margin-left: 0 !important;
            }

            .card-tools, #expiredSearch, #expiringSearch, form {
                display: none !important;
            }
        }
    </style>
}
