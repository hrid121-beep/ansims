@model IMS.Application.DTOs.ABCAnalysisReportDto
@{
    ViewData["Title"] = "ABC Analysis Report";
}

@section Styles {
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="~/adminlte/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
}

<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">ABC Analysis Report</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Reports</a></li>
                    <li class="breadcrumb-item active">ABC Analysis</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Filter Card -->
        <div class="card card-secondary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-filter"></i> Filter Options</h3>
            </div>
            <div class="card-body">
                <form asp-action="ABCAnalysis" method="get">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="form-group">
                                <label>Analysis Method:</label>
                                <select name="analysisMethod" asp-items="ViewBag.AnalysisMethods" class="form-control">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label>Time Period:</label>
                                <select name="months" asp-items="ViewBag.MonthsOptions" class="form-control">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-secondary btn-block">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row">
            <div class="col-md-4 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-danger"><i class="fas fa-star"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Class A Items (70%)</span>
                        <span class="info-box-number">@(Model.ClassAItems?.Count ?? 0)</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-warning"><i class="fas fa-circle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Class B Items (20%)</span>
                        <span class="info-box-number">@(Model.ClassBItems?.Count ?? 0)</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-6 col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-success"><i class="fas fa-dot-circle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Class C Items (10%)</span>
                        <span class="info-box-number">@(Model.ClassCItems?.Count ?? 0)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Info -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Analysis Method:</strong> @Model.AnalysisMethod |
            <strong>Period:</strong> Last @Model.Months months |
            <strong>Total Items:</strong> @(Model.ClassAItems?.Count + Model.ClassBItems?.Count + Model.ClassCItems?.Count ?? 0)
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ABC Distribution</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="abcDistributionChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Pareto Chart</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="paretoChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Class A Items Table -->
        @if (Model.ClassAItems != null && Model.ClassAItems.Any())
        {
            <div class="card card-danger">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-star"></i>
                        Class A Items - High Priority (Top 70% Value)
                    </h3>
                    <div class="card-tools">
                        <div class="btn-group mr-2">
                            <button type="button" class="btn btn-success btn-sm" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                        <span class="badge badge-danger">@Model.ClassAItems.Count items</span>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped table-hover" id="classATable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th class="text-right">Value/Qty/Frequency</th>
                                <th class="text-right">Current Stock</th>
                                <th>Unit</th>
                                <th class="text-right">% Contribution</th>
                                <th class="text-right">Cumulative %</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int rankA = 1;
                                foreach (var item in Model.ClassAItems)
                                {
                                    <tr class="table-danger">
                                        <td><strong>@rankA</strong></td>
                                        <td><strong>@item.ItemCode</strong></td>
                                        <td>@item.ItemName</td>
                                        <td>@item.CategoryName</td>
                                        <td class="text-right">@item.AnalysisValue.ToString("N2")</td>
                                        <td class="text-right">@((item.CurrentStock % 1 == 0) ? item.CurrentStock.ToString("N0") : item.CurrentStock.ToString("N2"))</td>
                                        <td>@item.Unit</td>
                                        <td class="text-right">@item.PercentageContribution.ToString("N2")%</td>
                                        <td class="text-right">@item.CumulativePercentage.ToString("N2")%</td>
                                    </tr>
                                    rankA++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

                <!-- Class B Items Table -->
        @if (Model.ClassBItems != null && Model.ClassBItems.Any())
        {
            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-circle"></i>
                        Class B Items - Medium Priority (Next 20% Value)
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-warning">@Model.ClassBItems.Count items</span>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped table-hover" id="classBTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th class="text-right">Value/Qty/Frequency</th>
                                <th class="text-right">Current Stock</th>
                                <th>Unit</th>
                                <th class="text-right">% Contribution</th>
                                <th class="text-right">Cumulative %</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int rankB = Model.ClassAItems.Count + 1;
                                foreach (var item in Model.ClassBItems)
                                {
                                    <tr class="table-warning">
                                        <td><strong>@rankB</strong></td>
                                        <td><strong>@item.ItemCode</strong></td>
                                        <td>@item.ItemName</td>
                                        <td>@item.CategoryName</td>
                                        <td class="text-right">@item.AnalysisValue.ToString("N2")</td>
                                        <td class="text-right">@((item.CurrentStock % 1 == 0) ? item.CurrentStock.ToString("N0") : item.CurrentStock.ToString("N2"))</td>
                                        <td>@item.Unit</td>
                                        <td class="text-right">@item.PercentageContribution.ToString("N2")%</td>
                                        <td class="text-right">@item.CumulativePercentage.ToString("N2")%</td>
                                    </tr>
                                    rankB++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

                <!-- Class C Items Table -->
        @if (Model.ClassCItems != null && Model.ClassCItems.Any())
        {
            <div class="card card-success">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-dot-circle"></i>
                        Class C Items - Low Priority (Bottom 10% Value)
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-success">@Model.ClassCItems.Count items</span>
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped table-hover" id="classCTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th class="text-right">Value/Qty/Frequency</th>
                                <th class="text-right">Current Stock</th>
                                <th>Unit</th>
                                <th class="text-right">% Contribution</th>
                                <th class="text-right">Cumulative %</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int rankC = Model.ClassAItems.Count + Model.ClassBItems.Count + 1;
                                foreach (var item in Model.ClassCItems)
                                {
                                    <tr>
                                        <td>@rankC</td>
                                        <td>@item.ItemCode</td>
                                        <td>@item.ItemName</td>
                                        <td>@item.CategoryName</td>
                                        <td class="text-right">@item.AnalysisValue.ToString("N2")</td>
                                        <td class="text-right">@((item.CurrentStock % 1 == 0) ? item.CurrentStock.ToString("N0") : item.CurrentStock.ToString("N2"))</td>
                                        <td>@item.Unit</td>
                                        <td class="text-right">@item.PercentageContribution.ToString("N2")%</td>
                                        <td class="text-right">@item.CumulativePercentage.ToString("N2")%</td>
                                    </tr>
                                    rankC++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

                <!-- ABC Analysis Info Card -->
        <div class="card card-outline card-info">
            <div class="card-header">
                <h3 class="card-title">About ABC Analysis</h3>
            </div>
            <div class="card-body">
                <p><strong>What is ABC Analysis?</strong></p>
                <p>ABC Analysis is an inventory categorization technique based on the Pareto Principle (80/20 rule). It helps prioritize inventory management efforts:</p>

                <div class="row">
                    <div class="col-md-4">
                        <div class="callout callout-danger">
                            <h5><i class="fas fa-star"></i> Class A Items</h5>
                            <p>High value items (typically 70% of total value, 20% of items). Require tight control, accurate records, and frequent reviews.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="callout callout-warning">
                            <h5><i class="fas fa-circle"></i> Class B Items</h5>
                            <p>Medium value items (typically 20% of total value, 30% of items). Require moderate control and regular monitoring.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="callout callout-success">
                            <h5><i class="fas fa-dot-circle"></i> Class C Items</h5>
                            <p>Low value items (typically 10% of total value, 50% of items). Require simple controls and periodic reviews.</p>
                        </div>
                    </div>
                </div>

                <p class="mb-0 text-muted"><small>Report generated on: @DateTime.Now.ToString("dd MMM yyyy HH:mm:ss")</small></p>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/adminlte/plugins/chart.js/Chart.min.js"></script>
    <script src="~/adminlte/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize DataTables
            @if (Model.ClassAItems != null && Model.ClassAItems.Any())
            {
                <text>
                $('#classATable').DataTable({
                    responsive: true,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                    order: [[0, 'asc']], // Sort by Rank
                    language: {
                        search: "অনুসন্ধান:",
                        lengthMenu: "প্রদর্শন _MENU_ এন্ট্রি",
                        info: "দেখানো হচ্ছে _START_ থেকে _END_ পর্যন্ত, মোট _TOTAL_ টি",
                        infoEmpty: "কোনো এন্ট্রি নেই",
                        infoFiltered: "(মোট _MAX_ এন্ট্রি থেকে ফিল্টার করা হয়েছে)",
                        paginate: {
                            first: "প্রথম",
                            last: "শেষ",
                            next: "পরবর্তী",
                            previous: "পূর্ববর্তী"
                        },
                        emptyTable: "টেবিলে কোনো ডেটা নেই"
                    }
                });
                </text>
            }

            @if (Model.ClassBItems != null && Model.ClassBItems.Any())
            {
                <text>
                $('#classBTable').DataTable({
                    responsive: true,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                    order: [[0, 'asc']], // Sort by Rank
                    language: {
                        search: "অনুসন্ধান:",
                        lengthMenu: "প্রদর্শন _MENU_ এন্ট্রি",
                        info: "দেখানো হচ্ছে _START_ থেকে _END_ পর্যন্ত, মোট _TOTAL_ টি",
                        infoEmpty: "কোনো এন্ট্রি নেই",
                        infoFiltered: "(মোট _MAX_ এন্ট্রি থেকে ফিল্টার করা হয়েছে)",
                        paginate: {
                            first: "প্রথম",
                            last: "শেষ",
                            next: "পরবর্তী",
                            previous: "পূর্ববর্তী"
                        },
                        emptyTable: "টেবিলে কোনো ডেটা নেই"
                    }
                });
                </text>
            }

            @if (Model.ClassCItems != null && Model.ClassCItems.Any())
            {
                <text>
                $('#classCTable').DataTable({
                    responsive: true,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                    order: [[0, 'asc']], // Sort by Rank
                    language: {
                        search: "অনুসন্ধান:",
                        lengthMenu: "প্রদর্শন _MENU_ এন্ট্রি",
                        info: "দেখানো হচ্ছে _START_ থেকে _END_ পর্যন্ত, মোট _TOTAL_ টি",
                        infoEmpty: "কোনো এন্ট্রি নেই",
                        infoFiltered: "(মোট _MAX_ এন্ট্রি থেকে ফিল্টার করা হয়েছে)",
                        paginate: {
                            first: "প্রথম",
                            last: "শেষ",
                            next: "পরবর্তী",
                            previous: "পূর্ববর্তী"
                        },
                        emptyTable: "টেবিলে কোনো ডেটা নেই"
                    }
                });
                </text>
            }

            // ABC Distribution Pie Chart
            var distributionData = {
                labels: ['Class A', 'Class B', 'Class C'],
                datasets: [{
                    data: [@Model.ClassAItems.Count, @Model.ClassBItems.Count, @Model.ClassCItems.Count],
                    backgroundColor: ['rgba(220, 53, 69, 0.8)', 'rgba(255, 193, 7, 0.8)', 'rgba(40, 167, 69, 0.8)'],
                    borderWidth: 0
                }]
            };

            var distributionOptions = {
                maintainAspectRatio: false,
                responsive: true,
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem, data) {
                            var label = data.labels[tooltipItem.index];
                            var value = data.datasets[0].data[tooltipItem.index];
                            return label + ': ' + value + ' items';
                        }
                    }
                }
            };

            var distributionChartCanvas = $('#abcDistributionChart').get(0).getContext('2d');
            new Chart(distributionChartCanvas, {
                type: 'doughnut',
                data: distributionData,
                options: distributionOptions
            });

            // Pareto Chart (Cumulative Percentage)
            var allItems = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                Model.ClassAItems.Concat(Model.ClassBItems).Concat(Model.ClassCItems)
                    .OrderBy(i => i.CumulativePercentage)
                    .Take(20)
                    .Select(i => new { i.ItemName, i.PercentageContribution, i.CumulativePercentage })
                    .ToList()
            ));

            var paretoData = {
                labels: allItems.map(i => i.ItemName.length > 15 ? i.ItemName.substring(0, 15) + '...' : i.ItemName),
                datasets: [{
                    type: 'bar',
                    label: 'Individual %',
                    data: allItems.map(i => i.PercentageContribution),
                    backgroundColor: 'rgba(60, 141, 188, 0.8)',
                    yAxisID: 'y-axis-1'
                }, {
                    type: 'line',
                    label: 'Cumulative %',
                    data: allItems.map(i => i.CumulativePercentage),
                    borderColor: 'rgba(220, 53, 69, 0.8)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    fill: false,
                    yAxisID: 'y-axis-2'
                }]
            };

            var paretoOptions = {
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    yAxes: [{
                        id: 'y-axis-1',
                        type: 'linear',
                        position: 'left',
                        ticks: {
                            beginAtZero: true,
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }, {
                        id: 'y-axis-2',
                        type: 'linear',
                        position: 'right',
                        ticks: {
                            beginAtZero: true,
                            max: 100,
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        gridLines: {
                            drawOnChartArea: false
                        }
                    }]
                }
            };

            var paretoChartCanvas = $('#paretoChart').get(0).getContext('2d');
            new Chart(paretoChartCanvas, {
                type: 'bar',
                data: paretoData,
                options: paretoOptions
            });
        });

        // Print function
        function printReport() {
            window.print();
        }

        // Export to Excel
        function exportToExcel() {
            var analysisMethod = '@Model.AnalysisMethod';
            var months = @Model.Months;

            var url = '@Url.Action("ExportABCAnalysis", "Report")' +
                      '?analysisMethod=' + encodeURIComponent(analysisMethod) +
                      '&months=' + months;

            window.location.href = url;
        }

        // Export to PDF
        function exportToPDF() {
            var analysisMethod = '@Model.AnalysisMethod';
            var months = @Model.Months;

            var url = '@Url.Action("ExportABCAnalysisPdf", "Report")' +
                      '?analysisMethod=' + encodeURIComponent(analysisMethod) +
                      '&months=' + months;

            window.location.href = url;
        }
    </script>

    <!-- Print Styles -->
    <style>
        @@media print {
            .main-sidebar, .main-header, .main-footer {
                display: none !important;
            }

            .content-wrapper {
                margin-left: 0 !important;
            }

            .card-tools, form {
                display: none !important;
            }
        }
    </style>
}
