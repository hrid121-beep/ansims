@model IMS.Application.DTOs.RequisitionDto
@{
    ViewData["Title"] = "New Requisition";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">New Requisition</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Requisitions</a></li>
                    <li class="breadcrumb-item active">Create</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <form asp-action="Create" method="post">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Requisition Details</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="RequestDate"></label>
                                <input asp-for="RequestDate" type="date" class="form-control" />
                                <span asp-validation-for="RequestDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="RequiredByDate"></label>
                                <input asp-for="RequiredByDate" type="date" class="form-control" />
                                <span asp-validation-for="RequiredByDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Priority"></label>
                                <select asp-for="Priority" asp-items="ViewBag.Priorities" class="form-control">
                                    <option value="">-- Select Priority --</option>
                                </select>
                                <span asp-validation-for="Priority" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Department">Department <span class="text-danger">*</span></label>
                                <select asp-for="Department" class="form-control" required>
                                    <option value="">-- Select Department --</option>
                                    <option value="Administration">Administration</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Store Management">Store Management</option>
                                    <option value="Procurement">Procurement</option>
                                    <option value="Finance">Finance</option>
                                    <option value="IT">IT</option>
                                    <option value="Logistics">Logistics</option>
                                    <option value="Security">Security</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Other">Other</option>
                                </select>
                                <span asp-validation-for="Department" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="FromStoreId">From Store</label>
                                <select asp-for="FromStoreId" asp-items="ViewBag.FromStores" class="form-control">
                                    <option value="">-- Select Store --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="ToStoreId">To Store</label>
                                <select asp-for="ToStoreId" asp-items="ViewBag.ToStores" class="form-control">
                                    <option value="">-- Select Store --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label asp-for="Purpose"></label>
                                <input asp-for="Purpose" class="form-control" />
                                <span asp-validation-for="Purpose" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>
                                    <input asp-for="AutoConvertToPO" type="checkbox" />
                                    Auto Convert to PO when Approved
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label asp-for="Notes"></label>
                        <textarea asp-for="Notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Requisition Items</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-sm btn-primary" onclick="addItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered" id="itemsTable">
                        <thead>
                            <tr>
                                <th width="25%">Item</th>
                                <th width="10%">Quantity</th>
                                <th width="12%">Unit Price (৳)</th>
                                <th width="12%">Total Price (৳)</th>
                                <th width="30%">Specification</th>
                                <th width="8%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                            <tr>
                                <td>
                                    <select name="itemIds" class="form-control select2 item-select" onchange="loadItemPrice(this)">
                                        <option value="">-- Select Item --</option>
                                        @foreach (var item in ViewBag.Items)
                                        {
                                            <option value="@item.Id" data-price="@item.UnitCost">@item.Name (@item.ItemCode)</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <input type="number" name="quantities" class="form-control quantity-input" min="1" step="1" value="1" onchange="calculateTotal(this)" />
                                </td>
                                <td>
                                    <input type="number" name="unitPrices" class="form-control unit-price" min="0" step="0.01" readonly style="background-color: #e9ecef;" />
                                </td>
                                <td>
                                    <input type="number" name="totalPrices" class="form-control total-price" min="0" step="0.01" readonly style="background-color: #e9ecef;" />
                                </td>
                                <td>
                                    <input type="text" name="specifications" class="form-control" />
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="table-secondary">
                                <td colspan="3" class="text-right"><strong>Total Estimated Value:</strong></td>
                                <td><strong id="grandTotal">৳ 0.00</strong></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Create Requisition
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.select2').select2();

            // Validate From Store and To Store are not the same
            $('#FromStoreId, #ToStoreId').on('change', function() {
                var fromStoreId = $('#FromStoreId').val();
                var toStoreId = $('#ToStoreId').val();

                if (fromStoreId && toStoreId && fromStoreId === toStoreId) {
                    alert('Error: From Store and To Store cannot be the same!');
                    $(this).val('').trigger('change');
                }
            });
        });

        function addItem() {
            var newRow = `
                <tr>
                    <td>
                        <select name="itemIds" class="form-control select2 item-select" onchange="loadItemPrice(this)">
                            <option value="">-- Select Item --</option>
                            @foreach (var item in ViewBag.Items)
                            {
                                    <option value="@item.Id" data-price="@item.UnitCost">@item.Name (@item.ItemCode)</option>
                            }
                        </select>
                    </td>
                    <td>
                        <input type="number" name="quantities" class="form-control quantity-input" min="1" step="1" value="1" onchange="calculateTotal(this)" />
                    </td>
                    <td>
                        <input type="number" name="unitPrices" class="form-control unit-price" min="0" step="0.01" readonly style="background-color: #e9ecef;" />
                    </td>
                    <td>
                        <input type="number" name="totalPrices" class="form-control total-price" min="0" step="0.01" readonly style="background-color: #e9ecef;" />
                    </td>
                    <td>
                        <input type="text" name="specifications" class="form-control" />
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            $('#itemsBody').append(newRow);
            $('.select2').select2();
        }

        // Check for duplicate items when item is selected
        $(document).on('change', '.item-select', function() {
            var selectedItemId = $(this).val();
            if (!selectedItemId) return;

            var currentRow = $(this).closest('tr');
            var duplicateFound = false;

            // Check all other item dropdowns
            $('.item-select').each(function() {
                var thisRow = $(this).closest('tr');
                if (!thisRow.is(currentRow) && $(this).val() === selectedItemId) {
                    duplicateFound = true;
                    return false; // break loop
                }
            });

            if (duplicateFound) {
                alert('This item is already added! Please select a different item or increase the quantity of the existing item.');
                $(this).val('').trigger('change');
                currentRow.find('.unit-price').val('0.00');
                currentRow.find('.total-price').val('0.00');
                calculateGrandTotal();
            }
        });

        function removeItem(btn) {
            if ($('#itemsBody tr').length > 1) {
                $(btn).closest('tr').remove();
                calculateGrandTotal();
            }
        }

        function loadItemPrice(selectElement) {
            var selectedOption = $(selectElement).find('option:selected');
            var unitPrice = parseFloat(selectedOption.data('price')) || 0;
            var row = $(selectElement).closest('tr');

            row.find('.unit-price').val(unitPrice.toFixed(2));

            // Calculate total for this row
            var quantity = parseFloat(row.find('.quantity-input').val()) || 0;
            var total = unitPrice * quantity;
            row.find('.total-price').val(total.toFixed(2));

            calculateGrandTotal();
        }

        function calculateTotal(quantityInput) {
            var row = $(quantityInput).closest('tr');
            var unitPrice = parseFloat(row.find('.unit-price').val()) || 0;
            var quantity = parseFloat($(quantityInput).val()) || 0;
            var total = unitPrice * quantity;

            row.find('.total-price').val(total.toFixed(2));
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            var grandTotal = 0;
            $('.total-price').each(function() {
                grandTotal += parseFloat($(this).val()) || 0;
            });

            // Display grand total if there's a display element
            if ($('#grandTotal').length) {
                $('#grandTotal').text('৳ ' + grandTotal.toFixed(2));
            }
        }
    </script>
}