@model List<LowStockItemViewModel>
@{
    ViewData["Title"] = "Low Stock Requisition";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Create Requisition from Low Stock</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Requisitions</a></li>
                    <li class="breadcrumb-item active">Low Stock</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <form asp-action="CreateFromLowStock" method="post">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Low Stock Items</h3>
                    <div class="card-tools">
                        <select id="storeFilter" class="form-control form-control-sm" style="width: 200px;">
                            <option value="">All Stores</option>
                            @foreach (var store in ViewBag.Stores)
                            {
                                <option value="@store.Value">@store.Text</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Select Target Store for Requisition</label>
                        <select name="toStoreId" asp-items="ViewBag.Stores" class="form-control" required>
                            <option value="">-- Select Store --</option>
                        </select>
                    </div>

                    <table class="table table-bordered table-striped" id="lowStockTable">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" />
                                </th>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Store</th>
                                <th>Current Stock</th>
                                <th>Min Stock</th>
                                <th>Max Stock</th>
                                <th>Request Qty</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Count; i++)
                            {
                                var item = Model[i];
                                <tr data-store="@item.StoreId" class="@(item.CurrentStock == 0 ? "table-danger" : "table-warning")">
                                    <td>
                                        <input type="checkbox" class="item-check" value="@item.ItemId" />
                                        <input type="hidden" name="selectedItems" value="" class="selected-item" disabled />
                                    </td>
                                    <td>@item.ItemCode</td>
                                    <td>@item.ItemName</td>
                                    <td>@item.StoreName</td>
                                    <td>@((item.CurrentStock % 1 == 0) ? item.CurrentStock.ToString("N0") : item.CurrentStock.ToString("N2"))</td>
                                    <td>@((item.MinimumStock % 1 == 0) ? item.MinimumStock.ToString("N0") : item.MinimumStock.ToString("N2"))</td>
                                    <td>@((item.MaximumStock % 1 == 0) ? item.MaximumStock.ToString("N0") : item.MaximumStock.ToString("N2"))</td>
                                    <td>
                                        <input type="number" name="requestQuantities" value="@((item.SuggestedQuantity % 1 == 0) ? item.SuggestedQuantity.ToString("0") : item.SuggestedQuantity.ToString("0.##"))"
                                               class="form-control form-control-sm request-qty" min="1" step="any" disabled />
                                    </td>
                                    <td>
                                        @if (item.CurrentStock == 0)
                                        {
                                            <span class="badge badge-danger">Out of Stock</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-warning">Low Stock</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-invoice"></i> Create Requisition
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            var table = $('#lowStockTable').DataTable({
                "order": [[4, "asc"]],
                "pageLength": 25
            });

            $('#selectAll').change(function() {
                $('.item-check').prop('checked', $(this).is(':checked')).trigger('change');
            });

            $('.item-check').change(function() {
                var row = $(this).closest('tr');
                var hiddenInput = row.find('.selected-item');
                var qtyInput = row.find('.request-qty');
                
                if ($(this).is(':checked')) {
                    hiddenInput.val($(this).val()).prop('disabled', false);
                    qtyInput.prop('disabled', false);
                } else {
                    hiddenInput.val('').prop('disabled', true);
                    qtyInput.prop('disabled', true);
                }
            });

            $('#storeFilter').change(function() {
                var storeId = $(this).val();
                if (storeId) {
                    table.column(3).search($(this).find('option:selected').text()).draw();
                } else {
                    table.column(3).search('').draw();
                }
            });
        });
    </script>
}